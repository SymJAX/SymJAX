

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>jax.numpy.lax_numpy &mdash; symjax 0.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user/examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/installation.html">Installation (GPU)</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/symjax.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">symjax</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/tensor.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">symjax.tensor</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/pdfs.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">symjax.tensor.pdfs</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/signal.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">symjax.tensor.signal</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/random.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">symjax.tensor.random</span></code></a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/datasets.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">symjax.datasets</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/initializers.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">symjax.initializers</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/layers.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">symjax.layers</span></code></a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">symjax</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>jax.numpy.lax_numpy</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for jax.numpy.lax_numpy</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2018 Google LLC</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     https://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Implements the NumPy API, using the primitives in :mod:`jax.lax`.</span>

<span class="sd">NumPy operations are implemented in Python in terms of the primitive operations</span>
<span class="sd">in :mod:`jax.lax`. Since NumPy operations are not primitive and instead are</span>
<span class="sd">implemented in terms of :mod:`jax.lax` operations, we do not need to define</span>
<span class="sd">transformation rules such as gradient or batching rules. Instead,</span>
<span class="sd">transformations for NumPy primitives can be derived from the transformation</span>
<span class="sd">rules for the underlying :code:`lax` primitives.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">from</span> <span class="nn">distutils.util</span> <span class="kn">import</span> <span class="n">strtobool</span>
<span class="kn">import</span> <span class="nn">builtins</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">onp</span>
<span class="kn">import</span> <span class="nn">opt_einsum</span>

<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">jit</span><span class="p">,</span> <span class="n">device_put</span><span class="p">,</span> <span class="n">custom_transforms</span><span class="p">,</span> <span class="n">defjvp</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">core</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">dtypes</span>
<span class="kn">from</span> <span class="nn">..abstract_arrays</span> <span class="kn">import</span> <span class="n">UnshapedArray</span><span class="p">,</span> <span class="n">ShapedArray</span><span class="p">,</span> <span class="n">ConcreteArray</span>
<span class="kn">from</span> <span class="nn">..config</span> <span class="kn">import</span> <span class="n">flags</span>
<span class="kn">from</span> <span class="nn">..interpreters.xla</span> <span class="kn">import</span> <span class="n">DeviceArray</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">lax</span>
<span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">partial</span><span class="p">,</span> <span class="n">get_module_functions</span><span class="p">,</span> <span class="n">unzip2</span><span class="p">,</span> <span class="n">prod</span> <span class="k">as</span> <span class="n">_prod</span><span class="p">,</span> <span class="n">subvals</span>
<span class="kn">from</span> <span class="nn">..lib</span> <span class="kn">import</span> <span class="n">pytree</span>
<span class="kn">from</span> <span class="nn">..lib</span> <span class="kn">import</span> <span class="n">xla_client</span>

<span class="n">FLAGS</span> <span class="o">=</span> <span class="n">flags</span><span class="o">.</span><span class="n">FLAGS</span>
<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_enum</span><span class="p">(</span>
    <span class="s1">&#39;jax_numpy_rank_promotion&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;JAX_NUMPY_RANK_PROMOTION&#39;</span><span class="p">,</span> <span class="s1">&#39;allow&#39;</span><span class="p">),</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;allow&#39;</span><span class="p">,</span> <span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="s1">&#39;raise&#39;</span><span class="p">],</span>
    <span class="n">help</span><span class="o">=</span>
    <span class="s1">&#39;Control NumPy-style automatic rank promotion broadcasting &#39;</span>
    <span class="s1">&#39;(&quot;allow&quot;, &quot;warn&quot;, or &quot;raise&quot;).&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">removechars</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">chars</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">maketrans</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">chars</span><span class="p">)))</span>

<span class="n">newaxis</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># We replace some builtin names to follow Numpy&#39;s API, so we capture here.</span>
<span class="n">_abs</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">abs</span>
<span class="n">_all</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">all</span>
<span class="n">_any</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">any</span>
<span class="n">_max</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">max</span>
<span class="n">_min</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">min</span>
<span class="n">_sum</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">sum</span>
<span class="n">_divmod</span> <span class="o">=</span> <span class="n">builtins</span><span class="o">.</span><span class="n">divmod</span>

<span class="c1"># NumPy constants</span>

<span class="n">pi</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">pi</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">e</span>
<span class="n">euler_gamma</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">euler_gamma</span>
<span class="n">inf</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">inf</span>
<span class="n">NINF</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">NINF</span>
<span class="n">PZERO</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">PZERO</span>
<span class="n">NZERO</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">NZERO</span>
<span class="n">nan</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">nan</span>

<span class="c1"># And some numpy utility functions</span>
<span class="n">set_printoptions</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">set_printoptions</span>

<span class="c1"># We want isinstance(x, np.ndarray) checks in user code to work with the our</span>
<span class="c1"># array-like types, including DeviceArray and UnshapedArray (i.e. the abstract</span>
<span class="c1"># array base class). We can override the isinstance behavior directly, without</span>
<span class="c1"># having the complexity of multiple inheritance on those classes, by defining</span>
<span class="c1"># the ndarray class to have a metaclass with special __instancecheck__ behavior.</span>
<span class="n">_arraylike_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">UnshapedArray</span><span class="p">,</span> <span class="n">DeviceArray</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_ArrayMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
  <span class="sd">&quot;&quot;&quot;Metaclass for overriding ndarray isinstance checks.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__instancecheck__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">aval</span><span class="p">,</span> <span class="n">_arraylike_types</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">_arraylike_types</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ndarray</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">_ArrayMeta</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;jax.numpy.ndarray() should not be instantiated explicitly.&quot;</span>
                    <span class="s2">&quot; Use jax.numpy.array, or jax.numpy.zeros instead.&quot;</span><span class="p">)</span>


<span class="n">iscomplexobj</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">iscomplexobj</span>

<span class="n">shape</span> <span class="o">=</span> <span class="n">_shape</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">shape</span>
<span class="n">ndim</span> <span class="o">=</span> <span class="n">_ndim</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">ndim</span>
<span class="n">size</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">size</span>
<span class="n">_dtype</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">result_type</span>

<span class="c1"># At present JAX doesn&#39;t have a reason to distinguish between scalars and arrays</span>
<span class="c1"># in its object system. Further, we want JAX scalars to have the same type</span>
<span class="c1"># promotion behaviors as JAX arrays. Rather than introducing a new type of JAX</span>
<span class="c1"># scalar object with JAX promotion behaviors, instead we make the JAX scalar</span>
<span class="c1"># types return JAX arrays when instantiated.</span>

<span class="k">class</span> <span class="nc">_ScalarMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">other</span>

  <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_make_scalar_type</span><span class="p">(</span><span class="n">onp_scalar_type</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">_ScalarMeta</span><span class="p">(</span><span class="n">onp_scalar_type</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="p">(</span><span class="nb">object</span><span class="p">,),</span>
                     <span class="p">{</span><span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">onp</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">onp_scalar_type</span><span class="p">)})</span>

<span class="n">bool_</span> <span class="o">=</span> <span class="n">_make_scalar_type</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
<span class="n">uint8</span> <span class="o">=</span> <span class="n">_make_scalar_type</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="n">uint16</span> <span class="o">=</span> <span class="n">_make_scalar_type</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
<span class="n">uint32</span> <span class="o">=</span> <span class="n">_make_scalar_type</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
<span class="n">uint64</span> <span class="o">=</span> <span class="n">_make_scalar_type</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
<span class="n">int8</span> <span class="o">=</span> <span class="n">_make_scalar_type</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
<span class="n">int16</span> <span class="o">=</span> <span class="n">_make_scalar_type</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
<span class="n">int32</span> <span class="o">=</span> <span class="n">_make_scalar_type</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="n">int64</span> <span class="o">=</span> <span class="n">_make_scalar_type</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<span class="n">bfloat16</span> <span class="o">=</span> <span class="n">_make_scalar_type</span><span class="p">(</span><span class="n">dtypes</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">)</span>
<span class="n">float16</span> <span class="o">=</span> <span class="n">_make_scalar_type</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
<span class="n">float32</span> <span class="o">=</span> <span class="n">single</span> <span class="o">=</span> <span class="n">_make_scalar_type</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">float64</span> <span class="o">=</span> <span class="n">double</span> <span class="o">=</span> <span class="n">_make_scalar_type</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">complex64</span> <span class="o">=</span> <span class="n">csingle</span> <span class="o">=</span> <span class="n">_make_scalar_type</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">complex64</span><span class="p">)</span>
<span class="n">complex128</span> <span class="o">=</span> <span class="n">cdouble</span> <span class="o">=</span> <span class="n">_make_scalar_type</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>

<span class="n">int_</span> <span class="o">=</span> <span class="n">int32</span> <span class="k">if</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">int_</span> <span class="o">==</span> <span class="n">onp</span><span class="o">.</span><span class="n">int32</span> <span class="k">else</span> <span class="n">int64</span>
<span class="n">float_</span> <span class="o">=</span> <span class="n">float32</span> <span class="k">if</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">float_</span> <span class="o">==</span> <span class="n">onp</span><span class="o">.</span><span class="n">float32</span> <span class="k">else</span> <span class="n">float64</span>
<span class="n">complex_</span> <span class="o">=</span> <span class="n">complex64</span> <span class="k">if</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">complex_</span> <span class="o">==</span> <span class="n">onp</span><span class="o">.</span><span class="n">complex64</span> <span class="k">else</span> <span class="n">complex128</span>

<span class="n">number</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">number</span>
<span class="n">inexact</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">inexact</span>
<span class="n">complexfloating</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">complexfloating</span>
<span class="n">floating</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">floating</span>
<span class="n">integer</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">integer</span>
<span class="n">signedinteger</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">signedinteger</span>
<span class="n">unsignedinteger</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">unsignedinteger</span>

<span class="n">flexible</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">flexible</span>
<span class="n">character</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">character</span>
<span class="n">object_</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">object_</span>

<span class="n">iinfo</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">iinfo</span>

<span class="n">dtype</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">dtype</span>
<span class="n">can_cast</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">can_cast</span>
<span class="n">issubsctype</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">issubsctype</span>
<span class="n">result_type</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">result_type</span>
<span class="n">promote_types</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">promote_types</span>

<span class="n">ComplexWarning</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">ComplexWarning</span>

<span class="n">array_str</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">array_str</span>
<span class="n">array_repr</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">array_repr</span>

<span class="n">save</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">save</span>
<span class="n">savez</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">savez</span>
<span class="n">load</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">load</span>


<span class="c1">### utility functions</span>

<span class="k">def</span> <span class="nf">_promote_shapes</span><span class="p">(</span><span class="n">fun_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Prepend implicit leading singleton dimensions for Numpy broadcasting.&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">args</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
    <span class="n">nonscalar_ranks</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span> <span class="k">for</span> <span class="n">shp</span> <span class="ow">in</span> <span class="n">shapes</span> <span class="k">if</span> <span class="n">shp</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nonscalar_ranks</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">nonscalar_ranks</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">args</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">jax_numpy_rank_promotion</span> <span class="o">!=</span> <span class="s2">&quot;allow&quot;</span><span class="p">:</span>
        <span class="n">_rank_promotion_warning_or_error</span><span class="p">(</span><span class="n">fun_name</span><span class="p">,</span> <span class="n">shapes</span><span class="p">)</span>
      <span class="n">result_rank</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">broadcast_shapes</span><span class="p">(</span><span class="o">*</span><span class="n">shapes</span><span class="p">))</span>
      <span class="k">return</span> <span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="n">result_rank</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shp</span><span class="p">))</span> <span class="o">+</span> <span class="n">shp</span><span class="p">)</span>
              <span class="k">if</span> <span class="n">shp</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">result_rank</span> <span class="k">else</span> <span class="n">arg</span>
              <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">shp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">shapes</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">_rank_promotion_warning_or_error</span><span class="p">(</span><span class="n">fun_name</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">jax_numpy_rank_promotion</span> <span class="o">==</span> <span class="s2">&quot;warn&quot;</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Following NumPy automatic rank promotion for </span><span class="si">{}</span><span class="s2"> on shapes </span><span class="si">{}</span><span class="s2">. &quot;</span>
           <span class="s2">&quot;Set the jax_numpy_rank_promotion config option to &#39;allow&#39; to &quot;</span>
           <span class="s2">&quot;disable this warning; for more information, see &quot;</span>
           <span class="s2">&quot;https://jax.readthedocs.io/en/latest/rank_promotion_warning.html.&quot;</span><span class="p">)</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fun_name</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">shapes</span><span class="p">))))</span>
  <span class="k">elif</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">jax_numpy_rank_promotion</span> <span class="o">==</span> <span class="s2">&quot;raise&quot;</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Operands could not be broadcast together for </span><span class="si">{}</span><span class="s2"> on shapes </span><span class="si">{}</span><span class="s2"> &quot;</span>
           <span class="s2">&quot;and with the config option jax_numpy_rank_promotion=&#39;raise&#39;. &quot;</span>
           <span class="s2">&quot;For more information, see &quot;</span>
           <span class="s2">&quot;https://jax.readthedocs.io/en/latest/rank_promotion_warning.html.&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fun_name</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">shapes</span><span class="p">))))</span>

<span class="k">def</span> <span class="nf">_promote_dtypes</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Convenience function to apply Numpy argument dtype promotion.&quot;&quot;&quot;</span>
  <span class="c1"># TODO(dougalm,mattjj): This is a performance bottleneck. Consider memoizing.</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">args</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">to_dtype</span> <span class="o">=</span> <span class="n">result_type</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">to_dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_promote_dtypes_inexact</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Convenience function to apply Numpy argument dtype promotion.</span>

<span class="sd">  Promotes arguments to an inexact type.&quot;&quot;&quot;</span>
  <span class="n">to_dtype</span> <span class="o">=</span> <span class="n">_to_inexact_dtype</span><span class="p">(</span><span class="n">result_type</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">to_dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_to_inexact_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Promotes a dtype into an inexact dtype, if it is not already one.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">dtype</span> <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">inexact</span><span class="p">)</span> <span class="k">else</span> <span class="n">promote_types</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">float_</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_complex_elem_type</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns the float type of the real/imaginary parts of a complex dtype.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">onp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((),</span> <span class="n">dtype</span><span class="p">))</span><span class="o">.</span><span class="n">dtype</span>

<span class="k">def</span> <span class="nf">_result_dtype</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Compute result dtype of applying op to arguments with given dtypes.&quot;&quot;&quot;</span>
  <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">onp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="n">ndim</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">op</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_arraylike</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isscalar</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_check_arraylike</span><span class="p">(</span><span class="n">fun_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Check if all args fit JAX&#39;s definition of arraylike (ndarray or scalar).&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">_any</span><span class="p">(</span><span class="ow">not</span> <span class="n">_arraylike</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
    <span class="n">pos</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">_arraylike</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> requires ndarray or scalar arguments, got </span><span class="si">{}</span><span class="s2"> at position </span><span class="si">{}</span><span class="s2">.&quot;</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fun_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span> <span class="n">pos</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_promote_args</span><span class="p">(</span><span class="n">fun_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Convenience function to apply Numpy argument shape and dtype promotion.&quot;&quot;&quot;</span>
  <span class="n">_check_arraylike</span><span class="p">(</span><span class="n">fun_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">_promote_shapes</span><span class="p">(</span><span class="n">fun_name</span><span class="p">,</span> <span class="o">*</span><span class="n">_promote_dtypes</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_promote_args_inexact</span><span class="p">(</span><span class="n">fun_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Convenience function to apply Numpy argument shape and dtype promotion.</span>

<span class="sd">  Promotes non-inexact types to an inexact type.&quot;&quot;&quot;</span>
  <span class="n">_check_arraylike</span><span class="p">(</span><span class="n">fun_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">_promote_shapes</span><span class="p">(</span><span class="n">fun_name</span><span class="p">,</span> <span class="o">*</span><span class="n">_promote_dtypes_inexact</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_constant_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">const</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">const</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_dtype</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">update_numpydoc</span><span class="p">(</span><span class="n">docstr</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;Transforms the numpy docstring to remove references of</span>
<span class="sd">     parameters that are supported by the numpy version but not the JAX version&#39;&#39;&#39;</span>

  <span class="c1">#Some numpy functions have an extra tab at the beginning of each line,</span>
  <span class="c1">#If this function is one of those we remove this extra tab from all the lines</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="s1">&#39;__code__&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">docstr</span>
  <span class="k">if</span> <span class="n">docstr</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;    &#39;</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">docstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
      <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;    &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">docstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

  <span class="n">begin_idx</span> <span class="o">=</span> <span class="n">docstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Parameters&quot;</span><span class="p">)</span>
  <span class="n">begin_idx</span> <span class="o">=</span> <span class="n">docstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;--</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">begin_idx</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
  <span class="n">end_idx</span> <span class="o">=</span> <span class="n">docstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Returns&quot;</span><span class="p">,</span> <span class="n">begin_idx</span><span class="p">)</span>

  <span class="n">parameters</span> <span class="o">=</span> <span class="n">docstr</span><span class="p">[</span><span class="n">begin_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
  <span class="n">param_list</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="p">,</span> <span class="s1">&#39;@@&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_list</span><span class="p">):</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:</span><span class="n">p</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39; : &#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">:</span>
      <span class="n">param_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="n">param_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_list</span> <span class="k">if</span> <span class="n">param</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
  <span class="n">parameters</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;@@&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">docstr</span><span class="p">[:</span><span class="n">begin_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameters</span> <span class="o">+</span> <span class="n">docstr</span><span class="p">[</span><span class="n">end_idx</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:]</span>

<span class="n">_numpy_signature_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^([\w., ]+=)?\s*[\w\.]+\(.*\)$&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_wraps</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lax_description</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Like functools.wraps but works with numpy.ufuncs.</span>
<span class="sd">     It is important that when wrapping numpy functions the parameters names </span>
<span class="sd">     in the original function and in the JAX version are the same</span>
<span class="sd">    Parameters:</span>
<span class="sd">      fun: The function being wrapped</span>
<span class="sd">      update_doc: whether to transform the numpy docstring to remove references of</span>
<span class="sd">      parameters that are supported by the numpy version but not the JAX version. </span>
<span class="sd">      If False, include the numpy docstring verbatim.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">op</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="s1">&#39;__doc__&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fun</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">op</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="c1"># Numpy doc comments have the form:</span>
      <span class="c1"># fn(x, y, z)          (optional)</span>
      <span class="c1">#</span>
      <span class="c1"># A one-line summary</span>
      <span class="c1">#</span>
      <span class="c1"># ... everything else ...</span>
      <span class="c1"># We (a) move the summary to the top, since it is what the Sphinx</span>
      <span class="c1"># autosummary extension expects, and (b) add a comment below the summary</span>
      <span class="c1"># to the effect that this is a LAX wrapper of a Numpy function.</span>
      <span class="n">sections</span> <span class="o">=</span> <span class="n">fun</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

      <span class="n">signatures</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">summary</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">_numpy_signature_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">sections</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
          <span class="n">signatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sections</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">summary</span> <span class="o">=</span> <span class="n">sections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
          <span class="k">break</span>
      <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">signatures</span> <span class="o">+</span> <span class="n">sections</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:])</span>
      <span class="k">if</span> <span class="n">update_doc</span><span class="p">:</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">update_numpydoc</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
      <span class="n">desc</span> <span class="o">=</span> <span class="n">lax_description</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">lax_description</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
      <span class="n">docstr</span> <span class="o">=</span> <span class="p">(</span>
          <span class="s2">&quot;</span><span class="si">{summary}</span><span class="se">\n\n</span><span class="s2">LAX-backend implementation of :func:`</span><span class="si">{fun}</span><span class="s2">`.</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;</span><span class="si">{lax_description}</span><span class="s2">Original docstring below.</span><span class="se">\n\n</span><span class="si">{body}</span><span class="s2">&quot;</span>
          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span> <span class="n">lax_description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
                  <span class="n">fun</span><span class="o">=</span><span class="n">fun</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">))</span>

      <span class="n">op</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">fun</span><span class="o">.</span><span class="vm">__name__</span>
      <span class="n">op</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">docstr</span>
    <span class="k">finally</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">op</span>
  <span class="k">return</span> <span class="n">wrap</span>

<span class="k">def</span> <span class="nf">_canonicalize_axis</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Canonicalize an axis in (-num_dims, num_dims) to [0, num_dims).&quot;&quot;&quot;</span>
  <span class="n">axis</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">axis</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span> <span class="o">+</span> <span class="n">num_dims</span>
  <span class="k">if</span> <span class="n">axis</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">axis</span> <span class="o">&gt;=</span> <span class="n">num_dims</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s2">&quot;axis </span><span class="si">{}</span><span class="s2"> is out of bounds for array of dimension </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">axis</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">axis</span>

<span class="c1">### implementations of numpy functions in terms of lax</span>

<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">finfo</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">finfo</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span> <span class="k">return</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">issubdtype</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">):</span> <span class="k">return</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)</span>

<div class="viewcode-block" id="isscalar"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.isscalar">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">isscalar</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">isscalar</span><span class="p">(</span><span class="n">num</span><span class="p">):</span> <span class="k">return</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">is_python_scalar</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="ow">or</span> <span class="n">onp</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">num</span><span class="p">)</span></div>

<span class="n">iterable</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">iterable</span>

<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">result_type</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">result_type</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">result_type</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_one_to_one_unop</span><span class="p">(</span><span class="n">numpy_fn</span><span class="p">,</span> <span class="n">lax_fn</span><span class="p">,</span> <span class="n">promote_to_inexact</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">promote_to_inexact</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">_to_inexact_dtype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
      <span class="k">return</span> <span class="n">lax_fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">lax_fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">_wraps</span><span class="p">(</span><span class="n">numpy_fn</span><span class="p">)(</span><span class="n">fn</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_one_to_one_binop</span><span class="p">(</span><span class="n">numpy_fn</span><span class="p">,</span> <span class="n">lax_fn</span><span class="p">,</span> <span class="n">promote_to_inexact</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">promote_to_inexact</span><span class="p">:</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="n">lax_fn</span><span class="p">(</span><span class="o">*</span><span class="n">_promote_args_inexact</span><span class="p">(</span><span class="n">numpy_fn</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="n">lax_fn</span><span class="p">(</span><span class="o">*</span><span class="n">_promote_args</span><span class="p">(</span><span class="n">numpy_fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">_wraps</span><span class="p">(</span><span class="n">numpy_fn</span><span class="p">)(</span><span class="n">fn</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_maybe_bool_binop</span><span class="p">(</span><span class="n">numpy_fn</span><span class="p">,</span> <span class="n">lax_fn</span><span class="p">,</span> <span class="n">bool_lax_fn</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_promote_args</span><span class="p">(</span><span class="n">numpy_fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lax_fn</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span> <span class="k">if</span> <span class="n">x1</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">bool_</span> <span class="k">else</span> <span class="n">bool_lax_fn</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">_wraps</span><span class="p">(</span><span class="n">numpy_fn</span><span class="p">)(</span><span class="n">fn</span><span class="p">)</span>

<span class="n">absolute</span> <span class="o">=</span> <span class="nb">abs</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">absolute</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">)</span>
<span class="n">fabs</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">fabs</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">bitwise_not</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">bitwise_not</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_not</span><span class="p">)</span>
<span class="n">negative</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">negative</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">neg</span><span class="p">)</span>
<span class="n">positive</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span>
<span class="n">sign</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">sign</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">sign</span><span class="p">)</span>

<span class="n">floor</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">floor</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">floor</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">ceil</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">ceil</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">ceil</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">exp</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">expm1</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">expm1</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">expm1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">log1p</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">log1p</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">log1p</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">sin</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">sin</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">sin</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">cos</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">cos</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">cos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">tan</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">tan</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">tan</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">arcsin</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">arcsin</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">asin</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">arccos</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">arccos</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">acos</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">arctan</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">arctan</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">atan</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">sinh</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">sinh</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">sinh</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">cosh</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">cosh</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">cosh</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">tanh</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">tanh</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">tanh</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">sqrt</span> <span class="o">=</span> <span class="n">_one_to_one_unop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">sqrt</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>


<span class="n">add</span> <span class="o">=</span> <span class="n">_maybe_bool_binop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">)</span>
<span class="n">bitwise_and</span> <span class="o">=</span> <span class="n">_one_to_one_binop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">)</span>
<span class="n">bitwise_or</span> <span class="o">=</span> <span class="n">_one_to_one_binop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">)</span>
<span class="n">bitwise_xor</span> <span class="o">=</span> <span class="n">_one_to_one_binop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">bitwise_xor</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_xor</span><span class="p">)</span>
<span class="n">right_shift</span> <span class="o">=</span> <span class="n">_one_to_one_binop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">right_shift</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">shift_right_arithmetic</span><span class="p">)</span>
<span class="n">left_shift</span> <span class="o">=</span> <span class="n">_one_to_one_binop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">left_shift</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">shift_left</span><span class="p">)</span>
<span class="n">equal</span> <span class="o">=</span> <span class="n">_one_to_one_binop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">equal</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">eq</span><span class="p">)</span>
<span class="n">multiply</span> <span class="o">=</span> <span class="n">_maybe_bool_binop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">multiply</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">)</span>
<span class="n">not_equal</span> <span class="o">=</span> <span class="n">_one_to_one_binop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">not_equal</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">ne</span><span class="p">)</span>
<span class="n">subtract</span> <span class="o">=</span> <span class="n">_one_to_one_binop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">subtract</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">)</span>
<span class="n">arctan2</span> <span class="o">=</span> <span class="n">_one_to_one_binop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">arctan2</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">atan2</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">minimum</span> <span class="o">=</span> <span class="n">_one_to_one_binop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">minimum</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>
<span class="n">maximum</span> <span class="o">=</span> <span class="n">_one_to_one_binop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">maximum</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
<span class="n">float_power</span> <span class="o">=</span> <span class="n">_one_to_one_binop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">float_power</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">pow</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">nextafter</span> <span class="o">=</span> <span class="n">_one_to_one_binop</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">nextafter</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">nextafter</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_comparison_op</span><span class="p">(</span><span class="n">numpy_fn</span><span class="p">,</span> <span class="n">lax_fn</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span>  <span class="n">_promote_args</span><span class="p">(</span><span class="n">numpy_fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="c1"># Comparison on complex types are defined as a lexicographic ordering on</span>
    <span class="c1"># the (real, imag) pair.</span>
    <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="n">complexfloating</span><span class="p">):</span>
      <span class="n">rx</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
      <span class="n">ry</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">),</span> <span class="n">lax_fn</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">x2</span><span class="p">)),</span>
                        <span class="n">lax_fn</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">lax_fn</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">_wraps</span><span class="p">(</span><span class="n">numpy_fn</span><span class="p">)(</span><span class="n">fn</span><span class="p">)</span>

<span class="n">greater_equal</span> <span class="o">=</span> <span class="n">_comparison_op</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">ge</span><span class="p">)</span>
<span class="n">greater</span> <span class="o">=</span> <span class="n">_comparison_op</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">greater</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">gt</span><span class="p">)</span>
<span class="n">less_equal</span> <span class="o">=</span> <span class="n">_comparison_op</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">less_equal</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">le</span><span class="p">)</span>
<span class="n">less</span> <span class="o">=</span> <span class="n">_comparison_op</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">less</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">lt</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_logical_op</span><span class="p">(</span><span class="n">np_op</span><span class="p">,</span> <span class="n">bitwise_op</span><span class="p">):</span>
  <span class="nd">@_wraps</span><span class="p">(</span><span class="n">np_op</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">op</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">lax</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">bool_</span><span class="p">)</span> <span class="k">else</span> <span class="n">lax</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">zero</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bitwise_op</span><span class="p">(</span><span class="o">*</span><span class="n">_promote_args</span><span class="p">(</span><span class="n">np_op</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">op</span>

<span class="n">logical_and</span> <span class="o">=</span> <span class="n">_logical_op</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">)</span>
<span class="n">logical_not</span> <span class="o">=</span> <span class="n">_logical_op</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_not</span><span class="p">)</span>
<span class="n">logical_or</span> <span class="o">=</span> <span class="n">_logical_op</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">)</span>
<span class="n">logical_xor</span> <span class="o">=</span> <span class="n">_logical_op</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">logical_xor</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_xor</span><span class="p">)</span>


<div class="viewcode-block" id="true_divide"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.true_divide">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">true_divide</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">true_divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
  <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;true_divide&quot;</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span></div>


<div class="viewcode-block" id="divide"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.divide">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">divide</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
  <span class="c1"># decide whether to perform integer division based on Numpy result dtype, as a</span>
  <span class="c1"># way to check whether Python 3 style division is active in Numpy</span>
  <span class="n">result_dtype</span> <span class="o">=</span> <span class="n">_result_dtype</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">divide</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">result_dtype</span><span class="p">,</span> <span class="n">integer</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">floor_divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">true_divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span></div>


<div class="viewcode-block" id="floor_divide"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.floor_divide">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">floor_divide</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">floor_divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
  <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_promote_args</span><span class="p">(</span><span class="s2">&quot;floor_divide&quot;</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">integer</span><span class="p">):</span>
    <span class="n">quotient</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="n">select</span> <span class="o">=</span> <span class="n">logical_and</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">lax</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x2</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">rem</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># TODO(mattjj): investigate why subtracting a scalar was causing promotion</span>
    <span class="k">return</span> <span class="n">where</span><span class="p">(</span><span class="n">select</span><span class="p">,</span> <span class="n">quotient</span> <span class="o">-</span> <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">quotient</span><span class="p">)),</span> <span class="n">quotient</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">complexfloating</span><span class="p">):</span>
    <span class="n">x1r</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">x1i</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">x2r</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">x2i</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">which</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x2r</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x2i</span><span class="p">))</span>
    <span class="n">rat1</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x2i</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">x2r</span><span class="p">,</span> <span class="n">x2i</span><span class="p">))</span>
    <span class="n">rat2</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">x2i</span><span class="p">,</span> <span class="n">x2r</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x2i</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">x1r</span><span class="p">,</span> <span class="n">rat1</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">x1i</span><span class="p">,</span> <span class="n">rat2</span><span class="p">)),</span>
                            <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">x2r</span><span class="p">,</span> <span class="n">rat1</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">x2i</span><span class="p">,</span> <span class="n">rat2</span><span class="p">))))</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">_float_divmod</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="divmod"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.divmod">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">divmod</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">divmod</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
  <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_promote_args</span><span class="p">(</span><span class="s2">&quot;divmod&quot;</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="n">integer</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">floor_divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span> <span class="n">remainder</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">_float_divmod</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_float_divmod</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
  <span class="c1"># see float_divmod in floatobject.c of CPython</span>
  <span class="n">mod</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">rem</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="n">div</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">mod</span><span class="p">),</span> <span class="n">x2</span><span class="p">)</span>

  <span class="n">ind</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">mod</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">lax</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">mod</span><span class="p">))</span>
  <span class="n">mod</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">mod</span> <span class="o">+</span> <span class="n">x2</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>
  <span class="n">div</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">div</span> <span class="o">-</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">div</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">div</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">div</span><span class="p">),</span> <span class="n">mod</span>


<div class="viewcode-block" id="power"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.power">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">power</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">power</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
  <span class="n">x1</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
  <span class="n">x2</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
  <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_promote_args</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">power</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">integer</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>

  <span class="c1"># Integer power =&gt; use binary exponentiation.</span>

  <span class="c1"># TODO(phawkins): add integer pow support to XLA.</span>
  <span class="n">bits</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># Anything more would overflow for any x1 &gt; 1</span>
  <span class="n">acc</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bits</span><span class="p">):</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">x1</span><span class="p">),</span> <span class="n">acc</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">shift_right_logical</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">acc</span></div>


<div class="viewcode-block" id="logaddexp"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.logaddexp">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">logaddexp</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logaddexp</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
  <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_promote_shapes</span><span class="p">(</span><span class="s2">&quot;logaddexp&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">_promote_dtypes_inexact</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
  <span class="n">amax</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="n">delta</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="n">delta</span><span class="p">),</span>
                    <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span>  <span class="c1"># NaNs or infinities of the same sign.</span>
                    <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">amax</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delta</span><span class="p">)))))</span></div>


<div class="viewcode-block" id="logaddexp2"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.logaddexp2">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">logaddexp2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logaddexp2</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
  <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_promote_shapes</span><span class="p">(</span><span class="s2">&quot;logaddexp2&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">_promote_dtypes_inexact</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
  <span class="n">amax</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="n">delta</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="n">delta</span><span class="p">),</span>
                    <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span>  <span class="c1"># NaNs or infinities of the same sign.</span>
                    <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">amax</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">exp2</span><span class="p">(</span><span class="o">-</span><span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delta</span><span class="p">))),</span>
                                          <span class="n">_constant_like</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">onp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))))</span></div>


<div class="viewcode-block" id="log2"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.log2">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">log2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">log2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_dtypes_inexact</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_constant_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span></div>


<div class="viewcode-block" id="log10"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.log10">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">log10</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">log10</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_dtypes_inexact</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_constant_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span></div>


<div class="viewcode-block" id="exp2"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.exp2">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">exp2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">exp2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_dtypes_inexact</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_constant_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">x</span><span class="p">))</span></div>


<div class="viewcode-block" id="signbit"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.signbit">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">signbit</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">signbit</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_shapes</span><span class="p">(</span><span class="s2">&quot;signbit&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">integer</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
  <span class="k">elif</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">bool_</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">bool_</span><span class="p">)</span>
  <span class="k">elif</span> <span class="ow">not</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">floating</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="s2">&quot;jax.numpy.signbit is not well defined for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dtype</span><span class="p">)</span>

  <span class="c1"># TPU supports BF16 but not S16 types, so as a workaround, convert BF16 to</span>
  <span class="c1"># F32.</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">bfloat16</span><span class="p">:</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">float32</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">float32</span><span class="p">)</span>

  <span class="n">info</span> <span class="o">=</span> <span class="n">finfo</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">bits</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
    <span class="n">int_type</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">int16</span>
  <span class="k">elif</span> <span class="n">info</span><span class="o">.</span><span class="n">bits</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>
    <span class="n">int_type</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">int32</span>
  <span class="k">elif</span> <span class="n">info</span><span class="o">.</span><span class="n">bits</span> <span class="o">==</span> <span class="mi">64</span><span class="p">:</span>
    <span class="n">int_type</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">int64</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s2">&quot;jax.numpy.signbit only supports 16, 32, and 64-bit types.&quot;</span><span class="p">)</span>

  <span class="n">x</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">bitcast_convert_type</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">int_type</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">nexp</span> <span class="o">+</span> <span class="n">info</span><span class="o">.</span><span class="n">nmant</span><span class="p">),</span> <span class="n">onp</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span></div>


<div class="viewcode-block" id="remainder"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.remainder">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">remainder</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">remainder</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
  <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_promote_args</span><span class="p">(</span><span class="s2">&quot;remainder&quot;</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="n">zero</span> <span class="o">=</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="n">trunc_mod</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">rem</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="n">trunc_mod_not_zero</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="n">trunc_mod</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
  <span class="n">do_plus</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span>
      <span class="n">lax</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">trunc_mod</span><span class="p">,</span> <span class="n">zero</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">zero</span><span class="p">)),</span> <span class="n">trunc_mod_not_zero</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">do_plus</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">trunc_mod</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span> <span class="n">trunc_mod</span><span class="p">)</span></div>
<span class="n">mod</span> <span class="o">=</span> <span class="n">remainder</span>
<span class="n">fmod</span> <span class="o">=</span> <span class="n">_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">fmod</span><span class="p">)(</span><span class="k">lambda</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="n">lax</span><span class="o">.</span><span class="n">rem</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">cbrt</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cbrt</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_dtypes_inexact</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">power</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">))</span>


<div class="viewcode-block" id="square"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.square">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">square</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">square</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="deg2rad"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.deg2rad">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">deg2rad</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_dtypes_inexact</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span><span class="p">))</span></div>


<div class="viewcode-block" id="rad2deg"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.rad2deg">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">rad2deg</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_dtypes_inexact</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">pi</span><span class="p">))</span></div>


<span class="n">degrees</span> <span class="o">=</span> <span class="n">rad2deg</span>
<span class="n">radians</span> <span class="o">=</span> <span class="n">deg2rad</span>


<div class="viewcode-block" id="heaviside"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.heaviside">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">heaviside</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">heaviside</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
  <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_promote_dtypes_inexact</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="n">zero</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">where</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">zero</span><span class="p">),</span> <span class="n">zero</span><span class="p">,</span>
               <span class="n">where</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">zero</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">x2</span><span class="p">))</span></div>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">hypot</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hypot</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
  <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_promote_dtypes_inexact</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x1</span><span class="o">*</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span><span class="o">*</span><span class="n">x2</span><span class="p">)</span>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">reciprocal</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_dtypes_inexact</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span>


<div class="viewcode-block" id="sinc"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.sinc">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">sinc</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sinc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_dtypes_inexact</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">eq_zero</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
  <span class="n">safe_x</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">eq_zero</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">pi_x</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pi</span><span class="p">),</span> <span class="n">safe_x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">where</span><span class="p">(</span><span class="n">eq_zero</span><span class="p">,</span>
               <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pi_x</span><span class="p">),</span> <span class="n">pi_x</span><span class="p">))</span></div>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">arcsinh</span><span class="p">)</span>
<span class="nd">@custom_transforms</span>
<span class="nd">@jit</span>
<span class="nd">@lax</span><span class="o">.</span><span class="n">_upcast_fp16_for_computation</span>
<span class="k">def</span> <span class="nf">arcsinh</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="c1"># asinh(x) = log(x + sqrt(x**2 + 1))</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_dtypes_inexact</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">one</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">lax</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">one</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">complexfloating</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">result</span>
  <span class="n">a</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">sqrt_max_value</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">finfo</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
  <span class="n">log2</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">onp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">sqrt_max_value</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">log2</span><span class="p">))</span>

<span class="n">defjvp</span><span class="p">(</span><span class="n">arcsinh</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">g</span><span class="p">,</span> <span class="n">ans</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">g</span> <span class="o">/</span> <span class="n">lax</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>


<div class="viewcode-block" id="arccosh"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.arccosh">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">arccosh</span><span class="p">)</span>
<span class="nd">@jit</span>
<span class="nd">@lax</span><span class="o">.</span><span class="n">_upcast_fp16_for_computation</span>
<span class="k">def</span> <span class="nf">arccosh</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="c1"># acosh(x) = log(x + sqrt((x + 1) * (x - 1))) if x &lt; sqrt_max_value</span>
  <span class="c1">#            log(x) + log(2) otherwise</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_dtypes_inexact</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">one</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">lax</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="n">one</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">one</span><span class="p">)))</span>
  <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">complexfloating</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">result</span>
  <span class="n">sqrt_max_value</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">finfo</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
  <span class="n">log2</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">onp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">sqrt_max_value</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">log2</span><span class="p">)</span></div>


<div class="viewcode-block" id="arctanh"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.arctanh">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">arctanh</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">arctanh</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="c1"># atanh(x) = 0.5 * log((1 + x) / (1 - x))</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_dtypes_inexact</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">one</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">one</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">one</span> <span class="o">-</span> <span class="n">x</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">complexfloating</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">result</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">onp</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span></div>


<div class="viewcode-block" id="transpose"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.transpose">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">transpose</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">transpose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">axes</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">axes</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span></div>


<div class="viewcode-block" id="rot90"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.rot90">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">rot90</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">rot90</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
  <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span>
  <span class="n">ax1</span> <span class="o">=</span> <span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
  <span class="n">ax2</span> <span class="o">=</span> <span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">ax1</span> <span class="o">==</span> <span class="n">ax2</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Axes must be different&quot;</span><span class="p">)</span>  <span class="c1"># same as numpy error</span>
  <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">%</span> <span class="mi">4</span>
  <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">m</span>
  <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">flip</span><span class="p">(</span><span class="n">flip</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">ax1</span><span class="p">),</span> <span class="n">ax2</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">perm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">ndim</span><span class="p">))</span>
    <span class="n">perm</span><span class="p">[</span><span class="n">ax1</span><span class="p">],</span> <span class="n">perm</span><span class="p">[</span><span class="n">ax2</span><span class="p">]</span> <span class="o">=</span> <span class="n">perm</span><span class="p">[</span><span class="n">ax2</span><span class="p">],</span> <span class="n">perm</span><span class="p">[</span><span class="n">ax1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">transpose</span><span class="p">(</span><span class="n">flip</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">ax2</span><span class="p">),</span> <span class="n">perm</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">flip</span><span class="p">(</span><span class="n">transpose</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">perm</span><span class="p">),</span> <span class="n">ax2</span><span class="p">)</span></div>


<div class="viewcode-block" id="flip"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.flip">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">flip</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">flip</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">rev</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">))))</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">rev</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">[</span><span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">))])</span></div>


<div class="viewcode-block" id="fliplr"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.fliplr">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">fliplr</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">fliplr</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">flip</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="flipud"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.flipud">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">flipud</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">flipud</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">flip</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="conjugate"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.conjugate">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">conjugate</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">conjugate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">iscomplexobj</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span></div>
<span class="n">conj</span> <span class="o">=</span> <span class="n">conjugate</span>


<div class="viewcode-block" id="imag"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.imag">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">imag</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="n">iscomplexobj</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">else</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">val</span><span class="p">)</span></div>


<div class="viewcode-block" id="real"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.real">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">real</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="n">iscomplexobj</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">else</span> <span class="n">val</span></div>


<div class="viewcode-block" id="iscomplex"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.iscomplex">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">iscomplex</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">i</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span></div>

<div class="viewcode-block" id="isreal"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.isreal">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">isreal</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">isreal</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">i</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span></div>

<div class="viewcode-block" id="angle"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.angle">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">angle</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">angle</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
  <span class="n">re</span> <span class="o">=</span> <span class="n">real</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
  <span class="n">im</span> <span class="o">=</span> <span class="n">imag</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">re</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">inexact</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
      <span class="n">issubdtype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">floating</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ndim</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">float_</span><span class="p">)</span>
    <span class="n">re</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">re</span><span class="p">)</span></div>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">diff</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">diff</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,):</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span>
  <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span>
  <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
      <span class="s2">&quot;order must be non-negative but got &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

  <span class="n">nd</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span>

  <span class="n">slice1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="n">nd</span>
  <span class="n">slice2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="n">nd</span>
  <span class="n">slice1</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
  <span class="n">slice2</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">slice1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">slice1</span><span class="p">)</span>
  <span class="n">slice2</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">slice2</span><span class="p">)</span>

  <span class="n">op</span> <span class="o">=</span> <span class="n">not_equal</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">onp</span><span class="o">.</span><span class="n">bool_</span> <span class="k">else</span> <span class="n">subtract</span>
  <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">slice1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="n">slice2</span><span class="p">])</span>

  <span class="k">return</span> <span class="n">a</span>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">isrealobj</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">isrealobj</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="ow">not</span> <span class="n">iscomplexobj</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<div class="viewcode-block" id="reshape"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.reshape">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">reshape</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">reshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">newshape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">newshape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>  <span class="c1"># forward to method for ndarrays</span>
  <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">_reshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">newshape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_compute_newshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">newshape</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Fixes a -1 value in newshape, if present.&quot;&quot;&quot;</span>
  <span class="c1"># other errors, like having more than one -1, are caught downstream</span>
  <span class="n">newsize</span> <span class="o">=</span> <span class="n">_prod</span><span class="p">(</span><span class="n">newshape</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">newsize</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">fix</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="o">-</span><span class="n">newsize</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">d</span> <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">fix</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">newshape</span><span class="p">]</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">newshape</span>

<span class="k">def</span> <span class="nf">_reshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">newshape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">):</span>
  <span class="n">computed_newshape</span> <span class="o">=</span> <span class="n">_compute_newshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">newshape</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">computed_newshape</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">:</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">computed_newshape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dims</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
  <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;np.reshape order=A is not implemented.&quot;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected value for &#39;order&#39; argument: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">order</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_reshape_method</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">newshape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="n">order</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">invalid_kwarg</span><span class="p">,</span> <span class="o">=</span> <span class="n">kwargs</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; is an invalid keyword argument for this function&quot;</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">invalid_kwarg</span><span class="p">))</span>  <span class="c1"># same as NumPy error</span>
  <span class="k">elif</span> <span class="n">kwargs</span><span class="p">:</span>
    <span class="n">invalid_kwargs</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> are invalid keyword arguments for this function&quot;</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">invalid_kwargs</span><span class="p">))</span>  <span class="c1"># different from NumPy error</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newshape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">newshape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">newshape</span> <span class="o">=</span> <span class="n">newshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">_reshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">newshape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>


<div class="viewcode-block" id="ravel"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.ravel">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">ravel</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ravel</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s2">&quot;K&quot;</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Ravel not implemented for order=&#39;K&#39;.&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">reshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">a</span><span class="p">),),</span> <span class="n">order</span><span class="p">)</span></div>


<div class="viewcode-block" id="squeeze"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.squeeze">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">squeeze</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">squeeze</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span>
  <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">newshape</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
      <span class="n">axis</span> <span class="o">=</span> <span class="p">(</span><span class="n">axis</span><span class="p">,)</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">axis</span><span class="p">)</span>
    <span class="n">newshape</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">axis</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">newshape</span><span class="p">)</span></div>


<div class="viewcode-block" id="expand_dims"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.expand_dims">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">expand_dims</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
  <span class="n">shape</span> <span class="o">=</span> <span class="n">_shape</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="n">axis</span> <span class="o">=</span> <span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">shape</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">:])</span></div>


<div class="viewcode-block" id="swapaxes"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.swapaxes">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">swapaxes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis1</span><span class="p">,</span> <span class="n">axis2</span><span class="p">):</span>
  <span class="n">perm</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
  <span class="n">perm</span><span class="p">[</span><span class="n">axis1</span><span class="p">],</span> <span class="n">perm</span><span class="p">[</span><span class="n">axis2</span><span class="p">]</span> <span class="o">=</span> <span class="n">perm</span><span class="p">[</span><span class="n">axis2</span><span class="p">],</span> <span class="n">perm</span><span class="p">[</span><span class="n">axis1</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">perm</span><span class="p">)</span></div>


<div class="viewcode-block" id="moveaxis"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.moveaxis">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">moveaxis</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="n">source</span><span class="p">,)</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">destination</span> <span class="o">=</span> <span class="p">(</span><span class="n">destination</span><span class="p">,)</span>
  <span class="n">source</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">source</span><span class="p">)</span>
  <span class="n">destination</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">destination</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">destination</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inconsistent number of elements: </span><span class="si">{}</span><span class="s2"> vs </span><span class="si">{}</span><span class="s2">&quot;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">destination</span><span class="p">)))</span>
  <span class="n">perm</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">dest</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">source</span><span class="p">)):</span>
    <span class="n">perm</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">perm</span><span class="p">)</span></div>


<div class="viewcode-block" id="isclose"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.isclose">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">isclose</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">isclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-05</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-08</span><span class="p">):</span>
  <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">_promote_args</span><span class="p">(</span><span class="s2">&quot;isclose&quot;</span><span class="p">,</span> <span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">asarray</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">inexact</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">complexfloating</span><span class="p">):</span>
      <span class="n">dtype</span> <span class="o">=</span> <span class="n">_complex_elem_type</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">rtol</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">rtol</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">atol</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">atol</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">le</span><span class="p">(</span>
      <span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)),</span>
      <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atol</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">rtol</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b</span><span class="p">))))</span>
    <span class="k">return</span> <span class="n">_maybe_numpy_1_13_isclose_behavior</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span></div>

<span class="n">numpy_version</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">onp</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]))</span>
<span class="k">if</span> <span class="n">numpy_version</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">14</span><span class="p">):</span>
  <span class="c1"># see discussion at https://github.com/numpy/numpy/pull/9720</span>
  <span class="k">def</span> <span class="nf">_maybe_numpy_1_13_isclose_behavior</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">complexfloating</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">out</span>
<span class="k">else</span><span class="p">:</span>
  <span class="k">def</span> <span class="nf">_maybe_numpy_1_13_isclose_behavior</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="c1"># The `jit` on `where` exists to avoid materializing constants in cases like</span>
<span class="c1"># `np.where(np.zeros(1000), 7, 4)`. In op-by-op mode, we don&#39;t want to</span>
<span class="c1"># materialize the broadcast forms of scalar arguments.</span>
<span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">_where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either both or neither of the x and y arguments should &quot;</span>
                     <span class="s2">&quot;be provided to jax.numpy.where, got </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">.&quot;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">condition</span><span class="p">),</span> <span class="n">bool_</span><span class="p">):</span>
    <span class="n">condition</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">condition</span><span class="p">))</span>
  <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">_promote_dtypes</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
  <span class="n">condition</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">broadcast_arrays</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">if</span> <span class="n">onp</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>


<span class="n">_WHERE_DOC</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">At present, JAX does not support JIT-compilation of the single-argument form</span>
<span class="s2">of :py:func:`jax.numpy.where` because its output shape is data-dependent. The</span>
<span class="s2">three-argument form does not have a data-dependent shape and can be JIT-compiled</span>
<span class="s2">successfully.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">where</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lax_description</span><span class="o">=</span><span class="n">_WHERE_DOC</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">nonzero</span><span class="p">(</span><span class="n">asarray</span><span class="p">(</span><span class="n">condition</span><span class="p">))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">_where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">select</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="n">condlist</span><span class="p">,</span> <span class="n">choicelist</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">condlist</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">choicelist</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;condlist must have length equal to choicelist (</span><span class="si">{}</span><span class="s2"> vs </span><span class="si">{}</span><span class="s2">)&quot;</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">condlist</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">choicelist</span><span class="p">)))</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">condlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;condlist must be non-empty&quot;</span><span class="p">)</span>
  <span class="n">choices</span> <span class="o">=</span> <span class="n">_promote_dtypes</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="o">*</span><span class="n">choicelist</span><span class="p">)</span>
  <span class="n">choicelist</span> <span class="o">=</span> <span class="n">choices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
  <span class="n">output</span> <span class="o">=</span> <span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">cond</span><span class="p">,</span> <span class="n">choice</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">condlist</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">choicelist</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">choice</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">output</span>


<span class="k">def</span> <span class="nf">broadcast_arrays</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Like Numpy&#39;s broadcast_arrays but doesn&#39;t return views.&quot;&quot;&quot;</span>
  <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">shapes</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">arg</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isscalar</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">else</span> <span class="n">array</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
  <span class="n">result_shape</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">broadcast_shapes</span><span class="p">(</span><span class="o">*</span><span class="n">shapes</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">result_shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">broadcast_to</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Like Numpy&#39;s broadcast_to but doesn&#39;t necessarily return views.&quot;&quot;&quot;</span>
  <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
  <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">shape</span><span class="p">))</span>  <span class="c1"># check that shape is concrete</span>
  <span class="n">arr_shape</span> <span class="o">=</span> <span class="n">_shape</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">arr_shape</span> <span class="o">==</span> <span class="n">shape</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">arr</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">nlead</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr_shape</span><span class="p">)</span>
    <span class="n">compatible</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">arr_shape</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="n">nlead</span><span class="p">:])</span> <span class="o">|</span> <span class="n">onp</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">arr_shape</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nlead</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">onp</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">compatible</span><span class="p">):</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Incompatible shapes for broadcasting: </span><span class="si">{}</span><span class="s2"> and requested shape </span><span class="si">{}</span><span class="s2">&quot;</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arr_shape</span><span class="p">,</span> <span class="n">shape</span><span class="p">))</span>
    <span class="n">diff</span><span class="p">,</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">not_equal</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="n">nlead</span><span class="p">:],</span> <span class="n">arr_shape</span><span class="p">))</span>
    <span class="n">new_dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nlead</span><span class="p">))</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">nlead</span> <span class="o">+</span> <span class="n">diff</span><span class="p">)</span>
    <span class="n">kept_dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)),</span> <span class="n">new_dims</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">broadcast_in_dim</span><span class="p">(</span><span class="n">squeeze</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">diff</span><span class="p">),</span> <span class="n">shape</span><span class="p">,</span> <span class="n">kept_dims</span><span class="p">)</span>


<div class="viewcode-block" id="split"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.split">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">split</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="n">ary</span><span class="p">,</span> <span class="n">indices_or_sections</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="n">dummy_val</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ary</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># zero strides</span>
  <span class="n">subarrays</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dummy_val</span><span class="p">,</span> <span class="n">indices_or_sections</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>  <span class="c1"># shapes</span>
  <span class="n">split_indices</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">onp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">sub</span><span class="p">)[</span><span class="n">axis</span><span class="p">]</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subarrays</span><span class="p">])</span>
  <span class="n">starts</span><span class="p">,</span> <span class="n">ends</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ndim</span><span class="p">(</span><span class="n">ary</span><span class="p">),</span> <span class="n">shape</span><span class="p">(</span><span class="n">ary</span><span class="p">)</span>
  <span class="n">_subval</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">subvals</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)])</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">ary</span><span class="p">,</span> <span class="n">_subval</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">start</span><span class="p">),</span> <span class="n">_subval</span><span class="p">(</span><span class="n">ends</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
          <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">split_indices</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">split_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span></div>

<span class="k">def</span> <span class="nf">_split_on_axis</span><span class="p">(</span><span class="n">onp_fun</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
  <span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp_fun</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">ary</span><span class="p">,</span> <span class="n">indices_or_sections</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">split</span><span class="p">(</span><span class="n">ary</span><span class="p">,</span> <span class="n">indices_or_sections</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">f</span>

<span class="n">vsplit</span> <span class="o">=</span> <span class="n">_split_on_axis</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">vsplit</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">hsplit</span> <span class="o">=</span> <span class="n">_split_on_axis</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">hsplit</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dsplit</span> <span class="o">=</span> <span class="n">_split_on_axis</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">dsplit</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


<div class="viewcode-block" id="clip"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.clip">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">clip</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">clip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">a_min</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">a_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="s2">&quot;At most one of a_min and a_max may be None&quot;</span>
  <span class="k">if</span> <span class="n">a_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">a_min</span><span class="p">)</span> <span class="o">!=</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
      <span class="n">a_min</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">a_min</span><span class="p">,</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">maximum</span><span class="p">(</span><span class="n">a_min</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">a_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">a_max</span><span class="p">)</span> <span class="o">!=</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
      <span class="n">a_max</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">a_max</span><span class="p">,</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">minimum</span><span class="p">(</span><span class="n">a_max</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">a</span></div>


<span class="k">def</span> <span class="nf">_dtype_info</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Helper function for to get dtype info needed for clipping.&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">integer</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">iinfo</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">finfo</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_round_to_nearest_even</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">half</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
  <span class="n">one</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">round_val</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">fraction</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">round_val</span>
  <span class="n">nearest_even_int</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
    <span class="n">round_val</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">half</span><span class="p">,</span> <span class="n">x</span><span class="p">))))</span>
  <span class="n">is_odd</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">nearest_even_int</span><span class="p">,</span> <span class="n">one</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">fraction</span><span class="p">,</span> <span class="n">half</span><span class="p">),</span>
                   <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">fraction</span><span class="p">,</span> <span class="n">half</span><span class="p">),</span> <span class="n">is_odd</span><span class="p">)),</span>
    <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">round_val</span><span class="p">,</span> <span class="n">one</span><span class="p">),</span> <span class="n">round_val</span><span class="p">)</span>

<div class="viewcode-block" id="round"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.round">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">round</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">round</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">integer</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">decimals</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s2">&quot;integer np.round not implemented for decimals &lt; 0&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span>  <span class="c1"># no-op on integer types</span>

  <span class="k">def</span> <span class="nf">_round_float</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">decimals</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">_round_to_nearest_even</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># TODO(phawkins): the strategy of rescaling the value isn&#39;t necessarily a</span>
    <span class="c1"># good one since we may be left with an incorrectly rounded value at the</span>
    <span class="c1"># end due to precision problems. As a workaround for float16, convert to</span>
    <span class="c1"># float32,</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">onp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">onp</span><span class="o">.</span><span class="n">float16</span> <span class="k">else</span> <span class="n">x</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">decimals</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">_round_to_nearest_even</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">factor</span><span class="p">)),</span> <span class="n">factor</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">onp</span><span class="o">.</span><span class="n">float16</span> <span class="k">else</span> <span class="n">out</span>

  <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">complexfloating</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">complex</span><span class="p">(</span><span class="n">_round_float</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">a</span><span class="p">)),</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">_round_float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span></div>
<span class="n">around</span> <span class="o">=</span> <span class="nb">round</span>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">fix</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">fix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;fix does not support the `out` argument.&quot;</span><span class="p">)</span>
  <span class="n">zero</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">where</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">zero</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<div class="viewcode-block" id="isfinite"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.isfinite">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">isfinite</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">floating</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">is_finite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">complexfloating</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">is_finite</span><span class="p">(</span><span class="n">real</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">lax</span><span class="o">.</span><span class="n">is_finite</span><span class="p">(</span><span class="n">imag</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">bool_</span><span class="p">)</span></div>

<div class="viewcode-block" id="isinf"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.isinf">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">isinf</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">isinf</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">floating</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">inf</span><span class="p">))</span>
  <span class="k">elif</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">complexfloating</span><span class="p">):</span>
    <span class="n">re</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">re</span><span class="p">),</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">re</span><span class="p">,</span> <span class="n">inf</span><span class="p">)),</span>
                          <span class="n">lax</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">inf</span><span class="p">)))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">bool_</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_isposneginf</span><span class="p">(</span><span class="n">infinity</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">floating</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">infinity</span><span class="p">))</span>
  <span class="k">elif</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">complexfloating</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;isposinf/isneginf are not well defined for complex types&quot;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">bool_</span><span class="p">)</span>

<span class="n">isposinf</span> <span class="o">=</span> <span class="n">_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">isposinf</span><span class="p">)(</span><span class="n">partial</span><span class="p">(</span><span class="n">_isposneginf</span><span class="p">,</span> <span class="n">inf</span><span class="p">))</span>
<span class="n">isneginf</span> <span class="o">=</span> <span class="n">_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">isneginf</span><span class="p">)(</span><span class="n">partial</span><span class="p">(</span><span class="n">_isposneginf</span><span class="p">,</span> <span class="o">-</span><span class="n">inf</span><span class="p">))</span>

<div class="viewcode-block" id="isnan"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.isnan">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">isnan</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">bitwise_not</span><span class="p">(</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
                         <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_not</span><span class="p">(</span><span class="n">isinf</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span></div>

<div class="viewcode-block" id="nan_to_num"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.nan_to_num">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">nan_to_num</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
  <span class="k">del</span> <span class="n">copy</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">complexfloating</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">complex</span><span class="p">(</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">nan_to_num</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
  <span class="n">info</span> <span class="o">=</span> <span class="n">finfo</span><span class="p">(</span><span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">isposinf</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">max</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">isneginf</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">min</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span></div>

<span class="c1">### Reducers</span>


<span class="k">def</span> <span class="nf">_make_reduction</span><span class="p">(</span><span class="n">np_fun</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">init_val</span><span class="p">,</span> <span class="n">preproc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bool_op</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">upcast_f16_for_computation</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Creates reduction function given a binary operation and monoid identity.&quot;&quot;&quot;</span>

  <span class="n">bool_op</span> <span class="o">=</span> <span class="n">bool_op</span> <span class="ow">or</span> <span class="n">op</span>

  <span class="nd">@_wraps</span><span class="p">(</span><span class="n">np_fun</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">reduction</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;reduction does not support the `out` argument.&quot;</span><span class="p">)</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">preproc</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">if</span> <span class="n">preproc</span> <span class="k">else</span> <span class="n">a</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="n">_reduction_dims</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
    <span class="n">result_dtype</span> <span class="o">=</span> <span class="n">dtype</span> <span class="ow">or</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">np_fun</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">ones</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">))))</span>
    <span class="k">if</span> <span class="n">upcast_f16_for_computation</span> <span class="ow">and</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">result_dtype</span><span class="p">,</span> <span class="n">inexact</span><span class="p">):</span>
      <span class="n">computation_dtype</span> <span class="o">=</span> <span class="n">promote_types</span><span class="p">(</span><span class="n">result_dtype</span><span class="p">,</span> <span class="n">float32</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">computation_dtype</span> <span class="o">=</span> <span class="n">result_dtype</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">computation_dtype</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">_reduction_init_val</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">init_val</span><span class="p">),</span>
                        <span class="n">op</span> <span class="k">if</span> <span class="n">computation_dtype</span> <span class="o">!=</span> <span class="n">onp</span><span class="o">.</span><span class="n">bool_</span> <span class="k">else</span> <span class="n">bool_op</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">keepdims</span><span class="p">:</span>
      <span class="n">shape_with_singletons</span> <span class="o">=</span> <span class="n">subvals</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)))</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">shape_with_singletons</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">or</span> <span class="n">result_dtype</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">reduction</span>

<span class="k">def</span> <span class="nf">_reduction_dims</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">onp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">axis</span><span class="p">)</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">)),)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unexpected type of axis argument: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">axis</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">_reduction_init_val</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">init_val</span><span class="p">):</span>
  <span class="n">a_dtype</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">a_dtype</span> <span class="o">==</span> <span class="s1">&#39;bool&#39;</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">init_val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">a_dtype</span><span class="p">)</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">init_val</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">a_dtype</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">OverflowError</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">a_dtype</span><span class="p">,</span> <span class="n">integer</span><span class="p">)</span>
    <span class="n">sign</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">init_val</span><span class="p">),</span> <span class="n">iinfo</span><span class="p">(</span><span class="n">a_dtype</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">min</span> <span class="k">if</span> <span class="n">sign</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">info</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">a_dtype</span><span class="p">)</span>

<span class="n">_cast_to_bool</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">,</span> <span class="n">new_dtype</span><span class="o">=</span><span class="n">bool_</span><span class="p">)</span>

<span class="nb">sum</span> <span class="o">=</span> <span class="n">_make_reduction</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">upcast_f16_for_computation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">bool_op</span><span class="o">=</span><span class="n">lax</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">)</span>
<span class="n">product</span> <span class="o">=</span> <span class="n">prod</span> <span class="o">=</span> <span class="n">_make_reduction</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">prod</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bool_op</span><span class="o">=</span><span class="n">lax</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">,</span>
                                 <span class="n">upcast_f16_for_computation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">amax</span> <span class="o">=</span> <span class="nb">max</span> <span class="o">=</span> <span class="n">_make_reduction</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="o">-</span><span class="n">onp</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
<span class="n">amin</span> <span class="o">=</span> <span class="nb">min</span> <span class="o">=</span> <span class="n">_make_reduction</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">onp</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
<span class="nb">all</span> <span class="o">=</span> <span class="n">alltrue</span> <span class="o">=</span> <span class="n">_make_reduction</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">all</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">_cast_to_bool</span><span class="p">)</span>
<span class="nb">any</span> <span class="o">=</span> <span class="n">sometrue</span> <span class="o">=</span> <span class="n">_make_reduction</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">any</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">_cast_to_bool</span><span class="p">)</span>


<div class="viewcode-block" id="mean"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.mean">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mean does not support the `out` argument.&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">normalizer</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">normalizer</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">axis</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">bool_</span><span class="p">)</span> <span class="ow">or</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">integer</span><span class="p">):</span>
      <span class="n">dtype</span> <span class="o">=</span> <span class="n">float_</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">dtype</span> <span class="o">=</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
      <span class="nb">sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="n">keepdims</span><span class="p">),</span>
      <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">normalizer</span><span class="p">,</span> <span class="n">dtype</span><span class="p">))</span></div>

<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">average</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">average</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">returned</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Treat all weights as 1</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">weights_sum</span> <span class="o">=</span> <span class="n">full</span><span class="p">((),</span> <span class="n">size</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">avg</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">weights_sum</span> <span class="o">=</span> <span class="n">full_like</span><span class="p">(</span><span class="n">avg</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">avg</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">inexact</span><span class="p">):</span>
      <span class="n">out_dtype</span> <span class="o">=</span> <span class="n">result_type</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">weights</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">out_dtype</span> <span class="o">=</span> <span class="n">result_type</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">weights</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">float_</span><span class="p">)</span>
    <span class="n">out_dtype</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">out_dtype</span><span class="p">)</span>

    <span class="n">a_shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">a_ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_shape</span><span class="p">)</span>
    <span class="n">weights_shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">a_ndim</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">a_shape</span> <span class="o">!=</span> <span class="n">weights_shape</span><span class="p">:</span>
      <span class="c1"># Make sure the dimensions work out</span>
      <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Axis must be specified when shapes of a and &quot;</span>
                         <span class="s2">&quot;weights differ.&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights_shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;1D weights expected when shapes of a and &quot;</span>
                         <span class="s2">&quot;weights differ.&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">weights_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">a_shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Length of weights not &quot;</span>
                         <span class="s2">&quot;compatible with specified axis.&quot;</span><span class="p">)</span>

      <span class="n">weights</span> <span class="o">=</span> <span class="n">broadcast_to</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="p">(</span><span class="n">a_ndim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">weights_shape</span><span class="p">)</span>
      <span class="n">weights</span> <span class="o">=</span> <span class="n">moveaxis</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>

    <span class="n">weights_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">out_dtype</span><span class="p">)</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">multiply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">weights</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">out_dtype</span><span class="p">)</span> <span class="o">/</span> <span class="n">weights_sum</span>

  <span class="k">if</span> <span class="n">returned</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">avg</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">weights_sum</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
      <span class="n">weights_sum</span> <span class="o">=</span> <span class="n">broadcast_to</span><span class="p">(</span><span class="n">weights_sum</span><span class="p">,</span> <span class="n">avg</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">avg</span><span class="p">,</span> <span class="n">weights_sum</span>
  <span class="k">return</span> <span class="n">avg</span>


<div class="viewcode-block" id="var"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.var">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">var</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;var does not support the `out` argument.&quot;</span><span class="p">)</span>

  <span class="n">a_dtype</span> <span class="o">=</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">dtype</span><span class="p">:</span>
    <span class="n">a_dtype</span> <span class="o">=</span> <span class="n">promote_types</span><span class="p">(</span><span class="n">a_dtype</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">a_dtype</span><span class="p">,</span> <span class="n">inexact</span><span class="p">):</span>
      <span class="n">dtype</span> <span class="o">=</span> <span class="n">a_dtype</span> <span class="o">=</span> <span class="n">float_</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">dtype</span> <span class="o">=</span> <span class="n">_complex_elem_type</span><span class="p">(</span><span class="n">a_dtype</span><span class="p">)</span>
      <span class="n">a_dtype</span> <span class="o">=</span> <span class="n">promote_types</span><span class="p">(</span><span class="n">a_dtype</span><span class="p">,</span> <span class="n">float32</span><span class="p">)</span>
  <span class="n">a_mean</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">a_dtype</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">centered</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">a_mean</span>
  <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">centered</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">complexfloating</span><span class="p">):</span>
    <span class="n">centered</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">centered</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">centered</span><span class="p">)))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">centered</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">centered</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">normalizer</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">normalizer</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">axis</span><span class="p">))</span>
  <span class="n">normalizer</span> <span class="o">=</span> <span class="n">normalizer</span> <span class="o">-</span> <span class="n">ddof</span>

  <span class="n">result</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">centered</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="n">keepdims</span><span class="p">)</span>
  <span class="n">out</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">normalizer</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span></div>



<div class="viewcode-block" id="std"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.std">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">std</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">std</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;std does not support the `out` argument.&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="n">ddof</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="n">keepdims</span><span class="p">))</span></div>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">ptp</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ptp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ptp does not support the `out` argument.&quot;</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">amax</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="n">keepdims</span><span class="p">)</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">amin</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="n">keepdims</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>


<div class="viewcode-block" id="allclose"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.allclose">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">allclose</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">allclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-05</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-08</span><span class="p">):</span>
  <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">isclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="p">))</span></div>


<div class="viewcode-block" id="count_nonzero"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.count_nonzero">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">count_nonzero</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
             <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">int_</span><span class="p">))</span></div>


<span class="n">_NONZERO_DOC</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">At present, JAX does not support JIT-compilation of :py:func:`jax.numpy.nonzero`</span>
<span class="s2">because its output shape is data-dependent.</span>
<span class="s2">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="nonzero"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.nonzero">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">nonzero</span><span class="p">,</span> <span class="n">lax_description</span><span class="o">=</span><span class="n">_NONZERO_DOC</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">nonzero</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
  <span class="c1"># Note: this function cannot be jitted because its output has a dynamic</span>
  <span class="c1"># shape.</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">atleast_1d</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="n">dims</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="n">ndims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
  <span class="n">ds</span> <span class="o">=</span> <span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">broadcasted_iota</span><span class="p">(</span><span class="n">int_</span><span class="p">,</span> <span class="n">dims</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">)]</span>
  <span class="n">d</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">indexes</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">a</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
  <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">indexes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndims</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">_make_nan_reduction</span><span class="p">(</span><span class="n">onp_reduction</span><span class="p">,</span> <span class="n">np_reduction</span><span class="p">,</span> <span class="n">init_val</span><span class="p">,</span> <span class="n">nan_if_all_nan</span><span class="p">):</span>
  <span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp_reduction</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">nan_reduction</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np_reduction</span><span class="p">(</span><span class="n">where</span><span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">_reduction_init_val</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">init_val</span><span class="p">),</span> <span class="n">a</span><span class="p">),</span>
                       <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="n">keepdims</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nan_if_all_nan</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">where</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="n">keepdims</span><span class="p">),</span>
                   <span class="n">_constant_like</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">nan</span><span class="p">),</span> <span class="n">out</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">out</span>

  <span class="k">return</span> <span class="n">nan_reduction</span>

<span class="n">nanmin</span> <span class="o">=</span> <span class="n">_make_nan_reduction</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">nanmin</span><span class="p">,</span> <span class="nb">min</span><span class="p">,</span> <span class="n">inf</span><span class="p">,</span> <span class="n">nan_if_all_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">nanmax</span> <span class="o">=</span> <span class="n">_make_nan_reduction</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">nanmax</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="o">-</span><span class="n">inf</span><span class="p">,</span> <span class="n">nan_if_all_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">nansum</span> <span class="o">=</span> <span class="n">_make_nan_reduction</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">nansum</span><span class="p">,</span> <span class="nb">sum</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nan_if_all_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">nanprod</span> <span class="o">=</span> <span class="n">_make_nan_reduction</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">nanprod</span><span class="p">,</span> <span class="n">prod</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nan_if_all_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">nanmean</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">nanmean</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;nanmean does not support the `out` argument.&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">bool_</span><span class="p">)</span> <span class="ow">or</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">integer</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mean</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">keepdims</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="n">nan_mask</span> <span class="o">=</span> <span class="n">logical_not</span><span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
  <span class="n">normalizer</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nan_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">int32</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="n">keepdims</span><span class="p">)</span>
  <span class="n">normalizer</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">normalizer</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
  <span class="n">td</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">nansum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="n">keepdims</span><span class="p">),</span> <span class="n">normalizer</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">td</span>

<span class="k">def</span> <span class="nf">_make_cumulative_reduction</span><span class="p">(</span><span class="n">onp_reduction</span><span class="p">,</span> <span class="n">window_reduce</span><span class="p">,</span> <span class="n">init_val</span><span class="p">,</span>
                               <span class="n">squash_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="c1"># We want to allow XLA to fuse the pad and reduce-window operators to</span>
  <span class="c1"># avoid materializing the padded output.</span>
  <span class="c1"># Consider removing `jit` once again if reduce-window is generalized to</span>
  <span class="c1"># support arbitrary padding.</span>
  <span class="nd">@partial</span><span class="p">(</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
  <span class="k">def</span> <span class="nf">_cumulative_reduction</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">isscalar</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">ravel</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
      <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">a_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
    <span class="n">num_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">axis</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span> <span class="o">+</span> <span class="n">num_dims</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">axis</span> <span class="o">&gt;=</span> <span class="n">num_dims</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s2">&quot;axis </span><span class="si">{}</span><span class="s2"> is out of bounds for array of dimension </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">axis</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">squash_nan</span><span class="p">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">init_val</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dtype</span><span class="p">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">a_shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">a</span>

    <span class="n">padding</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">*</span> <span class="n">num_dims</span>
    <span class="n">padding</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">a_shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">init_val</span><span class="p">),</span> <span class="n">padding</span><span class="p">)</span>
    <span class="n">strides</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_dims</span>
    <span class="n">window_dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_dims</span>
    <span class="n">window_dims</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">window_reduce</span><span class="p">(</span>
       <span class="n">a</span><span class="p">,</span> <span class="n">window_dims</span><span class="p">,</span> <span class="n">strides</span><span class="p">,</span> <span class="n">xla_client</span><span class="o">.</span><span class="n">PaddingType</span><span class="o">.</span><span class="n">VALID</span><span class="p">)</span>

  <span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp_reduction</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">cumulative_reduction</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># jit doesn&#39;t support kwargs as static_args.</span>
    <span class="k">return</span> <span class="n">_cumulative_reduction</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">cumulative_reduction</span>


<span class="n">cumsum</span> <span class="o">=</span> <span class="n">_make_cumulative_reduction</span><span class="p">(</span>
  <span class="n">onp</span><span class="o">.</span><span class="n">cumsum</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">_reduce_window_sum</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">squash_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">cumprod</span> <span class="o">=</span> <span class="n">_make_cumulative_reduction</span><span class="p">(</span>
  <span class="n">onp</span><span class="o">.</span><span class="n">cumprod</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">_reduce_window_prod</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">squash_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">cumproduct</span> <span class="o">=</span> <span class="n">cumprod</span>
<span class="n">nancumsum</span> <span class="o">=</span> <span class="n">_make_cumulative_reduction</span><span class="p">(</span>
  <span class="n">onp</span><span class="o">.</span><span class="n">nancumsum</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">_reduce_window_sum</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">squash_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">nancumprod</span> <span class="o">=</span> <span class="n">_make_cumulative_reduction</span><span class="p">(</span>
  <span class="n">onp</span><span class="o">.</span><span class="n">nancumprod</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">_reduce_window_prod</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">squash_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1">### Array-creation functions</span>

<span class="k">def</span> <span class="nf">_check_no_padding</span><span class="p">(</span><span class="n">axis_padding</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">axis_padding</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">axis_padding</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot apply &#39;</span><span class="si">{}</span><span class="s2">&#39; padding to empty axis&quot;</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>


<span class="nd">@partial</span><span class="p">(</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">_pad</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">constant_values</span><span class="p">):</span>
  <span class="n">array</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
  <span class="n">nd</span> <span class="o">=</span> <span class="n">ndim</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
  <span class="n">pad_width</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pad_width</span><span class="p">),</span> <span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
  <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">pad_width</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;index can&#39;t contain negative values&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;constant&quot;</span><span class="p">:</span>
    <span class="n">constant_values</span> <span class="o">=</span> <span class="n">broadcast_to</span><span class="p">(</span><span class="n">asarray</span><span class="p">(</span><span class="n">constant_values</span><span class="p">),</span> <span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">constant_values</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">constant_values</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nd</span><span class="p">):</span>
      <span class="n">widths</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">*</span> <span class="n">nd</span>
      <span class="n">widths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pad_width</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">array</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">constant_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">widths</span><span class="p">)</span>
      <span class="n">widths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">array</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">constant_values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">widths</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">array</span>
  <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;wrap&quot;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nd</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">_check_no_padding</span><span class="p">(</span><span class="n">pad_width</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">continue</span>
      <span class="n">size</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="n">repeats</span><span class="p">,</span> <span class="p">(</span><span class="n">left_remainder</span><span class="p">,</span> <span class="n">right_remainder</span><span class="p">)</span> <span class="o">=</span> <span class="n">_divmod</span><span class="p">(</span><span class="n">pad_width</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">size</span><span class="p">)</span>
      <span class="n">total_repeats</span> <span class="o">=</span> <span class="n">repeats</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">if</span> <span class="n">left_remainder</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">+=</span> <span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">slice_in_dim</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">left_remainder</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">i</span><span class="p">)]</span>
      <span class="n">parts</span> <span class="o">+=</span> <span class="n">total_repeats</span> <span class="o">*</span> <span class="p">[</span><span class="n">array</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">right_remainder</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">+=</span> <span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">slice_in_dim</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">right_remainder</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">i</span><span class="p">)]</span>
      <span class="n">array</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">array</span>
  <span class="k">elif</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;symmetric&quot;</span><span class="p">,</span> <span class="s2">&quot;reflect&quot;</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nd</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">_check_no_padding</span><span class="p">(</span><span class="n">pad_width</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">continue</span>

      <span class="n">n</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="n">rarray</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">rev</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,))</span>
      <span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;reflect&quot;</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>

      <span class="k">def</span> <span class="nf">build_padding</span><span class="p">(</span><span class="n">padding</span><span class="p">,</span> <span class="n">forward</span><span class="p">):</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">offset</span>
        <span class="k">while</span> <span class="n">padding</span> <span class="o">&gt;</span> <span class="n">delta</span><span class="p">:</span>
          <span class="n">padding</span> <span class="o">-=</span> <span class="n">delta</span>
          <span class="n">p</span> <span class="o">=</span> <span class="n">array</span> <span class="k">if</span> <span class="n">forward</span> <span class="k">else</span> <span class="n">rarray</span>
          <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">slice_in_dim</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">i</span><span class="p">))</span>
          <span class="n">forward</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">forward</span>
        <span class="k">if</span> <span class="n">padding</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">x</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">slice_in_dim</span><span class="p">(</span><span class="n">array</span> <span class="k">if</span> <span class="n">forward</span> <span class="k">else</span> <span class="n">rarray</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
                               <span class="n">padding</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
          <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xs</span>

      <span class="n">parts</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">build_padding</span><span class="p">(</span><span class="n">pad_width</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">forward</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
      <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">rev</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">]</span>
      <span class="n">parts</span> <span class="o">+=</span> <span class="p">[</span><span class="n">array</span><span class="p">]</span>
      <span class="n">parts</span> <span class="o">+=</span> <span class="n">build_padding</span><span class="p">(</span><span class="n">pad_width</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">forward</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
      <span class="n">array</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">array</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Unimplemented padding mode &#39;</span><span class="si">{}</span><span class="s2">&#39; for np.pad.&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>

<div class="viewcode-block" id="pad"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.pad">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">pad</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">_pad</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">constant_values</span><span class="p">)</span></div>


<div class="viewcode-block" id="stack"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.stack">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">stack</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need at least one array to stack.&quot;</span><span class="p">)</span>
  <span class="n">shape0</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">axis</span> <span class="o">=</span> <span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">new_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">shape0</span><span class="p">)</span>
  <span class="n">new_shape</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">new_arrays</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="n">shape0</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All input arrays must have the same shape.&quot;</span><span class="p">)</span>
    <span class="n">new_arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">new_shape</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">concatenate</span><span class="p">(</span><span class="n">new_arrays</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span></div>

<div class="viewcode-block" id="tile"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.tile">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">tile</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">tile</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">reps</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reps</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">reps</span> <span class="o">=</span> <span class="p">(</span><span class="n">reps</span><span class="p">,)</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reps</span><span class="p">)</span> <span class="o">-</span> <span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="o">+</span> <span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
  <span class="n">reps</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">reps</span><span class="p">))</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">reps</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rep</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reps</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">([</span><span class="n">a</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">rep</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">a</span></div>

<div class="viewcode-block" id="concatenate"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.concatenate">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">concatenate</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need at least one array to concatenate.&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">ndim</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Zero-dimensional arrays cannot be concatenated.&quot;</span><span class="p">)</span>
  <span class="n">axis</span> <span class="o">=</span> <span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">ndim</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
  <span class="n">arrays</span> <span class="o">=</span> <span class="n">_promote_dtypes</span><span class="p">(</span><span class="o">*</span><span class="n">arrays</span><span class="p">)</span>
  <span class="c1"># lax.concatenate can be slow to compile for wide concatenations, so form a</span>
  <span class="c1"># tree of concatenations as a workaround especially for op-by-op mode.</span>
  <span class="c1"># (https://github.com/google/jax/issues/653).</span>
  <span class="n">k</span> <span class="o">=</span> <span class="mi">16</span>
  <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">k</span><span class="p">],</span> <span class="n">axis</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">),</span> <span class="n">k</span><span class="p">)]</span>
  <span class="k">return</span> <span class="n">arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="vstack"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.vstack">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">vstack</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">vstack</span><span class="p">(</span><span class="n">tup</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">concatenate</span><span class="p">([</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">tup</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>
<span class="n">row_stack</span> <span class="o">=</span> <span class="n">vstack</span>


<div class="viewcode-block" id="hstack"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.hstack">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">hstack</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hstack</span><span class="p">(</span><span class="n">tup</span><span class="p">):</span>
  <span class="n">arrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">tup</span><span class="p">]</span>
  <span class="k">if</span> <span class="n">arrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">concatenate</span><span class="p">(</span><span class="n">arrs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">concatenate</span><span class="p">(</span><span class="n">arrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="dstack"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.dstack">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">dstack</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dstack</span><span class="p">(</span><span class="n">tup</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">concatenate</span><span class="p">([</span><span class="n">atleast_3d</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">tup</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="column_stack"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.column_stack">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">column_stack</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">column_stack</span><span class="p">(</span><span class="n">tup</span><span class="p">):</span>
  <span class="n">arrays</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tup</span><span class="p">:</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">concatenate</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="atleast_1d"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.atleast_1d">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">atleast_1d</span><span class="p">(</span><span class="o">*</span><span class="n">arys</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">arys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">arr</span> <span class="k">if</span> <span class="n">ndim</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">reshape</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arys</span><span class="p">]</span></div>


<div class="viewcode-block" id="atleast_2d"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.atleast_2d">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">atleast_2d</span><span class="p">(</span><span class="o">*</span><span class="n">arys</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">arys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">arr</span> <span class="k">if</span> <span class="n">ndim</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">reshape</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arys</span><span class="p">]</span></div>


<div class="viewcode-block" id="atleast_3d"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.atleast_3d">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">atleast_3d</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">atleast_3d</span><span class="p">(</span><span class="o">*</span><span class="n">arys</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">arys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ndim</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">arr</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">ndim</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">arr</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">shape</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">arr</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">atleast_3d</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arys</span><span class="p">]</span></div>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">array</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">order</span> <span class="o">!=</span> <span class="s2">&quot;K&quot;</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only implemented for order=&#39;K&#39;&quot;</span><span class="p">)</span>
  <span class="n">lax</span><span class="o">.</span><span class="n">_check_user_dtype_supported</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">and</span> <span class="n">_dtype</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">device_put</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">isscalar</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="p">())</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">and</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
  <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;__array__&#39;</span><span class="p">):</span>
    <span class="c1"># this case is for duck-typed handling of objects that implement `__array__`</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="n">__array__</span><span class="p">(),</span> <span class="n">dtype</span> <span class="ow">and</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
    <span class="k">if</span> <span class="nb">object</span><span class="p">:</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">stack</span><span class="p">([</span><span class="n">array</span><span class="p">(</span><span class="n">elt</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="nb">object</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span> <span class="ow">or</span> <span class="n">float_</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">view</span> <span class="o">=</span> <span class="nb">memoryview</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
      <span class="k">pass</span>  <span class="c1"># `object` does not support the buffer interface.</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">view</span><span class="p">),</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span>

    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unexpected input type for array: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="nb">object</span><span class="p">)))</span>

  <span class="k">if</span> <span class="n">ndmin</span> <span class="o">&gt;</span> <span class="n">ndim</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ndmin</span> <span class="o">-</span> <span class="n">ndim</span><span class="p">(</span><span class="n">out</span><span class="p">))</span> <span class="o">+</span> <span class="n">shape</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">out</span>

<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">asarray</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">lax</span><span class="o">.</span><span class="n">_check_user_dtype_supported</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;asarray&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>


<div class="viewcode-block" id="zeros_like"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.zeros_like">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">lax</span><span class="o">.</span><span class="n">_check_user_dtype_supported</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;zeros_like&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span></div>


<div class="viewcode-block" id="ones_like"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.ones_like">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">ones_like</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">lax</span><span class="o">.</span><span class="n">_check_user_dtype_supported</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;ones_like&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span></div>


<div class="viewcode-block" id="full"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.full">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">full</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">lax</span><span class="o">.</span><span class="n">_check_user_dtype_supported</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;full&quot;</span><span class="p">)</span>
  <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">,)</span> <span class="k">if</span> <span class="n">ndim</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">shape</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span></div>


<div class="viewcode-block" id="full_like"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.full_like">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">full_like</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">full_like</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">lax</span><span class="o">.</span><span class="n">_check_user_dtype_supported</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;full_like&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span></div>


<div class="viewcode-block" id="zeros"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.zeros">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">zeros</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;expected sequence object with len &gt;= 0 or a single integer&quot;</span><span class="p">)</span>
  <span class="n">lax</span><span class="o">.</span><span class="n">_check_user_dtype_supported</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;zeros&quot;</span><span class="p">)</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">float_</span> <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dtype</span>
  <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">,)</span> <span class="k">if</span> <span class="n">ndim</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">shape</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span></div>

<div class="viewcode-block" id="ones"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.ones">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">ones</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;expected sequence object with len &gt;= 0 or a single integer&quot;</span><span class="p">)</span>
  <span class="n">lax</span><span class="o">.</span><span class="n">_check_user_dtype_supported</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;ones&quot;</span><span class="p">)</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">float_</span> <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dtype</span>
  <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">,)</span> <span class="k">if</span> <span class="n">ndim</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">shape</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span></div>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">array_equal</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">array_equal</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">a1</span><span class="p">),</span> <span class="n">asarray</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">False</span>
  <span class="k">return</span> <span class="n">shape</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span> <span class="o">==</span> <span class="n">shape</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">asarray</span><span class="p">(</span><span class="n">a1</span> <span class="o">==</span> <span class="n">a2</span><span class="p">))</span>


<span class="c1"># We can&#39;t create uninitialized arrays in XLA; use zeros for empty.</span>
<span class="n">empty_like</span> <span class="o">=</span> <span class="n">zeros_like</span>
<span class="n">empty</span> <span class="o">=</span> <span class="n">zeros</span>


<div class="viewcode-block" id="eye"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.eye">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">eye</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">eye</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">lax</span><span class="o">.</span><span class="n">_check_user_dtype_supported</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;eye&quot;</span><span class="p">)</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">float_</span> <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dtype</span>
  <span class="n">M</span> <span class="o">=</span> <span class="n">N</span> <span class="k">if</span> <span class="n">M</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">M</span>
  <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">M</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;negative dimensions are not allowed, got </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">&quot;</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">k_dtype</span> <span class="o">=</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">k_dtype</span><span class="p">,</span> <span class="n">integer</span><span class="p">):</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;eye argument `k` must be of integer dtype, got </span><span class="si">{}</span><span class="s2">&quot;</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k_dtype</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">_eye</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">),</span> <span class="n">k</span><span class="p">)</span></div>


<div class="viewcode-block" id="identity"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.identity">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">identity</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">identity</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">lax</span><span class="o">.</span><span class="n">_check_user_dtype_supported</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;identity&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span></div>


<div class="viewcode-block" id="arange"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.arange">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">arange</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">lax</span><span class="o">.</span><span class="n">_check_user_dtype_supported</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;arange&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span> <span class="ow">or</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">iota</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>  <span class="c1"># avoids materializing</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">_wrap_numpy_nullary_function</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Adapts `f` to return a DeviceArray instead of an onp.ndarray.</span>

<span class="sd">  `f` cannot have any non-static array arguments.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="nd">@_wraps</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">asarray</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">wrapper</span>


<div class="viewcode-block" id="linspace"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.linspace">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">linspace</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">retstep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Implementation of linspace differentiable in start and stop args.&quot;&quot;&quot;</span>
  <span class="n">lax</span><span class="o">.</span><span class="n">_check_user_dtype_supported</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;linspace&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of samples, </span><span class="si">%s</span><span class="s2">, must be non-negative.&quot;</span> <span class="o">%</span> <span class="n">num</span><span class="p">)</span>
  <span class="n">dt</span> <span class="o">=</span> <span class="n">result_type</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span> <span class="ow">or</span> <span class="n">dt</span>
  <span class="n">bounds_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">broadcast_shapes</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">shape</span><span class="p">(</span><span class="n">stop</span><span class="p">)))</span>
  <span class="n">broadcast_start</span> <span class="o">=</span> <span class="n">broadcast_to</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">bounds_shape</span><span class="p">)</span>
  <span class="n">axis</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bounds_shape</span><span class="p">)</span> <span class="o">+</span> <span class="n">axis</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">axis</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">axis</span>
  <span class="n">bounds_shape</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">iota_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">bounds_shape</span><span class="p">)</span>
  <span class="n">iota_shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span>
  <span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">endpoint</span> <span class="k">else</span> <span class="n">num</span>
  <span class="k">if</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span> <span class="o">/</span> <span class="n">div</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">reshape</span><span class="p">(</span><span class="n">broadcast_start</span><span class="p">,</span> <span class="n">bounds_shape</span><span class="p">)</span> <span class="o">+</span>
           <span class="n">reshape</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">iota</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">num</span><span class="p">),</span> <span class="n">iota_shape</span><span class="p">)</span> <span class="o">*</span>
           <span class="n">reshape</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">bounds_shape</span><span class="p">))</span>
  <span class="k">elif</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">nan</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">broadcast_start</span><span class="p">,</span> <span class="n">bounds_shape</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span> <span class="c1"># num == 0 degenerate case, match onp behavior</span>
    <span class="n">empty_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">broadcast_shapes</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">shape</span><span class="p">(</span><span class="n">stop</span><span class="p">)))</span>
    <span class="n">empty_shape</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">nan</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dt</span><span class="p">),</span> <span class="n">empty_shape</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">retstep</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dtype</span><span class="p">),</span> <span class="n">delta</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span></div>


<div class="viewcode-block" id="logspace"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.logspace">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">logspace</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Implementation of logspace differentiable in start and stop args.&quot;&quot;&quot;</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span> <span class="ow">or</span> <span class="n">result_type</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">float_</span><span class="p">)</span>
  <span class="n">computation_dtype</span> <span class="o">=</span> <span class="n">promote_types</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">float_</span><span class="p">)</span>
  <span class="n">start</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">computation_dtype</span><span class="p">)</span>
  <span class="n">stop</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">computation_dtype</span><span class="p">)</span>
  <span class="n">lin</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span>
                 <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">retstep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">power</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">lin</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span></div>


<div class="viewcode-block" id="geomspace"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.geomspace">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">geomspace</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">geomspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Implementation of geomspace differentiable in start and stop args.&quot;&quot;&quot;</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span> <span class="ow">or</span> <span class="n">result_type</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="p">),</span> <span class="n">zeros</span><span class="p">((),</span> <span class="n">dtype</span><span class="p">))</span>
  <span class="n">computation_dtype</span> <span class="o">=</span> <span class="n">promote_types</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">float32</span><span class="p">)</span>
  <span class="n">start</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">computation_dtype</span><span class="p">)</span>
  <span class="n">stop</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">computation_dtype</span><span class="p">)</span>
  <span class="c1"># follow the numpy geomspace convention for negative and complex endpoints</span>
  <span class="n">signflip</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sign</span><span class="p">(</span><span class="n">real</span><span class="p">(</span><span class="n">start</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sign</span><span class="p">(</span><span class="n">real</span><span class="p">(</span><span class="n">stop</span><span class="p">)))</span> <span class="o">//</span> <span class="mi">2</span>
  <span class="n">res</span> <span class="o">=</span> <span class="n">signflip</span> <span class="o">*</span> <span class="n">logspace</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">signflip</span> <span class="o">*</span> <span class="n">start</span><span class="p">),</span>
                            <span class="n">log10</span><span class="p">(</span><span class="n">signflip</span> <span class="o">*</span> <span class="n">stop</span><span class="p">),</span> <span class="n">num</span><span class="p">,</span>
                            <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                            <span class="n">dtype</span><span class="o">=</span><span class="n">computation_dtype</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">axis</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">moveaxis</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span></div>


<div class="viewcode-block" id="meshgrid"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.meshgrid">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="n">indexing</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;indexing&quot;</span><span class="p">,</span> <span class="s2">&quot;xy&quot;</span><span class="p">)</span>
  <span class="n">sparse</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sparse&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
  <span class="n">copy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;copy&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">copy</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;jax.numpy.meshgrid only supports copy=True&quot;</span><span class="p">)</span>

  <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">indexing</span> <span class="o">==</span> <span class="s2">&quot;xy&quot;</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">elif</span> <span class="n">indexing</span> <span class="o">!=</span> <span class="s2">&quot;ij&quot;</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Valid values for indexing are &#39;xy&#39; and &#39;ij&#39;, got </span><span class="si">{}</span><span class="s2">&quot;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indexing</span><span class="p">))</span>

  <span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arguments to jax.numpy.meshgrid must be 1D, got shape </span><span class="si">{}</span><span class="s2">&quot;</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">sparse</span> <span class="k">else</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

  <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">shape</span>
    <span class="k">if</span> <span class="n">sparse</span><span class="p">:</span>
      <span class="n">s</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
      <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">broadcast_in_dim</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,)))</span>

  <span class="k">if</span> <span class="n">indexing</span> <span class="o">==</span> <span class="s2">&quot;xy&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="ix_"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.ix_">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">ix_</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ix_</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
  <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
  <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arguments to jax.numpy.ix_ must be 1-dimensional, got shape </span><span class="si">{}</span><span class="s2">&quot;</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="n">bool_</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s2">&quot;Boolean arguments to jax.numpy.ix_ are not implemented&quot;</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
    <span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="c1"># Numpy uses an integer index type for empty arrays.</span>
      <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">onp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((),</span> <span class="n">onp</span><span class="o">.</span><span class="n">intp</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">shape</span><span class="p">))</span>
  <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">output</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_repeat_scalar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">repeats</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">isscalar</span><span class="p">(</span><span class="n">repeats</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s2">&quot;_repeat_scalar implementation only supports scalar repeats&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">isscalar</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">ravel</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">a_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
  <span class="n">num_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_shape</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">axis</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span> <span class="o">+</span> <span class="n">num_dims</span>

  <span class="k">if</span> <span class="n">axis</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">axis</span> <span class="o">&gt;=</span> <span class="n">num_dims</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="s2">&quot;axis </span><span class="si">{}</span><span class="s2"> is out of bounds for array of dimension </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">axis</span><span class="p">,</span> <span class="n">num_dims</span><span class="p">))</span>

  <span class="c1"># Broadcasts to [..., X, repeats, ...] and reshapes to [..., X * repeats, ...]</span>
  <span class="n">broadcast_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">a_shape</span><span class="p">)</span>
  <span class="n">broadcast_shape</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">axis</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">repeats</span><span class="p">)</span>
  <span class="n">broadcast_dims</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">onp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                                    <span class="n">onp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">axis</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">num_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
  <span class="n">a_shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">*=</span> <span class="n">repeats</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
      <span class="n">lax</span><span class="o">.</span><span class="n">broadcast_in_dim</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">broadcast_shape</span><span class="p">,</span> <span class="n">broadcast_dims</span><span class="p">),</span>
      <span class="n">a_shape</span><span class="p">)</span>

<div class="viewcode-block" id="repeat"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.repeat">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">repeat</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">repeat</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">repeats</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  :param repeats: int or array of ints</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="c1"># use `_repeat_scalar` when possible</span>
  <span class="k">if</span> <span class="n">isscalar</span><span class="p">(</span><span class="n">repeats</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_repeat_scalar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">repeats</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
  <span class="n">repeats_raveled</span> <span class="o">=</span> <span class="n">ravel</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">repeats</span><span class="p">))</span> <span class="c1"># make sure it&#39;s jax&#39;s array type</span>
  <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">repeats_raveled</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">_repeat_scalar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">repeats_raveled</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">isscalar</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">ravel</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="c1"># repeats must match the dimension along the requested axis</span>
  <span class="n">a_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
  <span class="n">n</span> <span class="o">=</span> <span class="n">a_shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
  <span class="k">if</span> <span class="n">size</span><span class="p">(</span><span class="n">repeats_raveled</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;repeats shape </span><span class="si">{}</span><span class="s2"> does not match the dimension on axis </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
      <span class="n">repeats_raveled</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n</span>
    <span class="p">))</span>

  <span class="c1"># calculating the new shape</span>
  <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">repeats_raveled</span><span class="p">)</span>

  <span class="n">new_shape</span> <span class="o">=</span> <span class="n">a_shape</span><span class="p">[:]</span>
  <span class="n">new_shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">total</span>

  <span class="n">a_flattened</span> <span class="o">=</span> <span class="n">ravel</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  main algorithm:</span>
<span class="sd">  first break down raveled input array into list of chunks; each chunk is the unit of repeat</span>
<span class="sd">  then tile the repeats to have same length as the list of chunks</span>
<span class="sd">  finally repeat each unit x number of times according to the tiled repeat list</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="n">chunks</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">a_shape</span><span class="p">[:</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
  <span class="n">a_splitted</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">a_flattened</span><span class="p">,</span> <span class="n">chunks</span><span class="p">)</span>
  <span class="n">repeats_tiled</span> <span class="o">=</span> <span class="n">tile</span><span class="p">(</span><span class="n">repeats_raveled</span><span class="p">,</span> <span class="n">chunks</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">repeats_raveled</span><span class="p">))</span>

  <span class="n">ret</span> <span class="o">=</span> <span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">repeat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">repeats_tiled</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">repeat</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
      <span class="n">repeat</span> <span class="o">=</span> <span class="n">repeat</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">repeat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">ret</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">((</span><span class="n">ret</span><span class="p">,</span> <span class="n">tile</span><span class="p">(</span><span class="n">a_splitted</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">repeat</span><span class="p">)))</span>

  <span class="k">return</span> <span class="n">reshape</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">new_shape</span><span class="p">)</span></div>

<div class="viewcode-block" id="tri"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.tri">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">tri</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">tri</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">lax</span><span class="o">.</span><span class="n">_check_user_dtype_supported</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;tri&quot;</span><span class="p">)</span>
  <span class="n">M</span> <span class="o">=</span> <span class="n">M</span> <span class="k">if</span> <span class="n">M</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">N</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span> <span class="ow">or</span> <span class="n">float32</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">_tri</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">),</span> <span class="n">k</span><span class="p">)</span></div>


<div class="viewcode-block" id="tril"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.tril">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">tril</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">tril</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="n">m_shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m_shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument to jax.numpy.tril must be at least 2D&quot;</span><span class="p">)</span>
  <span class="n">mask</span> <span class="o">=</span> <span class="n">tri</span><span class="p">(</span><span class="o">*</span><span class="n">m_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">m_shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> <span class="n">m</span><span class="p">,</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">m</span><span class="p">))</span></div>


<div class="viewcode-block" id="triu"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.triu">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">triu</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">triu</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="n">m_shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m_shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument to jax.numpy.triu must be at least 2D&quot;</span><span class="p">)</span>
  <span class="n">mask</span> <span class="o">=</span> <span class="n">tri</span><span class="p">(</span><span class="o">*</span><span class="n">m_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">m_shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">m</span><span class="p">)</span></div>


<div class="viewcode-block" id="trace"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.trace">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;The &#39;out&#39; argument to trace is not supported.&quot;</span><span class="p">)</span>
  <span class="n">lax</span><span class="o">.</span><span class="n">_check_user_dtype_supported</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;trace&quot;</span><span class="p">)</span>

  <span class="n">axis1</span> <span class="o">=</span> <span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">axis1</span><span class="p">,</span> <span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
  <span class="n">axis2</span> <span class="o">=</span> <span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">axis2</span><span class="p">,</span> <span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

  <span class="n">a_shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">integer</span><span class="p">):</span>
      <span class="n">default_int</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">int_</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">iinfo</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">bits</span> <span class="o">&lt;</span> <span class="n">iinfo</span><span class="p">(</span><span class="n">default_int</span><span class="p">)</span><span class="o">.</span><span class="n">bits</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">default_int</span>

  <span class="c1"># Move the axis? dimensions to the end.</span>
  <span class="n">perm</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a_shape</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">axis1</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">axis2</span><span class="p">]</span>
  <span class="n">perm</span> <span class="o">=</span> <span class="n">perm</span> <span class="o">+</span> <span class="p">[</span><span class="n">axis1</span><span class="p">,</span> <span class="n">axis2</span><span class="p">]</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">perm</span><span class="p">)</span>

  <span class="c1"># Mask out the diagonal and reduce.</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">eye</span><span class="p">(</span><span class="n">a_shape</span><span class="p">[</span><span class="n">axis1</span><span class="p">],</span> <span class="n">a_shape</span><span class="p">[</span><span class="n">axis2</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
  <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_wrap_indices_function</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
  <span class="nd">@_wraps</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">wrapper</span>

<span class="n">tril_indices</span> <span class="o">=</span> <span class="n">_wrap_indices_function</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">)</span>
<span class="n">triu_indices</span> <span class="o">=</span> <span class="n">_wrap_indices_function</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">)</span>
<span class="n">mask_indices</span> <span class="o">=</span> <span class="n">_wrap_indices_function</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">mask_indices</span><span class="p">)</span>

<div class="viewcode-block" id="diag_indices"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.diag_indices">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">diag_indices</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">diag_indices</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;n argument to diag_indices must be nonnegative, got </span><span class="si">{}</span><span class="s2">&quot;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ndim argument to diag_indices must be nonnegative, got </span><span class="si">{}</span><span class="s2">&quot;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ndim</span><span class="p">))</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">iota</span><span class="p">(</span><span class="n">int_</span><span class="p">,</span> <span class="n">n</span><span class="p">),)</span> <span class="o">*</span> <span class="n">ndim</span></div>

<div class="viewcode-block" id="diagonal"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.diagonal">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">diagonal</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">diagonal</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis2</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
  <span class="n">a_shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="n">a_ndims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_shape</span><span class="p">)</span>

  <span class="c1"># Move the two dimensions to the end.</span>
  <span class="n">axis1</span> <span class="o">=</span> <span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">axis1</span><span class="p">,</span> <span class="n">a_ndims</span><span class="p">)</span>
  <span class="n">axis2</span> <span class="o">=</span> <span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">axis2</span><span class="p">,</span> <span class="n">a_ndims</span><span class="p">)</span>
  <span class="n">perm</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a_ndims</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">axis1</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">axis2</span><span class="p">]</span>
  <span class="n">perm</span> <span class="o">=</span> <span class="n">perm</span> <span class="o">+</span> <span class="p">[</span><span class="n">axis1</span><span class="p">,</span> <span class="n">axis2</span><span class="p">]</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">perm</span><span class="p">)</span>

  <span class="c1"># Mask out the diagonal and reduce over one of the axes</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">eye</span><span class="p">(</span><span class="n">a_shape</span><span class="p">[</span><span class="n">axis1</span><span class="p">],</span> <span class="n">a_shape</span><span class="p">[</span><span class="n">axis2</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
  <span class="n">reduce_axis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
  <span class="n">d</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">reduce_axis</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

  <span class="c1"># Slice out the correct diagonal size.</span>
  <span class="n">diag_size</span> <span class="o">=</span> <span class="n">_max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_min</span><span class="p">(</span><span class="n">a_shape</span><span class="p">[</span><span class="n">axis1</span><span class="p">]</span> <span class="o">+</span> <span class="n">_min</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                           <span class="n">a_shape</span><span class="p">[</span><span class="n">axis2</span><span class="p">]</span> <span class="o">-</span> <span class="n">_max</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">slice_in_dim</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">diag_size</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="diag"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.diag">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">diag</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">diag</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="n">v_shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">lax</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">v_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">_abs</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">zero</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="p">((</span><span class="n">_max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">_max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">k</span><span class="p">),</span> <span class="mi">0</span><span class="p">),))</span>
    <span class="k">return</span> <span class="n">where</span><span class="p">(</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span> <span class="n">v</span><span class="p">,</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
  <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">diagonal</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;diag input must be 1d or 2d&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="polyval"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.polyval">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">polyval</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">polyval</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">onp</span><span class="o">.</span><span class="n">poly1d</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">onp</span><span class="o">.</span><span class="n">poly1d</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">y</span></div>


<div class="viewcode-block" id="append"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.append">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">append</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">concatenate</span><span class="p">([</span><span class="n">ravel</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span> <span class="n">ravel</span><span class="p">(</span><span class="n">values</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">concatenate</span><span class="p">([</span><span class="n">arr</span><span class="p">,</span> <span class="n">values</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span></div>


<span class="c1">### Tensor contraction operations</span>


<span class="n">_PRECISION_DOC</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">In addition to the original NumPy arguments listed below, also supports</span>
<span class="s2">``precision`` for extra control over matrix-multiplication precision</span>
<span class="s2">on supported devices. See :py:func:`jax.lax.dot` for details.</span>
<span class="s2">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="dot"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.dot">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span> <span class="n">lax_description</span><span class="o">=</span><span class="n">_PRECISION_DOC</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># pylint: disable=missing-docstring</span>
  <span class="n">_check_arraylike</span><span class="p">(</span><span class="s2">&quot;dot&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">_promote_dtypes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="n">a_ndim</span><span class="p">,</span> <span class="n">b_ndim</span> <span class="o">=</span> <span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">ndim</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">a_ndim</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">b_ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">_max</span><span class="p">(</span><span class="n">a_ndim</span><span class="p">,</span> <span class="n">b_ndim</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">precision</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">b_ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">contract_dims</span> <span class="o">=</span> <span class="p">((</span><span class="n">a_ndim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">contract_dims</span> <span class="o">=</span> <span class="p">((</span><span class="n">a_ndim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,),</span> <span class="p">(</span><span class="n">b_ndim</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,))</span>
  <span class="n">batch_dims</span> <span class="o">=</span> <span class="p">((),</span> <span class="p">())</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">dot_general</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="n">contract_dims</span><span class="p">,</span> <span class="n">batch_dims</span><span class="p">),</span> <span class="n">precision</span><span class="p">)</span></div>


<div class="viewcode-block" id="matmul"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.matmul">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">matmul</span><span class="p">,</span> <span class="n">lax_description</span><span class="o">=</span><span class="n">_PRECISION_DOC</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">matmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># pylint: disable=missing-docstring</span>
  <span class="n">_check_arraylike</span><span class="p">(</span><span class="s2">&quot;matmul&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="n">a_is_vec</span><span class="p">,</span> <span class="n">b_is_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">ndim</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="k">if</span> <span class="n">a_is_vec</span> <span class="k">else</span> <span class="n">a</span>
  <span class="n">b</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">shape</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span> <span class="k">if</span> <span class="n">b_is_vec</span> <span class="k">else</span> <span class="n">b</span>

  <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">_promote_dtypes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="n">batch_shape</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">broadcast_shapes</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">shape</span><span class="p">(</span><span class="n">b</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">broadcast_to</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">batch_shape</span> <span class="o">+</span> <span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
  <span class="n">b</span> <span class="o">=</span> <span class="n">broadcast_to</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">batch_shape</span> <span class="o">+</span> <span class="n">shape</span><span class="p">(</span><span class="n">b</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
  <span class="n">batch_dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_shape</span><span class="p">)))</span>
  <span class="n">dim_numbers</span> <span class="o">=</span> <span class="p">(((</span><span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,),</span> <span class="p">(</span><span class="n">ndim</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,)),</span> <span class="p">(</span><span class="n">batch_dims</span><span class="p">,</span> <span class="n">batch_dims</span><span class="p">))</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dot_general</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">dim_numbers</span><span class="p">,</span>  <span class="n">precision</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">a_is_vec</span> <span class="ow">or</span> <span class="n">b_is_vec</span><span class="p">:</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">result</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">new_m</span> <span class="o">=</span> <span class="p">()</span> <span class="k">if</span> <span class="n">a_is_vec</span> <span class="k">else</span> <span class="p">(</span><span class="n">m</span><span class="p">,)</span>
    <span class="n">new_n</span> <span class="o">=</span> <span class="p">()</span> <span class="k">if</span> <span class="n">b_is_vec</span> <span class="k">else</span> <span class="p">(</span><span class="n">n</span><span class="p">,)</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">batch_shape</span> <span class="o">+</span> <span class="n">new_m</span> <span class="o">+</span> <span class="n">new_n</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="vdot"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.vdot">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">vdot</span><span class="p">,</span> <span class="n">lax_description</span><span class="o">=</span><span class="n">_PRECISION_DOC</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">vdot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">complexfloating</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">conj</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">b</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">precision</span><span class="o">=</span><span class="n">precision</span><span class="p">)</span></div>


<div class="viewcode-block" id="tensordot"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.tensordot">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">tensordot</span><span class="p">,</span> <span class="n">lax_description</span><span class="o">=</span><span class="n">_PRECISION_DOC</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">tensordot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">_check_arraylike</span><span class="p">(</span><span class="s2">&quot;tensordot&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="n">a_ndim</span> <span class="o">=</span> <span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="n">b_ndim</span> <span class="o">=</span> <span class="n">ndim</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">a_ndim</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">b_ndim</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;tensordot requires a.ndim and b.dim to be at least 1, got </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">.&quot;</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">ndim</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span>

  <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">_promote_dtypes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">axes</span> <span class="o">&gt;</span> <span class="n">_min</span><span class="p">(</span><span class="n">a_ndim</span><span class="p">,</span> <span class="n">b_ndim</span><span class="p">):</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Number of tensordot axes (axes </span><span class="si">{}</span><span class="s2">) exceeds input ranks (</span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">)&quot;</span>
      <span class="k">raise</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">contracting_dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">a_ndim</span> <span class="o">-</span> <span class="n">axes</span><span class="p">,</span> <span class="n">a_ndim</span><span class="p">)),</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">axes</span><span class="p">))</span>
  <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ax1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">ax2</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
      <span class="n">contracting_dims</span> <span class="o">=</span> <span class="p">((</span><span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">a_ndim</span><span class="p">),),</span>
                          <span class="p">(</span><span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">b_ndim</span><span class="p">),))</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">ax1</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">ax2</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax2</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;tensordot requires axes lists to have equal length, got </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">.&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">))</span>
      <span class="n">contracting_dims</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">a_ndim</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ax1</span><span class="p">),</span>
                          <span class="nb">tuple</span><span class="p">(</span><span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">b_ndim</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ax2</span><span class="p">))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;tensordot axes argument must be an int, a pair of ints, or a pair &quot;</span>
           <span class="s2">&quot;of lists/tuples of ints.&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">dot_general</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="n">contracting_dims</span><span class="p">,</span> <span class="p">((),</span> <span class="p">())),</span>
                         <span class="n">precision</span><span class="o">=</span><span class="n">precision</span><span class="p">)</span></div>


<div class="viewcode-block" id="einsum"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.einsum">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">einsum</span><span class="p">,</span> <span class="n">lax_description</span><span class="o">=</span><span class="n">_PRECISION_DOC</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">einsum</span><span class="p">(</span><span class="o">*</span><span class="n">operands</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="n">optimize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;optimize&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">)</span>
  <span class="n">optimize</span> <span class="o">=</span> <span class="s1">&#39;greedy&#39;</span> <span class="k">if</span> <span class="n">optimize</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">optimize</span>
  <span class="n">precision</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;invalid keyword arguments for einsum: </span><span class="si">{}</span><span class="s1">&#39;</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)))</span>
  <span class="c1"># using einsum_call=True here is an internal api for opt_einsum</span>
  <span class="n">operands</span><span class="p">,</span> <span class="n">contractions</span> <span class="o">=</span> <span class="n">opt_einsum</span><span class="o">.</span><span class="n">contract_path</span><span class="p">(</span>
      <span class="o">*</span><span class="n">operands</span><span class="p">,</span> <span class="n">einsum_call</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_blas</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="n">optimize</span><span class="p">)</span>
  <span class="n">contractions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">contractions</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">_einsum</span><span class="p">(</span><span class="n">operands</span><span class="p">,</span> <span class="n">contractions</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span></div>

<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">einsum_path</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">einsum_path</span><span class="p">(</span><span class="n">subscripts</span><span class="p">,</span> <span class="o">*</span><span class="n">operands</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="n">optimize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;optimize&#39;</span><span class="p">,</span> <span class="s1">&#39;greedy&#39;</span><span class="p">)</span>
  <span class="c1"># using einsum_call=True here is an internal api for opt_einsum</span>
  <span class="k">return</span> <span class="n">opt_einsum</span><span class="o">.</span><span class="n">contract_path</span><span class="p">(</span><span class="n">subscripts</span><span class="p">,</span> <span class="o">*</span><span class="n">operands</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="n">optimize</span><span class="p">)</span>

<span class="nd">@partial</span><span class="p">(</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">_einsum</span><span class="p">(</span><span class="n">operands</span><span class="p">,</span> <span class="n">contractions</span><span class="p">,</span> <span class="n">precision</span><span class="p">):</span>
  <span class="n">operands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_promote_dtypes</span><span class="p">(</span><span class="o">*</span><span class="n">operands</span><span class="p">))</span>
  <span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                      <span class="n">lax</span><span class="o">.</span><span class="n">add</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">bool_</span> <span class="k">else</span> <span class="n">lax</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">sum_uniques</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">uniques</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">uniques</span><span class="p">:</span>
      <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">uniques</span><span class="p">]</span>
      <span class="n">operand</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span>
      <span class="n">names</span> <span class="o">=</span> <span class="n">removechars</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">uniques</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">operand</span><span class="p">,</span> <span class="n">names</span>

  <span class="k">def</span> <span class="nf">sum_repeats</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">keep_names</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span>
        <span class="n">eye</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">_delta</span><span class="p">(</span><span class="n">operand</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">operand</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep_names</span><span class="p">:</span>
          <span class="n">operand</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">operand</span> <span class="o">*</span> <span class="n">eye</span><span class="p">,</span> <span class="n">axes</span><span class="p">)</span>
          <span class="n">names</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">operand</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">operand</span> <span class="o">*</span> <span class="n">eye</span><span class="p">,</span> <span class="n">axes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
          <span class="n">names</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">operand</span><span class="p">,</span> <span class="n">names</span>

  <span class="k">for</span> <span class="n">operand_indices</span><span class="p">,</span> <span class="n">contracted_names</span><span class="p">,</span> <span class="n">einstr</span> <span class="ow">in</span> <span class="n">contractions</span><span class="p">:</span>
    <span class="n">input_str</span><span class="p">,</span> <span class="n">result_names</span> <span class="o">=</span> <span class="n">einstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">)</span>
    <span class="n">input_names</span> <span class="o">=</span> <span class="n">input_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

    <span class="c1"># switch on the number of operands to be processed in this loop iteration.</span>
    <span class="c1"># every case here sets &#39;operand&#39; and &#39;names&#39;.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">operand_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">operand</span> <span class="o">=</span> <span class="n">operands</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">operand_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">names</span><span class="p">,</span> <span class="o">=</span> <span class="n">input_names</span>
      <span class="n">counts</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

      <span class="c1"># sum out unique contracted indices with a single reduce-sum</span>
      <span class="n">uniques</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">contracted_names</span> <span class="k">if</span> <span class="n">counts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
      <span class="n">operand</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="n">sum_uniques</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">uniques</span><span class="p">)</span>

      <span class="c1"># for every repeated index, do a contraction against an identity matrix</span>
      <span class="n">operand</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="n">sum_repeats</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">result_names</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">operand_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">operands</span><span class="o">.</span><span class="n">pop</span><span class="p">,</span> <span class="n">operand_indices</span><span class="p">)</span>
      <span class="n">lhs_counts</span><span class="p">,</span> <span class="n">rhs_counts</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">,</span> <span class="n">input_names</span><span class="p">)</span>
      <span class="n">lhs_names</span><span class="p">,</span> <span class="n">rhs_names</span> <span class="o">=</span> <span class="n">input_names</span>

      <span class="c1"># sum out unique contracted indices in lhs and rhs</span>
      <span class="n">lhs_uniques</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">contracted_names</span>
                     <span class="k">if</span> <span class="n">lhs_counts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">rhs_counts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
      <span class="n">lhs</span><span class="p">,</span> <span class="n">lhs_names</span> <span class="o">=</span> <span class="n">sum_uniques</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">lhs_names</span><span class="p">,</span> <span class="n">lhs_uniques</span><span class="p">)</span>

      <span class="n">rhs_uniques</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">contracted_names</span>
                     <span class="k">if</span> <span class="n">rhs_counts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">lhs_counts</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
      <span class="n">rhs</span><span class="p">,</span> <span class="n">rhs_names</span> <span class="o">=</span> <span class="n">sum_uniques</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">rhs_names</span><span class="p">,</span> <span class="n">rhs_uniques</span><span class="p">)</span>

      <span class="c1"># for every repeated index, contract against an identity matrix</span>
      <span class="n">lhs</span><span class="p">,</span> <span class="n">lhs_names</span> <span class="o">=</span> <span class="n">sum_repeats</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">lhs_names</span><span class="p">,</span> <span class="n">lhs_counts</span><span class="p">,</span>
                                   <span class="n">result_names</span> <span class="o">+</span> <span class="n">rhs_names</span><span class="p">)</span>
      <span class="n">rhs</span><span class="p">,</span> <span class="n">rhs_names</span> <span class="o">=</span> <span class="n">sum_repeats</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">rhs_names</span><span class="p">,</span> <span class="n">rhs_counts</span><span class="p">,</span>
                                   <span class="n">result_names</span> <span class="o">+</span> <span class="n">lhs_names</span><span class="p">)</span>

      <span class="n">contracted_names</span> <span class="o">=</span> <span class="n">contracted_names</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lhs_names</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">rhs_names</span><span class="p">))</span>
      <span class="n">batch_names</span> <span class="o">=</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lhs_names</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">rhs_names</span><span class="p">))</span> <span class="o">-</span> <span class="n">contracted_names</span>
      <span class="n">lhs_batch</span><span class="p">,</span> <span class="n">rhs_batch</span> <span class="o">=</span> <span class="n">unzip2</span><span class="p">((</span><span class="n">lhs_names</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">rhs_names</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
                                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">batch_names</span><span class="p">)</span>

      <span class="c1"># NOTE(mattjj): this can fail non-deterministically in python3, maybe</span>
      <span class="c1"># due to opt_einsum</span>
      <span class="k">assert</span> <span class="n">_all</span><span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="n">lhs_names</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">rhs_names</span> <span class="ow">and</span>
                  <span class="n">lhs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">lhs_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">rhs_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
                  <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">contracted_names</span><span class="p">)</span>

      <span class="c1"># move batch dims to the front (required by lax.dot_general, and easier)</span>
      <span class="n">batch_dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_names</span><span class="p">)))</span>
      <span class="k">if</span> <span class="n">lhs_batch</span> <span class="o">!=</span> <span class="n">rhs_batch</span> <span class="ow">or</span> <span class="nb">set</span><span class="p">(</span><span class="n">lhs_batch</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">batch_dims</span><span class="p">):</span>
        <span class="n">lhs</span> <span class="o">=</span> <span class="n">moveaxis</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">lhs_batch</span><span class="p">,</span> <span class="n">batch_dims</span><span class="p">)</span>
        <span class="n">lhs_names</span> <span class="o">=</span> <span class="n">_movechars</span><span class="p">(</span><span class="n">lhs_names</span><span class="p">,</span> <span class="n">lhs_batch</span><span class="p">,</span> <span class="n">batch_dims</span><span class="p">)</span>
        <span class="n">rhs</span> <span class="o">=</span> <span class="n">moveaxis</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">rhs_batch</span><span class="p">,</span> <span class="n">batch_dims</span><span class="p">)</span>
        <span class="n">rhs_names</span> <span class="o">=</span> <span class="n">_movechars</span><span class="p">(</span><span class="n">rhs_names</span><span class="p">,</span> <span class="n">rhs_batch</span><span class="p">,</span> <span class="n">batch_dims</span><span class="p">)</span>
        <span class="n">batch_names</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">batch_names</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">batch_dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">lhs_batch</span><span class="p">)</span>
        <span class="n">batch_names</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lhs_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lhs_names</span><span class="p">))</span>
                              <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">batch_dims</span><span class="p">)</span>

      <span class="c1"># contract using lax.dot_general</span>
      <span class="n">lhs_cont</span><span class="p">,</span> <span class="n">rhs_cont</span> <span class="o">=</span> <span class="n">unzip2</span><span class="p">((</span><span class="n">lhs_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">rhs_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
                                  <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">contracted_names</span><span class="p">)</span>
      <span class="n">bdims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_dims</span><span class="p">)))</span>
      <span class="n">dimension_numbers</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lhs_cont</span><span class="p">,</span> <span class="n">rhs_cont</span><span class="p">),</span> <span class="p">(</span><span class="n">bdims</span><span class="p">,</span> <span class="n">bdims</span><span class="p">)]</span>
      <span class="n">operand</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dot_general</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">dimension_numbers</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span>
      <span class="n">deleted_names</span> <span class="o">=</span> <span class="n">batch_names</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">contracted_names</span><span class="p">)</span>
      <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_names</span> <span class="o">+</span> <span class="n">removechars</span><span class="p">(</span><span class="n">lhs_names</span><span class="p">,</span> <span class="n">deleted_names</span><span class="p">)</span>
               <span class="o">+</span> <span class="n">removechars</span><span class="p">(</span><span class="n">rhs_names</span><span class="p">,</span> <span class="n">deleted_names</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span>  <span class="c1"># if this is actually reachable, open an issue!</span>

    <span class="c1"># the resulting &#39;operand&#39; with axis labels &#39;names&#39; should be a permutation</span>
    <span class="c1"># of the desired result</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">result_names</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">names</span> <span class="o">!=</span> <span class="n">result_names</span><span class="p">:</span>
      <span class="n">perm</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">result_names</span><span class="p">])</span>
      <span class="n">operand</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">perm</span><span class="p">)</span>
    <span class="n">operands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span>  <span class="c1"># used in next iteration</span>

  <span class="k">return</span> <span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_movechars</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Helper for einsum string munging, like moveaxis on identifier strings.&quot;&quot;&quot;</span>
  <span class="n">chars</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">src</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">)):</span>
    <span class="n">chars</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
  <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>


<div class="viewcode-block" id="inner"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.inner">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">inner</span><span class="p">,</span> <span class="n">lax_description</span><span class="o">=</span><span class="n">_PRECISION_DOC</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">ndim</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>
  <span class="k">return</span> <span class="n">tensordot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">precision</span><span class="o">=</span><span class="n">precision</span><span class="p">)</span></div>


<div class="viewcode-block" id="outer"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.outer">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">outer</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">outer</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;The &#39;out&#39; argument to outer is not supported.&quot;</span><span class="p">)</span>
  <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">_promote_dtypes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">ravel</span><span class="p">(</span><span class="n">a</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">ravel</span><span class="p">(</span><span class="n">b</span><span class="p">)</span></div>

<span class="nd">@partial</span><span class="p">(</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">_cross</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">axisa</span><span class="p">,</span> <span class="n">axisb</span><span class="p">,</span> <span class="n">axisc</span><span class="p">):</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">moveaxis</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axisa</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">b</span> <span class="o">=</span> <span class="n">moveaxis</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">axisb</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">or</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dimension must be either 2 or 3 for cross product&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

  <span class="n">a0</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
  <span class="n">a1</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
  <span class="n">a2</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span>
  <span class="n">b0</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
  <span class="n">b1</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
  <span class="n">b2</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">b0</span><span class="p">)</span>
  <span class="n">c</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">a1</span> <span class="o">*</span> <span class="n">b2</span> <span class="o">-</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">b1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">b0</span> <span class="o">-</span> <span class="n">a0</span> <span class="o">*</span> <span class="n">b2</span><span class="p">,</span> <span class="n">a0</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">-</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">b0</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">moveaxis</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axisc</span><span class="p">)</span>

<div class="viewcode-block" id="cross"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.cross">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">cross</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cross</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">axisa</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axisb</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axisc</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">axisa</span> <span class="o">=</span> <span class="n">axis</span>
    <span class="n">axisb</span> <span class="o">=</span> <span class="n">axis</span>
    <span class="n">axisc</span> <span class="o">=</span> <span class="n">axis</span>
  <span class="k">return</span> <span class="n">_cross</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">axisa</span><span class="p">,</span> <span class="n">axisb</span><span class="p">,</span> <span class="n">axisc</span><span class="p">)</span></div>

<div class="viewcode-block" id="kron"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.kron">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">kron</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">kron</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
  <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">_promote_dtypes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ndim</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ndim</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="o">+</span> <span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
  <span class="k">elif</span> <span class="n">ndim</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">ndim</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="o">+</span> <span class="n">shape</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
  <span class="n">a_reshaped</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
  <span class="n">b_reshaped</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="p">)])</span>
  <span class="n">out_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">shape</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span>
  <span class="k">return</span> <span class="n">reshape</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">a_reshaped</span><span class="p">,</span> <span class="n">b_reshaped</span><span class="p">),</span> <span class="n">out_shape</span><span class="p">)</span></div>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">vander</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">vander</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">increasing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">_dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">ndim</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;x must be a one-dimensional array&quot;</span><span class="p">)</span>
  <span class="n">x_shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">N</span> <span class="o">=</span> <span class="n">N</span> <span class="ow">or</span> <span class="n">x_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">if</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;N must be nonnegative&quot;</span><span class="p">)</span>

  <span class="n">iota</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">iota</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">increasing</span><span class="p">:</span>
    <span class="n">iota</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">iota</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">iota</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">power</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">iota</span><span class="p">)</span>


<span class="c1">### Misc</span>


<div class="viewcode-block" id="argmax"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.argmax">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">argmax</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">argmax</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">ravel</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">return</span> <span class="n">_argminmax</span><span class="p">(</span><span class="nb">max</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span></div>


<div class="viewcode-block" id="argmin"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.argmin">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">argmin</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">argmin</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">ravel</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">return</span> <span class="n">_argminmax</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span></div>


<span class="c1"># TODO(mattjj): redo this lowering with a call to variadic lax.reduce</span>
<span class="k">def</span> <span class="nf">_argminmax</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
  <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span>
  <span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
  <span class="n">idxs</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">tie_in</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">arange</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
  <span class="n">maxval</span> <span class="o">=</span> <span class="n">iinfo</span><span class="p">(</span><span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">idxs</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span><span class="o">.</span><span class="n">max</span>
  <span class="n">maxval</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">tie_in</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">maxval</span><span class="p">)</span>
  <span class="n">mask_idxs</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">_eq_meet</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">op</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">maxval</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">mask_idxs</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>


<div class="viewcode-block" id="sort"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.sort">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">sort</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;quicksort&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">kind</span> <span class="o">!=</span> <span class="s1">&#39;quicksort&#39;</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;&#39;kind&#39; argument to sort is ignored.&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;order&#39; argument to sort is not supported.&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span></div>


<div class="viewcode-block" id="argsort"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.argsort">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">argsort</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">argsort</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;quicksort&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">kind</span> <span class="o">!=</span> <span class="s1">&#39;quicksort&#39;</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;&#39;kind&#39; argument to argsort is ignored.&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;order&#39; argument to argsort is not supported.&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">argsort</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
    <span class="n">iota</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">broadcasted_iota</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">axis</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">perm</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">sort_key_val</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">iota</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">perm</span></div>


<div class="viewcode-block" id="roll"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.roll">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">roll</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">roll</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="n">a_shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">roll</span><span class="p">(</span><span class="n">ravel</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">shift</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">a_shape</span><span class="p">)</span>

  <span class="n">a_ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_shape</span><span class="p">)</span>
  <span class="n">shift</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>
  <span class="n">axis</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
  <span class="n">b_shape</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">broadcast_shapes</span><span class="p">(</span><span class="n">shift</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&#39;shift&#39; and &#39;axis&#39; arguments to roll must be scalars or 1D arrays&quot;</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">b_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">a_ndim</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;More shifts/axes than dimensions of input to roll.&quot;</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="n">b_shape</span><span class="p">),</span>
                  <span class="n">onp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">b_shape</span><span class="p">)):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">a_ndim</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">remainder</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">a_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dynamic_slice_in_dim</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="n">a_shape</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">a</span></div>


<div class="viewcode-block" id="take"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.take">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">take</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">take</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;The &#39;out&#39; argument to np.take is not supported.&quot;</span><span class="p">)</span>

  <span class="n">a</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="n">indices</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">ravel</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">axis</span> <span class="o">=</span> <span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

  <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;raise&quot;</span><span class="p">:</span>
    <span class="c1"># TODO(phawkins): we have no way to report out of bounds errors yet.</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;The &#39;raise&#39; mode to np.take is not supported.&quot;</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;wrap&quot;</span><span class="p">:</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]))</span>
  <span class="k">elif</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;clip&quot;</span> <span class="ow">and</span> <span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid mode &#39;</span><span class="si">{}</span><span class="s2">&#39; for np.take&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>

  <span class="n">index_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
  <span class="n">slice_sizes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
  <span class="n">slice_sizes</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">dnums</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">GatherDimensionNumbers</span><span class="p">(</span>
    <span class="n">offset_dims</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span>
      <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">axis</span><span class="p">))</span> <span class="o">+</span>
      <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">axis</span> <span class="o">+</span> <span class="n">index_dims</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="n">index_dims</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))),</span>
    <span class="n">collapsed_slice_dims</span><span class="o">=</span><span class="p">(</span><span class="n">axis</span><span class="p">,),</span>
    <span class="n">start_index_map</span><span class="o">=</span><span class="p">(</span><span class="n">axis</span><span class="p">,))</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">indices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">dimension_numbers</span><span class="o">=</span><span class="n">dnums</span><span class="p">,</span>
                    <span class="n">slice_sizes</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">slice_sizes</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">_normalize_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">axis_size</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Normalizes an index value in the range [-N, N) to the range [0, N).&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">lax</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
    <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">axis_size</span><span class="p">)),</span>
    <span class="n">index</span><span class="p">)</span>

<span class="nd">@partial</span><span class="p">(</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,))</span>
<span class="k">def</span> <span class="nf">_take_along_axis</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">ndim</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;take_along_axis indices must be 1D if axis=None, got shape </span><span class="si">{}</span><span class="s2">&quot;</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">take_along_axis</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="n">rank</span> <span class="o">=</span> <span class="n">ndim</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">rank</span> <span class="o">!=</span> <span class="n">ndim</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;indices and arr must have the same number of dimensions; </span><span class="si">{}</span><span class="s2"> vs. </span><span class="si">{}</span><span class="s2">&quot;</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ndim</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span> <span class="n">ndim</span><span class="p">(</span><span class="n">arr</span><span class="p">)))</span>
  <span class="n">axis</span> <span class="o">=</span> <span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">rank</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="n">tup</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="n">lst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span>
    <span class="n">lst</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>

  <span class="n">bcast_shape</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">broadcast_shapes</span><span class="p">(</span><span class="n">replace</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">replace</span><span class="p">(</span><span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
  <span class="n">indices</span> <span class="o">=</span> <span class="n">broadcast_to</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">replace</span><span class="p">(</span><span class="n">bcast_shape</span><span class="p">,</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]))</span>
  <span class="n">arr</span>     <span class="o">=</span> <span class="n">broadcast_to</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span>     <span class="n">replace</span><span class="p">(</span><span class="n">bcast_shape</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]))</span>

  <span class="n">axis_size</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
  <span class="n">arr_shape</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">idx_shape</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span>
  <span class="n">out_shape</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">broadcast_shapes</span><span class="p">(</span><span class="n">idx_shape</span><span class="p">,</span> <span class="n">arr_shape</span><span class="p">)</span>

  <span class="n">index_dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx_shape</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">axis</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span>

  <span class="n">gather_index_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out_shape</span><span class="p">)[</span><span class="n">index_dims</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
  <span class="n">gather_indices</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">slice_sizes</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">offset_dims</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">start_index_map</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">collapsed_slice_dims</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rank</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">axis</span><span class="p">:</span>
      <span class="n">indices</span> <span class="o">=</span> <span class="n">_normalize_index</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">axis_size</span><span class="p">)</span>
      <span class="n">gather_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">gather_index_shape</span><span class="p">))</span>
      <span class="n">slice_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">start_index_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
      <span class="n">collapsed_slice_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
      <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">idx_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">iota</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">iota</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span> <span class="n">out_shape</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
      <span class="n">iota</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">tie_in</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">iota</span><span class="p">)</span>
      <span class="n">iota</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">broadcast_in_dim</span><span class="p">(</span><span class="n">iota</span><span class="p">,</span> <span class="n">gather_index_shape</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span><span class="p">,))</span>
      <span class="n">gather_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iota</span><span class="p">)</span>
      <span class="n">slice_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">start_index_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
      <span class="n">collapsed_slice_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
      <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># If idx_shape[i] == 1, we can just take the entirety of the arr&#39;s axis</span>
      <span class="c1"># and avoid forming an iota index.</span>
      <span class="n">offset_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
      <span class="n">slice_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr_shape</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

  <span class="n">gather_indices</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">gather_indices</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="n">j</span><span class="p">)</span>
  <span class="n">dnums</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">GatherDimensionNumbers</span><span class="p">(</span>
    <span class="n">offset_dims</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">offset_dims</span><span class="p">),</span>
    <span class="n">collapsed_slice_dims</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">collapsed_slice_dims</span><span class="p">),</span>
    <span class="n">start_index_map</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">start_index_map</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">gather_indices</span><span class="p">,</span> <span class="n">dnums</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">slice_sizes</span><span class="p">))</span>


<div class="viewcode-block" id="take_along_axis"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.take_along_axis">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">onp</span><span class="p">,</span> <span class="s2">&quot;take_along_axis&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">take_along_axis</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">_take_along_axis</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span></div>

<span class="c1">### Indexing</span>

<span class="k">def</span> <span class="nf">_rewriting_take</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
  <span class="c1"># Computes arr[idx].</span>
  <span class="c1"># All supported cases of indexing can be implemented as an XLA gather,</span>
  <span class="c1"># followed by an optional reverse and a reshape.</span>
  <span class="n">arr</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
  <span class="n">treedef</span><span class="p">,</span> <span class="n">static_idx</span><span class="p">,</span> <span class="n">dynamic_idx</span> <span class="o">=</span> <span class="n">_split_index_for_jit</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">_gather</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">treedef</span><span class="p">,</span> <span class="n">static_idx</span><span class="p">,</span> <span class="n">dynamic_idx</span><span class="p">)</span>

<span class="c1"># TODO(phawkins): re-enable jit after fixing excessive recompilation for</span>
<span class="c1"># slice indexes (e.g., slice(0, 5, None), slice(10, 15, None), etc.).</span>
<span class="c1"># @partial(jit, static_argnums=(1, 2))</span>
<span class="k">def</span> <span class="nf">_gather</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">treedef</span><span class="p">,</span> <span class="n">static_idx</span><span class="p">,</span> <span class="n">dynamic_idx</span><span class="p">):</span>
  <span class="n">idx</span> <span class="o">=</span> <span class="n">_merge_static_and_dynamic_indices</span><span class="p">(</span><span class="n">treedef</span><span class="p">,</span> <span class="n">static_idx</span><span class="p">,</span> <span class="n">dynamic_idx</span><span class="p">)</span>
  <span class="n">indexer</span> <span class="o">=</span> <span class="n">_index_to_gather</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span> <span class="n">idx</span><span class="p">)</span>  <span class="c1"># shared with _scatter_update</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">arr</span>

  <span class="c1"># Avoid calling gather if the slice shape is empty, both as a fast path and to</span>
  <span class="c1"># handle cases like zeros(0)[array([], int32)].</span>
  <span class="k">if</span> <span class="n">_prod</span><span class="p">(</span><span class="n">indexer</span><span class="o">.</span><span class="n">slice_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">zeros</span><span class="p">(</span><span class="n">indexer</span><span class="o">.</span><span class="n">slice_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

  <span class="c1"># We avoid generating a gather when indexer.gather_indices.size is empty.</span>
  <span class="k">if</span> <span class="n">indexer</span><span class="o">.</span><span class="n">gather_indices</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">indexer</span><span class="o">.</span><span class="n">gather_indices</span><span class="p">,</span> <span class="n">indexer</span><span class="o">.</span><span class="n">dnums</span><span class="p">,</span>
                   <span class="n">indexer</span><span class="o">.</span><span class="n">gather_slice_shape</span><span class="p">)</span>

  <span class="c1"># Reverses axes with negative strides.</span>
  <span class="k">if</span> <span class="n">indexer</span><span class="o">.</span><span class="n">reversed_y_dims</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">rev</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">indexer</span><span class="o">.</span><span class="n">reversed_y_dims</span><span class="p">)</span>

  <span class="c1"># This adds np.newaxis/None dimensions.</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">indexer</span><span class="o">.</span><span class="n">slice_shape</span><span class="p">)</span>

<span class="n">_Indexer</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;_Indexer&quot;</span><span class="p">,</span> <span class="p">[</span>
  <span class="c1"># The expected shape of the slice output.</span>
  <span class="s2">&quot;slice_shape&quot;</span><span class="p">,</span>

  <span class="c1"># The slice shape to pass to lax.gather().</span>
  <span class="s2">&quot;gather_slice_shape&quot;</span><span class="p">,</span>

  <span class="c1"># The gather indices to use.</span>
  <span class="s2">&quot;gather_indices&quot;</span><span class="p">,</span>

  <span class="c1"># A GatherDimensionNumbers object describing the gather to perform.</span>
  <span class="s2">&quot;dnums&quot;</span><span class="p">,</span>

  <span class="c1"># Slice dimensions that have negative strides, and so must be reversed after</span>
  <span class="c1"># the gather.</span>
  <span class="s2">&quot;reversed_y_dims&quot;</span><span class="p">,</span>

  <span class="c1"># For scatters, we must eliminate any axes created by `newaxis`, which</span>
  <span class="c1"># are the following dimensions, which must be of size 1. For gathers, we</span>
  <span class="c1"># simply reshape to `slice_shape` to introduce the new axes.</span>
  <span class="s2">&quot;newaxis_dims&quot;</span><span class="p">,</span>
<span class="p">])</span>

<span class="k">def</span> <span class="nf">_split_index_for_jit</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Splits indices into necessarily-static and dynamic parts.</span>

<span class="sd">  Used to pass indices into `jit`-ted function.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1"># Convert list indices to tuples in cases (deprecated by NumPy.)</span>
  <span class="n">idx</span> <span class="o">=</span> <span class="n">_eliminate_deprecated_list_indexing</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

  <span class="c1"># Expand any (concrete) boolean indices. We can then use advanced integer</span>
  <span class="c1"># indexing logic to handle them.</span>
  <span class="n">idx</span> <span class="o">=</span> <span class="n">_expand_bool_indices</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

  <span class="n">leaves</span><span class="p">,</span> <span class="n">treedef</span> <span class="o">=</span> <span class="n">pytree</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
  <span class="n">dynamic</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">leaves</span><span class="p">)</span>
  <span class="n">static</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">leaves</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">leaves</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">Ellipsis</span><span class="p">:</span>
      <span class="n">static</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
      <span class="c1"># slice objects aren&#39;t hashable.</span>
      <span class="n">static</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">dynamic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
  <span class="k">return</span> <span class="n">treedef</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">static</span><span class="p">),</span> <span class="n">dynamic</span>

<span class="k">def</span> <span class="nf">_merge_static_and_dynamic_indices</span><span class="p">(</span><span class="n">treedef</span><span class="p">,</span> <span class="n">static_idx</span><span class="p">,</span> <span class="n">dynamic_idx</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Recombines indices that were split by _split_index_for_jit.&quot;&quot;&quot;</span>
  <span class="n">idx</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">static_idx</span><span class="p">,</span> <span class="n">dynamic_idx</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
      <span class="n">idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">treedef</span><span class="o">.</span><span class="n">unflatten</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_int</span><span class="p">(</span><span class="n">aval</span><span class="p">):</span>
  <span class="k">return</span> <span class="ow">not</span> <span class="n">aval</span><span class="o">.</span><span class="n">shape</span> <span class="ow">and</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">aval</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">integer</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_index_to_gather</span><span class="p">(</span><span class="n">x_shape</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
  <span class="c1"># Remove ellipses and add trailing slice(None)s.</span>
  <span class="n">idx</span> <span class="o">=</span> <span class="n">_canonicalize_tuple_index</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_shape</span><span class="p">),</span> <span class="n">idx</span><span class="p">)</span>

  <span class="c1"># Check for advanced indexing:</span>
  <span class="c1"># https://docs.scipy.org/doc/numpy/reference/arrays.indexing.html#advanced-indexing</span>

  <span class="c1"># Do the advanced indexing axes appear contiguously? If not, NumPy semantics</span>
  <span class="c1"># move the advanced axes to the front.</span>
  <span class="n">advanced_axes_are_contiguous</span> <span class="o">=</span> <span class="kc">False</span>

  <span class="n">advanced_indexes</span> <span class="o">=</span> <span class="kc">None</span>

  <span class="c1"># The positions of the advanced indexing axes in `idx`.</span>
  <span class="n">idx_advanced_axes</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="c1"># The positions of the advanced indexes in x&#39;s shape.</span>
  <span class="c1"># collapsed, after None axes have been removed. See below.</span>
  <span class="n">x_advanced_axes</span> <span class="o">=</span> <span class="kc">None</span>

  <span class="k">if</span> <span class="n">_is_advanced_int_indexer</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">idx_no_nones</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">advanced_pairs</span> <span class="o">=</span> <span class="p">(</span>
      <span class="p">(</span><span class="n">asarray</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx_no_nones</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">)))</span>
    <span class="n">advanced_pairs</span> <span class="o">=</span> <span class="p">((</span><span class="n">_normalize_index</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">x_shape</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">advanced_pairs</span><span class="p">)</span>
    <span class="n">advanced_indexes</span><span class="p">,</span> <span class="n">idx_advanced_axes</span><span class="p">,</span> <span class="n">x_advanced_axes</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">advanced_pairs</span><span class="p">)</span>
    <span class="n">advanced_axes_are_contiguous</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">idx_advanced_axes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

  <span class="n">x_axis</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Current axis in x.</span>
  <span class="n">y_axis</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Current axis in y, before collapsing. See below.</span>
  <span class="n">collapsed_y_axis</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Current axis in y, after collapsing.</span>

  <span class="c1"># Scatter dimension numbers.</span>
  <span class="n">offset_dims</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">collapsed_slice_dims</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">start_index_map</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="n">gather_indices</span> <span class="o">=</span> <span class="n">onp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">int32</span><span class="p">)</span>  <span class="c1"># use onp to save a compilation</span>

  <span class="c1"># We perform three transformations to y before the scatter op, in order:</span>
  <span class="c1"># First, y is broadcast to slice_shape. In general `y` only need broadcast to</span>
  <span class="c1"># the right shape.</span>
  <span class="n">slice_shape</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="c1"># Next, y is squeezed to remove newaxis_dims. This removes np.newaxis/`None`</span>
  <span class="c1"># indices, which the scatter cannot remove itself.</span>
  <span class="n">newaxis_dims</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="c1"># Finally, we reverse reversed_y_dims to handle slices with negative strides.</span>
  <span class="n">reversed_y_dims</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="n">gather_slice_shape</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">for</span> <span class="n">idx_pos</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="c1"># Handle the advanced indices here if:</span>
    <span class="c1"># * the advanced indices were not contiguous and we are the start.</span>
    <span class="c1"># * we are at the position of the first advanced index.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">advanced_indexes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
        <span class="p">(</span><span class="n">advanced_axes_are_contiguous</span> <span class="ow">and</span> <span class="n">idx_pos</span> <span class="o">==</span> <span class="n">idx_advanced_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span>
         <span class="ow">not</span> <span class="n">advanced_axes_are_contiguous</span> <span class="ow">and</span> <span class="n">idx_pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)):</span>
      <span class="n">advanced_indexes</span> <span class="o">=</span> <span class="n">broadcast_arrays</span><span class="p">(</span><span class="o">*</span><span class="n">advanced_indexes</span><span class="p">)</span>
      <span class="n">shape</span> <span class="o">=</span> <span class="n">advanced_indexes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
      <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
      <span class="n">advanced_indexes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)),</span> <span class="n">int32</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">advanced_indexes</span><span class="p">]</span>

      <span class="c1"># Broadcast gather_indices from [..., k] to [..., 1, 1, ..., 1, k].</span>
      <span class="n">gather_indices</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">broadcast_in_dim</span><span class="p">(</span>
        <span class="n">gather_indices</span><span class="p">,</span> <span class="n">onp</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">gather_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">),</span>
        <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">gather_indices</span><span class="o">.</span><span class="n">ndim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">gather_indices</span><span class="o">.</span><span class="n">ndim</span> <span class="o">+</span> <span class="n">ndim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,))</span>
      <span class="n">gather_indices</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">([</span><span class="n">gather_indices</span><span class="p">]</span> <span class="o">+</span> <span class="n">advanced_indexes</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">start_index_map</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x_advanced_axes</span><span class="p">)</span>
      <span class="n">collapsed_slice_dims</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x_advanced_axes</span><span class="p">)</span>
      <span class="n">slice_shape</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
      <span class="n">y_axis</span> <span class="o">+=</span> <span class="n">ndim</span>
      <span class="n">collapsed_y_axis</span> <span class="o">+=</span> <span class="n">ndim</span>

    <span class="c1"># Per-index bookkeeping for advanced indexes.</span>
    <span class="k">if</span> <span class="n">idx_pos</span> <span class="ow">in</span> <span class="n">idx_advanced_axes</span><span class="p">:</span>
      <span class="n">x_axis</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">gather_slice_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">continue</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">abstract_i</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_aval</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
      <span class="n">abstract_i</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Handle basic int indexes.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">abstract_i</span><span class="p">,</span> <span class="n">ConcreteArray</span><span class="p">)</span> <span class="ow">or</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">abstract_i</span><span class="p">,</span> <span class="n">ShapedArray</span><span class="p">))</span> <span class="ow">and</span> <span class="n">_int</span><span class="p">(</span><span class="n">abstract_i</span><span class="p">):</span>
      <span class="n">i</span> <span class="o">=</span> <span class="n">_normalize_index</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x_shape</span><span class="p">[</span><span class="n">x_axis</span><span class="p">])</span>
      <span class="n">i</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">int32</span><span class="p">)</span>
      <span class="n">i</span> <span class="o">=</span> <span class="n">broadcast_to</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">gather_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
      <span class="n">gather_indices</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">((</span><span class="n">gather_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">collapsed_slice_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_axis</span><span class="p">)</span>
      <span class="n">gather_slice_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">start_index_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_axis</span><span class="p">)</span>
      <span class="n">x_axis</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># Handle np.newaxis (None)</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">slice_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">newaxis_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_axis</span><span class="p">)</span>
      <span class="n">y_axis</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># Handle slice(None)</span>
    <span class="k">elif</span> <span class="n">_is_slice_none</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
      <span class="n">slice_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_shape</span><span class="p">[</span><span class="n">x_axis</span><span class="p">])</span>
      <span class="n">gather_slice_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_shape</span><span class="p">[</span><span class="n">x_axis</span><span class="p">])</span>
      <span class="n">offset_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collapsed_y_axis</span><span class="p">)</span>
      <span class="n">collapsed_y_axis</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">y_axis</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">x_axis</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># Handle slice index (only static, otherwise an error is raised)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">_all</span><span class="p">(</span><span class="n">elt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_aval</span><span class="p">(</span><span class="n">elt</span><span class="p">))</span> <span class="ow">is</span> <span class="n">ConcreteArray</span>
                  <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">step</span><span class="p">)):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Array slice indices must have static start/stop/step to be used &quot;</span>
               <span class="s2">&quot;with Numpy indexing syntax. Try lax.dynamic_slice/&quot;</span>
               <span class="s2">&quot;dynamic_update_slice instead.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
      <span class="n">start</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">needs_rev</span> <span class="o">=</span> <span class="n">_static_idx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x_shape</span><span class="p">[</span><span class="n">x_axis</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">needs_rev</span><span class="p">:</span>
        <span class="n">reversed_y_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collapsed_y_axis</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">stride</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">int32</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">broadcast_to</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">gather_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
        <span class="n">gather_indices</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">((</span><span class="n">gather_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">slice_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">limit</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
        <span class="n">gather_slice_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">limit</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
        <span class="n">offset_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collapsed_y_axis</span><span class="p">)</span>
        <span class="n">start_index_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_axis</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">slice_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="n">gather_slice_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">gather_indices_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">gather_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">size</span><span class="p">,)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">broadcast_in_dim</span><span class="p">(</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">gather_indices_shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span>
            <span class="n">broadcast_dimensions</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gather_indices_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,))</span>
        <span class="n">gather_indices</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">broadcast_in_dim</span><span class="p">(</span>
            <span class="n">gather_indices</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="n">gather_indices_shape</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start_index_map</span><span class="p">),),</span>
            <span class="n">broadcast_dimensions</span><span class="o">=</span><span class="p">(</span>
              <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gather_indices_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
              <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gather_indices_shape</span><span class="p">),)))</span>
        <span class="n">gather_indices</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">(</span>
          <span class="p">(</span><span class="n">gather_indices</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">gather_indices_shape</span><span class="p">))</span>
        <span class="n">start_index_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_axis</span><span class="p">)</span>
        <span class="n">collapsed_slice_dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_axis</span><span class="p">)</span>

      <span class="n">collapsed_y_axis</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">y_axis</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">x_axis</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">abstract_i</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">abstract_i</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">integer</span><span class="p">)</span> <span class="ow">or</span>
                             <span class="n">issubdtype</span><span class="p">(</span><span class="n">abstract_i</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">bool_</span><span class="p">)):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Indexer must have integer or boolean type, got indexer &quot;</span>
               <span class="s2">&quot;with type </span><span class="si">{}</span><span class="s2"> at position </span><span class="si">{}</span><span class="s2">, indexer value </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">abstract_i</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">idx_pos</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>

      <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Indexing mode not yet supported. Open a feature request!</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span>
      <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

  <span class="n">dnums</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">GatherDimensionNumbers</span><span class="p">(</span>
    <span class="n">offset_dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">offset_dims</span><span class="p">),</span>
    <span class="n">collapsed_slice_dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">collapsed_slice_dims</span><span class="p">)),</span>
    <span class="n">start_index_map</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">start_index_map</span><span class="p">)</span>
  <span class="p">)</span>
  <span class="k">return</span> <span class="n">_Indexer</span><span class="p">(</span>
    <span class="n">slice_shape</span><span class="o">=</span><span class="n">slice_shape</span><span class="p">,</span>
    <span class="n">newaxis_dims</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">newaxis_dims</span><span class="p">),</span>
    <span class="n">gather_slice_shape</span><span class="o">=</span><span class="n">gather_slice_shape</span><span class="p">,</span>
    <span class="n">reversed_y_dims</span><span class="o">=</span><span class="n">reversed_y_dims</span><span class="p">,</span>
    <span class="n">dnums</span><span class="o">=</span><span class="n">dnums</span><span class="p">,</span>
    <span class="n">gather_indices</span><span class="o">=</span><span class="n">gather_indices</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_should_unpack_list_index</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Helper for _eliminate_deprecated_list_indexing.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">onp</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
          <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span>
          <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">Ellipsis</span> <span class="ow">or</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_eliminate_deprecated_list_indexing</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
  <span class="c1"># &quot;Basic slicing is initiated if the selection object is a non-array,</span>
  <span class="c1"># non-tuple sequence containing slice objects, [Ellipses, or newaxis</span>
  <span class="c1"># objects]&quot;. Detects this case and canonicalizes to a tuple. This case is</span>
  <span class="c1"># deprecated by NumPy and exists for backward compatibility.</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">_any</span><span class="p">(</span><span class="n">_should_unpack_list_index</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span><span class="p">,)</span>
  <span class="k">return</span> <span class="n">idx</span>

<span class="k">def</span> <span class="nf">_expand_bool_indices</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Converts concrete bool indexes into advanced integer indexes.&quot;&quot;&quot;</span>
  <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">abstract_i</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_aval</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
      <span class="n">abstract_i</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">abstract_i</span><span class="p">,</span> <span class="n">ShapedArray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">abstract_i</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">bool_</span><span class="p">)</span>
          <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_all</span><span class="p">(</span><span class="ow">not</span> <span class="n">_shape</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">and</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">bool_</span><span class="p">)</span>
                                          <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">i</span><span class="p">)):</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">abstract_i</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_aval</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">abstract_i</span><span class="p">)</span> <span class="ow">is</span> <span class="n">ConcreteArray</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Array boolean indices must be static (e.g. no dependence on an &quot;</span>
               <span class="s2">&quot;argument to a jit or vmap function).&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_is_slice_none</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Return True if idx is equal to slice(None), False otherwise.&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">idx</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">idx</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">idx</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span>

<span class="c1"># TODO(mattjj): clean up this logic</span>
<span class="k">def</span> <span class="nf">_is_advanced_int_indexer</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns True if idx should trigger int array indexing, False otherwise.&quot;&quot;&quot;</span>
  <span class="c1"># https://docs.scipy.org/doc/numpy/reference/arrays.indexing.html#advanced-indexing</span>
  <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">_all</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">False</span>
  <span class="k">return</span> <span class="n">_all</span><span class="p">(</span><span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">e</span> <span class="ow">is</span> <span class="bp">Ellipsis</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span>
              <span class="ow">or</span> <span class="n">_is_int_arraylike</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_is_int_arraylike</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns True if x is array-like with integer dtype, False otherwise.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
          <span class="ow">or</span> <span class="n">issubdtype</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">onp</span><span class="o">.</span><span class="n">integer</span><span class="p">)</span>
          <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="n">_all</span><span class="p">(</span><span class="n">_is_int_arraylike</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">x</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_canonicalize_tuple_index</span><span class="p">(</span><span class="n">arr_ndim</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Helper to remove Ellipsis and add in the implicit trailing slice(None).&quot;&quot;&quot;</span>
  <span class="n">len_without_none</span> <span class="o">=</span> <span class="n">_sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">idx</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">Ellipsis</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">len_without_none</span> <span class="o">&gt;</span> <span class="n">arr_ndim</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Too many indices for array: </span><span class="si">{}</span><span class="s2"> non-None/Ellipsis indices for dim </span><span class="si">{}</span><span class="s2">.&quot;</span>
    <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">len_without_none</span><span class="p">,</span> <span class="n">arr_ndim</span><span class="p">))</span>
  <span class="n">ellipses</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">elt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="k">if</span> <span class="n">elt</span> <span class="ow">is</span> <span class="bp">Ellipsis</span><span class="p">)</span>
  <span class="n">ellipsis_index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ellipses</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">ellipsis_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">next</span><span class="p">(</span><span class="n">ellipses</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Multiple ellipses (...) not supported: </span><span class="si">{}</span><span class="s2">.&quot;</span>
      <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">idx</span><span class="p">))))</span>
    <span class="n">colons</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">*</span> <span class="p">(</span><span class="n">arr_ndim</span> <span class="o">-</span> <span class="n">len_without_none</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[:</span><span class="n">ellipsis_index</span><span class="p">]</span> <span class="o">+</span> <span class="n">colons</span> <span class="o">+</span> <span class="n">idx</span><span class="p">[</span><span class="n">ellipsis_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
  <span class="k">elif</span> <span class="n">len_without_none</span> <span class="o">&lt;</span> <span class="n">arr_ndim</span><span class="p">:</span>
    <span class="n">colons</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">*</span> <span class="p">(</span><span class="n">arr_ndim</span> <span class="o">-</span> <span class="n">len_without_none</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">+</span> <span class="n">colons</span>
  <span class="k">return</span> <span class="n">idx</span>


<span class="k">def</span> <span class="nf">_static_idx</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Helper function to compute the static slice start/limit/stride values.&quot;&quot;&quot;</span>
  <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span>
  <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">stop</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">stop</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span>  <span class="c1"># sliced to size zero</span>

  <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="kc">False</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">k</span>  <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">-</span> <span class="n">stop</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="n">step</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stop</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">step</span><span class="p">,</span> <span class="kc">True</span>


<span class="n">blackman</span> <span class="o">=</span> <span class="n">_wrap_numpy_nullary_function</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">blackman</span><span class="p">)</span>
<span class="n">bartlett</span> <span class="o">=</span> <span class="n">_wrap_numpy_nullary_function</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">bartlett</span><span class="p">)</span>
<span class="n">hamming</span> <span class="o">=</span> <span class="n">_wrap_numpy_nullary_function</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">hamming</span><span class="p">)</span>
<span class="n">hanning</span> <span class="o">=</span> <span class="n">_wrap_numpy_nullary_function</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">hanning</span><span class="p">)</span>
<span class="c1"># TODO: lower `kaiser` via lax to allow non-constant beta values.</span>
<span class="n">kaiser</span> <span class="o">=</span> <span class="n">_wrap_numpy_nullary_function</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">kaiser</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_gcd_cond_fn</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
  <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">xs</span>
  <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">x2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_gcd_body_fn</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
  <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">xs</span>
  <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="p">(</span><span class="n">where</span><span class="p">(</span><span class="n">x2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x1</span><span class="p">),</span>
            <span class="n">where</span><span class="p">(</span><span class="n">x2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">rem</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">where</span><span class="p">(</span><span class="n">x1</span> <span class="o">&lt;</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x1</span><span class="p">),</span> <span class="n">where</span><span class="p">(</span><span class="n">x1</span> <span class="o">&lt;</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>

<div class="viewcode-block" id="gcd"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.gcd">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">onp</span><span class="p">,</span> <span class="s2">&quot;gcd&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">gcd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
  <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="n">integer</span><span class="p">)</span> <span class="ow">or</span>
      <span class="ow">not</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">_dtype</span><span class="p">(</span><span class="n">x2</span><span class="p">),</span> <span class="n">integer</span><span class="p">)):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Arguments to gcd must be integers.&quot;</span><span class="p">)</span>
  <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_promote_dtypes</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x2</span><span class="p">))</span>
  <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">broadcast_arrays</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="n">gcd</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span><span class="n">_gcd_cond_fn</span><span class="p">,</span> <span class="n">_gcd_body_fn</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">gcd</span></div>


<div class="viewcode-block" id="lcm"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.lcm">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">onp</span><span class="p">,</span> <span class="s2">&quot;lcm&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">lcm</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
  <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_promote_dtypes</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">where</span><span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
               <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">multiply</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)),</span> <span class="n">d</span><span class="p">))</span></div>

<div class="viewcode-block" id="cov"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.cov">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">cov</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">cov</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fweights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">aweights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;jax.numpy.cov not implemented for nontrivial </span><span class="si">{}</span><span class="s2">. &quot;</span>
         <span class="s2">&quot;Open a feature request at https://github.com/google/jax/issues !&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">))</span>
  <span class="c1"># These next two are actually implemented, just not tested.</span>
  <span class="k">if</span> <span class="n">fweights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;fweights&#39;</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">aweights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;aweights&#39;</span><span class="p">))</span>

  <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;m has more than 2 dimensions&quot;</span><span class="p">)</span>  <span class="c1"># same as numpy error</span>
  <span class="n">X</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="o">.</span><span class="n">canonicalize_dtype</span><span class="p">(</span><span class="n">result_type</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">float_</span><span class="p">)))</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">rowvar</span> <span class="ow">and</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span>
  <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">onp</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">ddof</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ddof</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">bias</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

  <span class="n">w</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="k">if</span> <span class="n">fweights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">onp</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">fweights</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;cannot handle multidimensional fweights&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">onp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">fweights</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;incompatible numbers of samples and fweights&quot;</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">fweights</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">aweights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">onp</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">aweights</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;cannot handle multidimensional aweights&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">onp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">aweights</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;incompatible numbers of samples and aweights&quot;</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">aweights</span> <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">w</span> <span class="o">*</span> <span class="n">aweights</span>

  <span class="n">avg</span><span class="p">,</span> <span class="n">w_sum</span> <span class="o">=</span> <span class="n">average</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">returned</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">w_sum</span> <span class="o">=</span> <span class="n">w_sum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

  <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ddof</span>
  <span class="k">elif</span> <span class="n">ddof</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">w_sum</span>
  <span class="k">elif</span> <span class="n">aweights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">w_sum</span> <span class="o">-</span> <span class="n">ddof</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">w_sum</span> <span class="o">-</span> <span class="n">ddof</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">aweights</span><span class="p">)</span> <span class="o">/</span> <span class="n">w_sum</span>

  <span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">-</span> <span class="n">avg</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
  <span class="n">X_T</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">X</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
  <span class="k">return</span> <span class="n">true_divide</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">X_T</span><span class="o">.</span><span class="n">conj</span><span class="p">()),</span> <span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span></div>


<div class="viewcode-block" id="corrcoef"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.corrcoef">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">corrcoef</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">c</span> <span class="o">=</span> <span class="n">cov</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rowvar</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="c1"># scalar - this should yield nan for values (nan/nan, inf/inf, 0/0), 1 otherwise</span>
      <span class="k">return</span> <span class="n">divide</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">=</span> <span class="n">diag</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
  <span class="n">stddev</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">real</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
  <span class="n">c</span> <span class="o">=</span> <span class="n">divide</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">stddev</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span>
  <span class="n">c</span> <span class="o">=</span> <span class="n">divide</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">stddev</span><span class="p">[</span><span class="kc">None</span><span class="p">,:])</span>

  <span class="n">real_part</span> <span class="o">=</span> <span class="n">clip</span><span class="p">(</span><span class="n">real</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">iscomplexobj</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
      <span class="n">complex_part</span> <span class="o">=</span> <span class="n">clip</span><span class="p">(</span><span class="n">imag</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">c</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">complex</span><span class="p">(</span><span class="n">real_part</span><span class="p">,</span> <span class="n">complex_part</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
      <span class="n">c</span> <span class="o">=</span> <span class="n">real_part</span>
  <span class="k">return</span> <span class="n">c</span></div>


<div class="viewcode-block" id="quantile"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.quantile">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">onp</span><span class="p">,</span> <span class="s2">&quot;quantile&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">quantile</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite_input</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">overwrite_input</span> <span class="ow">or</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;jax.numpy.quantile does not support overwrite_input=True or &quot;</span>
           <span class="s2">&quot;out != None&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">interpolation</span> <span class="o">!=</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only interpolation=&#39;linear&#39; is implemented&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">_quantile</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">keepdims</span><span class="p">)</span></div>

<span class="nd">@partial</span><span class="p">(</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">_quantile</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">keepdims</span><span class="p">):</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">ravel</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Tuple values for axis are not implemented&quot;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">_canonicalize_axis</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

  <span class="n">q_ndim</span> <span class="o">=</span> <span class="n">ndim</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">q_ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;q must be have rank &lt;= 1, got shape </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">q</span><span class="p">)))</span>

  <span class="n">q</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">floating</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">issubdtype</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">floating</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;q and a arguments to quantile must be of float type, got </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">&quot;</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>

  <span class="c1"># Promote q to at least float32 for precise interpolation.</span>
  <span class="n">q</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">promote_types</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">float32</span><span class="p">))</span>

  <span class="n">a_shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

  <span class="n">n</span> <span class="o">=</span> <span class="n">a_shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
  <span class="n">q</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
  <span class="n">low</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
  <span class="n">high</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
  <span class="n">high_weight</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">low</span><span class="p">)</span>
  <span class="n">low_weight</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_constant_like</span><span class="p">(</span><span class="n">high_weight</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">high_weight</span><span class="p">)</span>

  <span class="n">low</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">_constant_like</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">low</span><span class="p">,</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
  <span class="n">high</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">_constant_like</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">high</span><span class="p">,</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
  <span class="n">low</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">int64</span><span class="p">)</span>
  <span class="n">high</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">int64</span><span class="p">)</span>

  <span class="n">slice_sizes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">a_shape</span><span class="p">)</span>
  <span class="n">slice_sizes</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="n">dnums</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">GatherDimensionNumbers</span><span class="p">(</span>
    <span class="n">offset_dims</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span>
      <span class="n">q_ndim</span><span class="p">,</span>
      <span class="nb">len</span><span class="p">(</span><span class="n">a_shape</span><span class="p">)</span> <span class="o">+</span> <span class="n">q_ndim</span> <span class="k">if</span> <span class="n">keepdims</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_shape</span><span class="p">)</span> <span class="o">+</span> <span class="n">q_ndim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
    <span class="n">collapsed_slice_dims</span><span class="o">=</span><span class="p">()</span> <span class="k">if</span> <span class="n">keepdims</span> <span class="k">else</span> <span class="p">(</span><span class="n">axis</span><span class="p">,),</span>
    <span class="n">start_index_map</span><span class="o">=</span><span class="p">(</span><span class="n">axis</span><span class="p">,))</span>
  <span class="n">low</span> <span class="o">=</span> <span class="n">low</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
  <span class="n">high</span> <span class="o">=</span> <span class="n">high</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
  <span class="n">low_value</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">dimension_numbers</span><span class="o">=</span><span class="n">dnums</span><span class="p">,</span>
                         <span class="n">slice_sizes</span><span class="o">=</span><span class="n">slice_sizes</span><span class="p">)</span>
  <span class="n">high_value</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">dimension_numbers</span><span class="o">=</span><span class="n">dnums</span><span class="p">,</span>
                          <span class="n">slice_sizes</span><span class="o">=</span><span class="n">slice_sizes</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">q_ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">low_weight</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">broadcast_in_dim</span><span class="p">(</span><span class="n">low_weight</span><span class="p">,</span> <span class="n">low_value</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                      <span class="n">broadcast_dimensions</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="n">high_weight</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">broadcast_in_dim</span><span class="p">(</span><span class="n">high_weight</span><span class="p">,</span> <span class="n">high_value</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                      <span class="n">broadcast_dimensions</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span>
    <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">low_value</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">low_weight</span><span class="p">),</span>
            <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">high_value</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">high_weight</span><span class="p">)),</span> <span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>


<div class="viewcode-block" id="percentile"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.percentile">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">percentile</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">percentile</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite_input</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="n">q</span> <span class="o">=</span> <span class="n">true_divide</span><span class="p">(</span><span class="n">asarray</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">float32</span><span class="p">(</span><span class="mf">100.0</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">quantile</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">overwrite_input</span><span class="o">=</span><span class="n">overwrite_input</span><span class="p">,</span>
                  <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="n">keepdims</span><span class="p">)</span></div>


<div class="viewcode-block" id="median"><a class="viewcode-back" href="../../../modules/tensor.html#symjax.tensor.median">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">onp</span><span class="o">.</span><span class="n">median</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">median</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite_input</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">q</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">quantile</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">overwrite_input</span><span class="o">=</span><span class="n">overwrite_input</span><span class="p">,</span>
                    <span class="n">keepdims</span><span class="o">=</span><span class="n">keepdims</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_astype</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
  <span class="n">lax</span><span class="o">.</span><span class="n">_check_user_dtype_supported</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;astype&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>

<span class="c1">### track unimplemented functions</span>

<span class="k">def</span> <span class="nf">_not_implemented</span><span class="p">(</span><span class="n">fun</span><span class="p">):</span>
  <span class="nd">@_wraps</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Numpy function </span><span class="si">{}</span><span class="s2"> not yet implemented&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fun</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">wrapped</span>

<span class="c1"># Build a set of all unimplemented NumPy functions.</span>
<span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">get_module_functions</span><span class="p">(</span><span class="n">onp</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">_not_implemented</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>


<span class="c1">### add method and operator overloads to arraylike classes</span>

<span class="c1"># We add operator overloads to DeviceArray and ShapedArray. These method and</span>
<span class="c1"># operator overloads mainly just forward calls to the corresponding lax_numpy</span>
<span class="c1"># functions, which can themselves handle instances from any of these classes.</span>


<span class="k">def</span> <span class="nf">_swap_args</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
  <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_unimplemented_setitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; object does not support item assignment. JAX arrays are &quot;</span>
         <span class="s2">&quot;immutable; perhaps you want jax.ops.index_update or &quot;</span>
         <span class="s2">&quot;jax.ops.index_add instead?&quot;</span><span class="p">)</span>
  <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">_operator_round</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">ndigits</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">out</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">ndigits</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
  <span class="c1"># If `ndigits` is None, for a builtin float round(7.5) returns an integer.</span>
  <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">int_</span><span class="p">)</span> <span class="k">if</span> <span class="n">ndigits</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out</span>

<span class="n">_operators</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;getitem&quot;</span><span class="p">:</span> <span class="n">_rewriting_take</span><span class="p">,</span>
    <span class="s2">&quot;setitem&quot;</span><span class="p">:</span> <span class="n">_unimplemented_setitem</span><span class="p">,</span>
    <span class="s2">&quot;neg&quot;</span><span class="p">:</span> <span class="n">negative</span><span class="p">,</span>
    <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="n">positive</span><span class="p">,</span>
    <span class="s2">&quot;eq&quot;</span><span class="p">:</span> <span class="n">equal</span><span class="p">,</span>
    <span class="s2">&quot;ne&quot;</span><span class="p">:</span> <span class="n">not_equal</span><span class="p">,</span>
    <span class="s2">&quot;lt&quot;</span><span class="p">:</span> <span class="n">less</span><span class="p">,</span>
    <span class="s2">&quot;le&quot;</span><span class="p">:</span> <span class="n">less_equal</span><span class="p">,</span>
    <span class="s2">&quot;gt&quot;</span><span class="p">:</span> <span class="n">greater</span><span class="p">,</span>
    <span class="s2">&quot;ge&quot;</span><span class="p">:</span> <span class="n">greater_equal</span><span class="p">,</span>
    <span class="s2">&quot;abs&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">,</span>
    <span class="s2">&quot;add&quot;</span><span class="p">:</span> <span class="n">add</span><span class="p">,</span>
    <span class="s2">&quot;radd&quot;</span><span class="p">:</span> <span class="n">add</span><span class="p">,</span>
    <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">subtract</span><span class="p">,</span>
    <span class="s2">&quot;rsub&quot;</span><span class="p">:</span> <span class="n">_swap_args</span><span class="p">(</span><span class="n">subtract</span><span class="p">),</span>
    <span class="s2">&quot;mul&quot;</span><span class="p">:</span> <span class="n">multiply</span><span class="p">,</span>
    <span class="s2">&quot;rmul&quot;</span><span class="p">:</span> <span class="n">multiply</span><span class="p">,</span>
    <span class="s2">&quot;div&quot;</span><span class="p">:</span> <span class="n">divide</span><span class="p">,</span>
    <span class="s2">&quot;rdiv&quot;</span><span class="p">:</span> <span class="n">_swap_args</span><span class="p">(</span><span class="n">divide</span><span class="p">),</span>
    <span class="s2">&quot;truediv&quot;</span><span class="p">:</span> <span class="n">true_divide</span><span class="p">,</span>
    <span class="s2">&quot;rtruediv&quot;</span><span class="p">:</span> <span class="n">_swap_args</span><span class="p">(</span><span class="n">true_divide</span><span class="p">),</span>
    <span class="s2">&quot;floordiv&quot;</span><span class="p">:</span> <span class="n">floor_divide</span><span class="p">,</span>
    <span class="s2">&quot;rfloordiv&quot;</span><span class="p">:</span> <span class="n">_swap_args</span><span class="p">(</span><span class="n">floor_divide</span><span class="p">),</span>
    <span class="s2">&quot;divmod&quot;</span><span class="p">:</span> <span class="nb">divmod</span><span class="p">,</span>
    <span class="s2">&quot;rdivmod&quot;</span><span class="p">:</span> <span class="n">_swap_args</span><span class="p">(</span><span class="nb">divmod</span><span class="p">),</span>
    <span class="s2">&quot;mod&quot;</span><span class="p">:</span> <span class="n">mod</span><span class="p">,</span>
    <span class="s2">&quot;rmod&quot;</span><span class="p">:</span> <span class="n">_swap_args</span><span class="p">(</span><span class="n">mod</span><span class="p">),</span>
    <span class="s2">&quot;pow&quot;</span><span class="p">:</span> <span class="n">power</span><span class="p">,</span>
    <span class="s2">&quot;rpow&quot;</span><span class="p">:</span> <span class="n">_swap_args</span><span class="p">(</span><span class="n">power</span><span class="p">),</span>
    <span class="s2">&quot;matmul&quot;</span><span class="p">:</span> <span class="n">matmul</span><span class="p">,</span>
    <span class="s2">&quot;rmatmul&quot;</span><span class="p">:</span> <span class="n">_swap_args</span><span class="p">(</span><span class="n">matmul</span><span class="p">),</span>
    <span class="s2">&quot;and&quot;</span><span class="p">:</span> <span class="n">bitwise_and</span><span class="p">,</span>
    <span class="s2">&quot;rand&quot;</span><span class="p">:</span> <span class="n">bitwise_and</span><span class="p">,</span>
    <span class="s2">&quot;or&quot;</span><span class="p">:</span> <span class="n">bitwise_or</span><span class="p">,</span>
    <span class="s2">&quot;ror&quot;</span><span class="p">:</span> <span class="n">bitwise_or</span><span class="p">,</span>
    <span class="s2">&quot;xor&quot;</span><span class="p">:</span> <span class="n">bitwise_xor</span><span class="p">,</span>
    <span class="s2">&quot;rxor&quot;</span><span class="p">:</span> <span class="n">bitwise_xor</span><span class="p">,</span>
    <span class="s2">&quot;invert&quot;</span><span class="p">:</span> <span class="n">bitwise_not</span><span class="p">,</span>
    <span class="s2">&quot;lshift&quot;</span><span class="p">:</span> <span class="n">left_shift</span><span class="p">,</span>
    <span class="s2">&quot;rshift&quot;</span><span class="p">:</span> <span class="n">right_shift</span><span class="p">,</span>
    <span class="s2">&quot;round&quot;</span><span class="p">:</span> <span class="n">_operator_round</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># These numpy.ndarray methods are just refs to an equivalent numpy function</span>
<span class="n">_nondiff_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;any&quot;</span><span class="p">,</span> <span class="s2">&quot;argmax&quot;</span><span class="p">,</span> <span class="s2">&quot;argmin&quot;</span><span class="p">,</span> <span class="s2">&quot;argpartition&quot;</span><span class="p">,</span> <span class="s2">&quot;argsort&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;nonzero&quot;</span><span class="p">,</span> <span class="s2">&quot;searchsorted&quot;</span><span class="p">,</span> <span class="s2">&quot;round&quot;</span><span class="p">]</span>
<span class="n">_diff_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;clip&quot;</span><span class="p">,</span> <span class="s2">&quot;compress&quot;</span><span class="p">,</span> <span class="s2">&quot;conj&quot;</span><span class="p">,</span> <span class="s2">&quot;conjugate&quot;</span><span class="p">,</span> <span class="s2">&quot;cumprod&quot;</span><span class="p">,</span> <span class="s2">&quot;cumsum&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;diagonal&quot;</span><span class="p">,</span> <span class="s2">&quot;dot&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;prod&quot;</span><span class="p">,</span> <span class="s2">&quot;ptp&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;ravel&quot;</span><span class="p">,</span> <span class="s2">&quot;repeat&quot;</span><span class="p">,</span> <span class="s2">&quot;sort&quot;</span><span class="p">,</span> <span class="s2">&quot;squeeze&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;swapaxes&quot;</span><span class="p">,</span> <span class="s2">&quot;take&quot;</span><span class="p">,</span> <span class="s2">&quot;tile&quot;</span><span class="p">,</span> <span class="s2">&quot;trace&quot;</span><span class="p">,</span> <span class="s2">&quot;transpose&quot;</span><span class="p">,</span> <span class="s2">&quot;var&quot;</span><span class="p">]</span>


<span class="c1"># Set up operator, method, and property forwarding on Tracer instances containing</span>
<span class="c1"># ShapedArray avals by following the forwarding conventions for Tracer.</span>
<span class="c1"># Forward operators using a single-underscore-prefix naming convention:</span>
<span class="k">for</span> <span class="n">operator_name</span><span class="p">,</span> <span class="n">function</span> <span class="ow">in</span> <span class="n">_operators</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
  <span class="nb">setattr</span><span class="p">(</span><span class="n">ShapedArray</span><span class="p">,</span> <span class="s2">&quot;_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">operator_name</span><span class="p">),</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">function</span><span class="p">))</span>
<span class="c1"># Forward methods and properties using core.aval_method and core.aval_property:</span>
<span class="k">for</span> <span class="n">method_name</span> <span class="ow">in</span> <span class="n">_nondiff_methods</span> <span class="o">+</span> <span class="n">_diff_methods</span><span class="p">:</span>
  <span class="nb">setattr</span><span class="p">(</span><span class="n">ShapedArray</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">aval_method</span><span class="p">(</span><span class="nb">globals</span><span class="p">()[</span><span class="n">method_name</span><span class="p">]))</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">ShapedArray</span><span class="p">,</span> <span class="s2">&quot;reshape&quot;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">aval_method</span><span class="p">(</span><span class="n">_reshape_method</span><span class="p">))</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">ShapedArray</span><span class="p">,</span> <span class="s2">&quot;flatten&quot;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">aval_method</span><span class="p">(</span><span class="n">ravel</span><span class="p">))</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">ShapedArray</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">aval_property</span><span class="p">(</span><span class="n">transpose</span><span class="p">))</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">ShapedArray</span><span class="p">,</span> <span class="s2">&quot;real&quot;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">aval_property</span><span class="p">(</span><span class="n">real</span><span class="p">))</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">ShapedArray</span><span class="p">,</span> <span class="s2">&quot;imag&quot;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">aval_property</span><span class="p">(</span><span class="n">imag</span><span class="p">))</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">ShapedArray</span><span class="p">,</span> <span class="s2">&quot;astype&quot;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">aval_method</span><span class="p">(</span><span class="n">_astype</span><span class="p">))</span>


<span class="c1"># Forward operators, methods, and properties on DeviceArray to lax_numpy</span>
<span class="c1"># functions (with no Tracers involved; this forwarding is direct)</span>
<span class="k">for</span> <span class="n">operator_name</span><span class="p">,</span> <span class="n">function</span> <span class="ow">in</span> <span class="n">_operators</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
  <span class="nb">setattr</span><span class="p">(</span><span class="n">DeviceArray</span><span class="p">,</span> <span class="s2">&quot;__</span><span class="si">{}</span><span class="s2">__&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">operator_name</span><span class="p">),</span> <span class="n">function</span><span class="p">)</span>
<span class="k">for</span> <span class="n">method_name</span> <span class="ow">in</span> <span class="n">_nondiff_methods</span> <span class="o">+</span> <span class="n">_diff_methods</span><span class="p">:</span>
  <span class="nb">setattr</span><span class="p">(</span><span class="n">DeviceArray</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">method_name</span><span class="p">])</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">DeviceArray</span><span class="p">,</span> <span class="s2">&quot;reshape&quot;</span><span class="p">,</span> <span class="n">_reshape_method</span><span class="p">)</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">DeviceArray</span><span class="p">,</span> <span class="s2">&quot;flatten&quot;</span><span class="p">,</span> <span class="n">ravel</span><span class="p">)</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">DeviceArray</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="nb">property</span><span class="p">(</span><span class="n">transpose</span><span class="p">))</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">DeviceArray</span><span class="p">,</span> <span class="s2">&quot;real&quot;</span><span class="p">,</span> <span class="nb">property</span><span class="p">(</span><span class="n">real</span><span class="p">))</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">DeviceArray</span><span class="p">,</span> <span class="s2">&quot;imag&quot;</span><span class="p">,</span> <span class="nb">property</span><span class="p">(</span><span class="n">imag</span><span class="p">))</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">DeviceArray</span><span class="p">,</span> <span class="s2">&quot;astype&quot;</span><span class="p">,</span> <span class="n">_astype</span><span class="p">)</span>


<span class="c1"># Extra methods that are handy</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">ShapedArray</span><span class="p">,</span> <span class="s2">&quot;broadcast&quot;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">aval_method</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">broadcast</span><span class="p">))</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">ShapedArray</span><span class="p">,</span> <span class="s2">&quot;broadcast_in_dim&quot;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">aval_method</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">broadcast_in_dim</span><span class="p">))</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">ShapedArray</span><span class="p">,</span> <span class="s2">&quot;split&quot;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">aval_method</span><span class="p">(</span><span class="n">split</span><span class="p">))</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">DeviceArray</span><span class="p">,</span> <span class="s2">&quot;broadcast&quot;</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">broadcast</span><span class="p">)</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">DeviceArray</span><span class="p">,</span> <span class="s2">&quot;broadcast_in_dim&quot;</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">broadcast_in_dim</span><span class="p">)</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">DeviceArray</span><span class="p">,</span> <span class="s2">&quot;split&quot;</span><span class="p">,</span> <span class="n">split</span><span class="p">)</span>

<span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">_unstack</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument to _unstack must be non-scalar&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">index_in_dim</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
<span class="nb">setattr</span><span class="p">(</span><span class="n">DeviceArray</span><span class="p">,</span> <span class="s2">&quot;_unstack&quot;</span><span class="p">,</span> <span class="n">_unstack</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Randall Balestriero

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>