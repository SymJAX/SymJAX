

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>jax.scipy.special &mdash; symjax 0.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/symjax_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user/examples.html">Examples</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">symjax</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>jax.scipy.special</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for jax.scipy.special</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2018 Google LLC</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     https://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.special</span> <span class="k">as</span> <span class="nn">osp_special</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">lax</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">api</span>
<span class="kn">from</span> <span class="nn">..numpy</span> <span class="kn">import</span> <span class="n">lax_numpy</span> <span class="k">as</span> <span class="n">jnp</span>
<span class="kn">from</span> <span class="nn">..numpy.lax_numpy</span> <span class="kn">import</span> <span class="p">(</span><span class="n">_wraps</span><span class="p">,</span> <span class="n">asarray</span><span class="p">,</span> <span class="n">_reduction_dims</span><span class="p">,</span> <span class="n">_constant_like</span><span class="p">,</span>
                               <span class="n">_promote_args_inexact</span><span class="p">)</span>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">gammaln</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">gammaln</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;gammaln&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">betaln</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">betaln</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;betaln&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">lax</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">lax</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">betainc</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">betainc</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;betainc&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">betainc</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">digamma</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">digamma</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;digamma&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">digamma</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">gammainc</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">gammainc</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">a</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;gammainc&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">igamma</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">gammaincc</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">gammaincc</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">a</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;gammaincc&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">igammac</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">erf</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">erf</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;erf&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">erfc</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">erfc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;erfc&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">erfc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">erfinv</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">erfinv</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;erfinv&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">erf_inv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<div class="viewcode-block" id="logit"><a class="viewcode-back" href="../../../modules/random.html#symjax.tensor.random.logit">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">custom_jvp</span>
<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">logit</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logit</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">)))</span></div>
<span class="n">logit</span><span class="o">.</span><span class="n">defjvps</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">g</span><span class="p">,</span> <span class="n">ans</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">))))</span>


<span class="nd">@api</span><span class="o">.</span><span class="n">custom_jvp</span>
<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">expit</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">expit</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">one</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">neg</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
<span class="n">expit</span><span class="o">.</span><span class="n">defjvps</span><span class="p">(</span><span class="k">lambda</span> <span class="n">g</span><span class="p">,</span> <span class="n">ans</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">g</span> <span class="o">*</span> <span class="n">ans</span> <span class="o">*</span> <span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">_const</span><span class="p">(</span><span class="n">ans</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">ans</span><span class="p">))</span>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">logsumexp</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logsumexp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_sign</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">return_sign</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only implemented for b=None, return_sign=False&quot;</span><span class="p">)</span>
  <span class="n">dims</span> <span class="o">=</span> <span class="n">_reduction_dims</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
  <span class="n">shape</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">subvals</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)))</span>
  <span class="n">dimadd</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">lax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
  <span class="n">amax</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
  <span class="n">amax</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">is_finite</span><span class="p">(</span><span class="n">amax</span><span class="p">),</span> <span class="n">amax</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">amax</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
  <span class="n">amax_singletons</span> <span class="o">=</span> <span class="n">dimadd</span><span class="p">(</span><span class="n">amax</span><span class="p">)</span>
  <span class="n">out</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">amax_singletons</span><span class="p">)),</span>
                                   <span class="n">_constant_like</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">dims</span><span class="p">)),</span> <span class="n">amax</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">dimadd</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="k">if</span> <span class="n">keepdims</span> <span class="k">else</span> <span class="n">out</span>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">xlogy</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">xlogy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;xlogy&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
  <span class="n">x_ok</span> <span class="o">=</span> <span class="n">x</span> <span class="o">!=</span> <span class="mf">0.</span>
  <span class="n">safe_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x_ok</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
  <span class="n">safe_y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x_ok</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x_ok</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">safe_x</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">safe_y</span><span class="p">)),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">xlog1py</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">xlog1py</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;xlog1py&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
  <span class="n">x_ok</span> <span class="o">=</span> <span class="n">x</span> <span class="o">!=</span> <span class="mf">0.</span>
  <span class="n">safe_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x_ok</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
  <span class="n">safe_y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x_ok</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x_ok</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">safe_x</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">safe_y</span><span class="p">)),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">entr</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">entr</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;entr&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                    <span class="n">lax</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
                    <span class="n">lax</span><span class="o">.</span><span class="n">neg</span><span class="p">(</span><span class="n">xlogy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">multigammaln</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">multigammaln</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
  <span class="n">a</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;multigammaln&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
  <span class="n">constant</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">_constant_like</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span> <span class="n">d</span><span class="p">),</span>
                             <span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">))),</span>
                     <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_constant_like</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)))</span>
  <span class="n">res</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gammaln</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
                        <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">))),</span>
               <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">res</span> <span class="o">+</span> <span class="n">constant</span>


<span class="c1"># Normal distributions</span>

<span class="c1"># Functions &quot;ndtr&quot; and &quot;ndtri&quot; are derived from calculations made in:</span>
<span class="c1"># https://root.cern.ch/doc/v608/SpecFuncCephesInv_8cxx_source.html</span>
<span class="c1"># In the following email exchange, the author gives his consent to redistribute</span>
<span class="c1"># derived works under an Apache 2.0 license.</span>
<span class="c1">#</span>
<span class="c1"># From: Stephen Moshier &lt;steve@moshier.net&gt;</span>
<span class="c1"># Date: Sat, Jun 9, 2018 at 2:36 PM</span>
<span class="c1"># Subject: Re: Licensing cephes under Apache (BSD-like) license.</span>
<span class="c1"># To: rif &lt;rif@google.com&gt;</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># Hello Rif,</span>
<span class="c1">#</span>
<span class="c1"># Yes, Google may distribute Cephes files under the Apache 2 license.</span>
<span class="c1">#</span>
<span class="c1"># If clarification is needed, I do not favor BSD over other free licenses.</span>
<span class="c1"># I would agree that Apache 2 seems to cover the concern you mentioned</span>
<span class="c1"># about sublicensees.</span>
<span class="c1">#</span>
<span class="c1"># Best wishes for good luck with your projects!</span>
<span class="c1"># Steve Moshier</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># On Thu, 31 May 2018, rif wrote:</span>
<span class="c1">#</span>
<span class="c1"># &gt; Hello Steve.</span>
<span class="c1"># &gt; My name is Rif. I work on machine learning software at Google.</span>
<span class="c1"># &gt;</span>
<span class="c1"># &gt; Your cephes software continues to be incredibly useful and widely used. I</span>
<span class="c1"># &gt; was wondering whether it would be permissible for us to use the Cephes code</span>
<span class="c1"># &gt; under the Apache 2.0 license, which is extremely similar in permissions to</span>
<span class="c1"># &gt; the BSD license (Wikipedia comparisons). This would be quite helpful to us</span>
<span class="c1"># &gt; in terms of avoiding multiple licenses on software.</span>
<span class="c1"># &gt;</span>
<span class="c1"># &gt; I&#39;m sorry to bother you with this (I can imagine you&#39;re sick of hearing</span>
<span class="c1"># &gt; about this by now), but I want to be absolutely clear we&#39;re on the level and</span>
<span class="c1"># &gt; not misusing your important software. In former conversation with Eugene</span>
<span class="c1"># &gt; Brevdo (ebrevdo@google.com), you wrote &quot;If your licensing is similar to BSD,</span>
<span class="c1"># &gt; the formal way that has been handled is simply to add a statement to the</span>
<span class="c1"># &gt; effect that you are incorporating the Cephes software by permission of the</span>
<span class="c1"># &gt; author.&quot; I wanted to confirm that (a) we could use the Apache license, (b)</span>
<span class="c1"># &gt; that we don&#39;t need to (and probably you don&#39;t want to) keep getting</span>
<span class="c1"># &gt; contacted about individual uses, because your intent is generally to allow</span>
<span class="c1"># &gt; this software to be reused under &quot;BSD-like&quot; license, and (c) you&#39;re OK</span>
<span class="c1"># &gt; letting incorporators decide whether a license is sufficiently BSD-like?</span>
<span class="c1"># &gt;</span>
<span class="c1"># &gt; Best,</span>
<span class="c1"># &gt;</span>
<span class="c1"># &gt; rif</span>
<span class="c1"># &gt;</span>
<span class="c1"># &gt;</span>
<span class="c1"># &gt;</span>

<span class="c1"># log_ndtr uses different functions over the ranges</span>
<span class="c1"># (-infty, lower](lower, upper](upper, infty)</span>
<span class="c1"># Lower bound values were chosen by examining where the support of ndtr</span>
<span class="c1"># appears to be zero, relative to scipy&#39;s (which is always 64bit). They were</span>
<span class="c1"># then made more conservative just to be safe. (Conservative means use the</span>
<span class="c1"># expansion more than we probably need to.)</span>
<span class="n">_LOGNDTR_FLOAT64_LOWER</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">_LOGNDTR_FLOAT32_LOWER</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># Upper bound values were chosen by examining for which values of &#39;x&#39;</span>
<span class="c1"># Log[cdf(x)] is 0, after which point we need to use the approximation</span>
<span class="c1"># Log[cdf(x)] = Log[1 - cdf(-x)] approx -cdf(-x). We chose a value slightly</span>
<span class="c1"># conservative, meaning we use the approximation earlier than needed.</span>
<span class="n">_LOGNDTR_FLOAT64_UPPER</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">_LOGNDTR_FLOAT32_UPPER</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">ndtr</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Normal distribution function.</span>

<span class="sd">  Returns the area under the Gaussian probability density function, integrated</span>
<span class="sd">  from minus infinity to x:</span>

<span class="sd">  .. math::</span>
<span class="sd">    \begin{align}</span>
<span class="sd">    \mathrm{ndtr}(x) =&amp;</span>
<span class="sd">      \ \frac{1}{\sqrt{2 \pi}}\int_{-\infty}^{x} e^{-\frac{1}{2}t^2} dt \\</span>
<span class="sd">    =&amp;\ \frac{1}{2} (1 + \mathrm{erf}(\frac{x}{\sqrt{2}})) \\</span>
<span class="sd">    =&amp;\ \frac{1}{2} \mathrm{erfc}(\frac{x}{\sqrt{2}})</span>
<span class="sd">    \end{align}</span>

<span class="sd">  Args:</span>
<span class="sd">    x: An array of type `float32`, `float64`.</span>

<span class="sd">  Returns:</span>
<span class="sd">    An array with `dtype=x.dtype`.</span>

<span class="sd">  Raises:</span>
<span class="sd">    TypeError: if `x` is not floating-type.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
        <span class="s2">&quot;x.dtype=</span><span class="si">{}</span><span class="s2"> is not supported, see docstring for supported types.&quot;</span>
        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">_ndtr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_ndtr</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Implements ndtr core logic.&quot;&quot;&quot;</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
  <span class="n">half_sqrt_2</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
  <span class="n">w</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">half_sqrt_2</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">half_sqrt_2</span><span class="p">),</span>
                      <span class="n">dtype</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">+</span> <span class="n">lax</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">w</span><span class="p">),</span>
                      <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">0.</span><span class="p">)),</span>
                                      <span class="n">dtype</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span> <span class="o">-</span> <span class="n">lax</span><span class="o">.</span><span class="n">erfc</span><span class="p">(</span><span class="n">z</span><span class="p">),</span>
                                      <span class="n">lax</span><span class="o">.</span><span class="n">erfc</span><span class="p">(</span><span class="n">z</span><span class="p">)))</span>
  <span class="k">return</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span>


<span class="k">def</span> <span class="nf">ndtri</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
  <span class="sa">r</span><span class="sd">&quot;&quot;&quot;The inverse of the CDF of the Normal distribution function.</span>

<span class="sd">  Returns `x` such that the area under the PDF from :math:`-\infty` to `x` is equal</span>
<span class="sd">  to `p`.</span>

<span class="sd">  A piece-wise rational approximation is done for the function.</span>
<span class="sd">  This is a based on the implementation in netlib.</span>

<span class="sd">  Args:</span>
<span class="sd">    p: an array of type `float32`, `float64`.</span>

<span class="sd">  Returns:</span>
<span class="sd">    an array with `dtype=p.dtype`.</span>

<span class="sd">  Raises:</span>
<span class="sd">    TypeError: if `p` is not floating-type.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
        <span class="s2">&quot;x.dtype=</span><span class="si">{}</span><span class="s2"> is not supported, see docstring for supported types.&quot;</span>
        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">_ndtri</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_ndtri</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Implements ndtri core logic.&quot;&quot;&quot;</span>

  <span class="c1"># Constants used in piece-wise rational approximations. Taken from the cephes</span>
  <span class="c1"># library:</span>
  <span class="c1"># https://root.cern.ch/doc/v608/SpecFuncCephesInv_8cxx_source.html</span>
  <span class="n">p0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">([</span><span class="o">-</span><span class="mf">5.99633501014107895267E1</span><span class="p">,</span>
                      <span class="mf">9.80010754185999661536E1</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">5.66762857469070293439E1</span><span class="p">,</span>
                      <span class="mf">1.39312609387279679503E1</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">1.23916583867381258016E0</span><span class="p">]))</span>
  <span class="n">q0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span>
                      <span class="mf">1.95448858338141759834E0</span><span class="p">,</span>
                      <span class="mf">4.67627912898881538453E0</span><span class="p">,</span>
                      <span class="mf">8.63602421390890590575E1</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">2.25462687854119370527E2</span><span class="p">,</span>
                      <span class="mf">2.00260212380060660359E2</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">8.20372256168333339912E1</span><span class="p">,</span>
                      <span class="mf">1.59056225126211695515E1</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">1.18331621121330003142E0</span><span class="p">]))</span>
  <span class="n">p1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">([</span><span class="mf">4.05544892305962419923E0</span><span class="p">,</span>
                      <span class="mf">3.15251094599893866154E1</span><span class="p">,</span>
                      <span class="mf">5.71628192246421288162E1</span><span class="p">,</span>
                      <span class="mf">4.40805073893200834700E1</span><span class="p">,</span>
                      <span class="mf">1.46849561928858024014E1</span><span class="p">,</span>
                      <span class="mf">2.18663306850790267539E0</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">1.40256079171354495875E-1</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">3.50424626827848203418E-2</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">8.57456785154685413611E-4</span><span class="p">]))</span>
  <span class="n">q1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span>
                      <span class="mf">1.57799883256466749731E1</span><span class="p">,</span>
                      <span class="mf">4.53907635128879210584E1</span><span class="p">,</span>
                      <span class="mf">4.13172038254672030440E1</span><span class="p">,</span>
                      <span class="mf">1.50425385692907503408E1</span><span class="p">,</span>
                      <span class="mf">2.50464946208309415979E0</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">1.42182922854787788574E-1</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">3.80806407691578277194E-2</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">9.33259480895457427372E-4</span><span class="p">]))</span>
  <span class="n">p2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">([</span><span class="mf">3.23774891776946035970E0</span><span class="p">,</span>
                      <span class="mf">6.91522889068984211695E0</span><span class="p">,</span>
                      <span class="mf">3.93881025292474443415E0</span><span class="p">,</span>
                      <span class="mf">1.33303460815807542389E0</span><span class="p">,</span>
                      <span class="mf">2.01485389549179081538E-1</span><span class="p">,</span>
                      <span class="mf">1.23716634817820021358E-2</span><span class="p">,</span>
                      <span class="mf">3.01581553508235416007E-4</span><span class="p">,</span>
                      <span class="mf">2.65806974686737550832E-6</span><span class="p">,</span>
                      <span class="mf">6.23974539184983293730E-9</span><span class="p">]))</span>
  <span class="n">q2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span>
                      <span class="mf">6.02427039364742014255E0</span><span class="p">,</span>
                      <span class="mf">3.67983563856160859403E0</span><span class="p">,</span>
                      <span class="mf">1.37702099489081330271E0</span><span class="p">,</span>
                      <span class="mf">2.16236993594496635890E-1</span><span class="p">,</span>
                      <span class="mf">1.34204006088543189037E-2</span><span class="p">,</span>
                      <span class="mf">3.28014464682127739104E-4</span><span class="p">,</span>
                      <span class="mf">2.89247864745380683936E-6</span><span class="p">,</span>
                      <span class="mf">6.79019408009981274425E-9</span><span class="p">]))</span>

  <span class="n">dtype</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
  <span class="n">shape</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_create_polynomial</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute n_th order polynomial via Horner&#39;s method.&quot;&quot;&quot;</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">_create_polynomial</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">*</span> <span class="n">var</span>


  <span class="n">maybe_complement_p</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">dtype</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">expm1</span><span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="p">)),</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
  <span class="c1"># Write in an arbitrary value in place of 0 for p since 0 will cause NaNs</span>
  <span class="c1"># later on. The result from the computation when p == 0 is not used so any</span>
  <span class="c1"># number that doesn&#39;t result in NaNs is fine.</span>
  <span class="n">sanitized_mcp</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
      <span class="n">maybe_complement_p</span> <span class="o">&lt;=</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">0.</span><span class="p">),</span>
      <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)),</span>
      <span class="n">maybe_complement_p</span><span class="p">)</span>

  <span class="c1"># Compute x for p &gt; exp(-2): x/sqrt(2pi) = w + w**3 P0(w**2)/Q0(w**2).</span>
  <span class="n">w</span> <span class="o">=</span> <span class="n">sanitized_mcp</span> <span class="o">-</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
  <span class="n">ww</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
  <span class="n">x_for_big_p</span> <span class="o">=</span> <span class="n">w</span> <span class="o">+</span> <span class="n">w</span> <span class="o">*</span> <span class="n">ww</span> <span class="o">*</span> <span class="p">(</span><span class="n">_create_polynomial</span><span class="p">(</span><span class="n">ww</span><span class="p">,</span> <span class="n">p0</span><span class="p">)</span>
                              <span class="o">/</span> <span class="n">_create_polynomial</span><span class="p">(</span><span class="n">ww</span><span class="p">,</span> <span class="n">q0</span><span class="p">))</span>
  <span class="n">x_for_big_p</span> <span class="o">*=</span> <span class="o">-</span><span class="n">dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

  <span class="c1"># Compute x for p &lt;= exp(-2): x = z - log(z)/z - (1/z) P(1/z) / Q(1/z),</span>
  <span class="c1"># where z = sqrt(-2. * log(p)), and P/Q are chosen between two different</span>
  <span class="c1"># arrays based on whether p &lt; exp(-32).</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sanitized_mcp</span><span class="p">))</span>
  <span class="n">first_term</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span>
  <span class="n">second_term_small_p</span> <span class="o">=</span> <span class="p">(</span>
      <span class="n">_create_polynomial</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span> <span class="o">/</span>
      <span class="n">_create_polynomial</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span><span class="p">,</span> <span class="n">q2</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span><span class="p">)</span>
  <span class="n">second_term_otherwise</span> <span class="o">=</span> <span class="p">(</span>
      <span class="n">_create_polynomial</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span> <span class="o">/</span>
      <span class="n">_create_polynomial</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span><span class="p">,</span> <span class="n">q1</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span><span class="p">)</span>
  <span class="n">x_for_small_p</span> <span class="o">=</span> <span class="n">first_term</span> <span class="o">-</span> <span class="n">second_term_small_p</span>
  <span class="n">x_otherwise</span> <span class="o">=</span> <span class="n">first_term</span> <span class="o">-</span> <span class="n">second_term_otherwise</span>

  <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sanitized_mcp</span> <span class="o">&gt;</span> <span class="n">dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="p">)),</span>
                <span class="n">x_for_big_p</span><span class="p">,</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">8.0</span><span class="p">),</span> <span class="n">x_for_small_p</span><span class="p">,</span> <span class="n">x_otherwise</span><span class="p">))</span>

  <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="p">)),</span> <span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">x</span><span class="p">)</span>
  <span class="n">infinity</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
  <span class="n">x_nan_replaced</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
      <span class="n">p</span> <span class="o">&lt;=</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="o">-</span><span class="n">infinity</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">infinity</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">x_nan_replaced</span>


<span class="nd">@partial</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">custom_jvp</span><span class="p">,</span> <span class="n">nondiff_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
<span class="k">def</span> <span class="nf">log_ndtr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">series_order</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
  <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log Normal distribution function.</span>

<span class="sd">  For details of the Normal distribution function see `ndtr`.</span>

<span class="sd">  This function calculates :math:`\log(\mathrm{ndtr}(x))` by either calling</span>
<span class="sd">  :math:`\log(\mathrm{ndtr}(x))` or using an asymptotic series. Specifically:</span>

<span class="sd">  - For `x &gt; upper_segment`, use the approximation `-ndtr(-x)` based on</span>
<span class="sd">    :math:`\log(1-x) \approx -x, x \ll 1`.</span>
<span class="sd">  - For `lower_segment &lt; x &lt;= upper_segment`, use the existing `ndtr` technique</span>
<span class="sd">    and take a log.</span>
<span class="sd">  - For `x &lt;= lower_segment`, we use the series approximation of `erf` to compute</span>
<span class="sd">    the log CDF directly.</span>

<span class="sd">  The `lower_segment` is set based on the precision of the input:</span>

<span class="sd">  .. math::</span>
<span class="sd">    \begin{align}</span>
<span class="sd">    \mathit{lower\_segment} =&amp;</span>
<span class="sd">      \ \begin{cases}</span>
<span class="sd">        -20 &amp;  x.\mathrm{dtype}=\mathit{float64} \\</span>
<span class="sd">        -10 &amp;  x.\mathrm{dtype}=\mathit{float32} \\</span>
<span class="sd">        \end{cases} \\</span>
<span class="sd">    \mathit{upper\_segment} =&amp;</span>
<span class="sd">      \ \begin{cases}</span>
<span class="sd">        8&amp;  x.\mathrm{dtype}=\mathit{float64} \\</span>
<span class="sd">        5&amp;  x.\mathrm{dtype}=\mathit{float32} \\</span>
<span class="sd">        \end{cases}</span>
<span class="sd">    \end{align}</span>


<span class="sd">  When `x &lt; lower_segment`, the `ndtr` asymptotic series approximation is:</span>

<span class="sd">  .. math::</span>
<span class="sd">    \begin{align}</span>
<span class="sd">     \mathrm{ndtr}(x) =&amp;\  \mathit{scale} * (1 + \mathit{sum}) + R_N \\</span>
<span class="sd">     \mathit{scale}   =&amp;\  \frac{e^{-0.5 x^2}}{-x \sqrt{2 \pi}} \\</span>
<span class="sd">     \mathit{sum}     =&amp;\  \sum_{n=1}^N {-1}^n (2n-1)!! / (x^2)^n \\</span>
<span class="sd">     R_N     =&amp;\  O(e^{-0.5 x^2} (2N+1)!! / |x|^{2N+3})</span>
<span class="sd">    \end{align}</span>

<span class="sd">  where :math:`(2n-1)!! = (2n-1) (2n-3) (2n-5) ...  (3) (1)` is a</span>
<span class="sd">  `double-factorial</span>
<span class="sd">  &lt;https://en.wikipedia.org/wiki/Double_factorial&gt;`_ operator.</span>


<span class="sd">  Args:</span>
<span class="sd">    x: an array of type `float32`, `float64`.</span>
<span class="sd">    series_order: Positive Python integer. Maximum depth to</span>
<span class="sd">      evaluate the asymptotic expansion. This is the `N` above.</span>

<span class="sd">  Returns:</span>
<span class="sd">    an array with `dtype=x.dtype`.</span>

<span class="sd">  Raises:</span>
<span class="sd">    TypeError: if `x.dtype` is not handled.</span>
<span class="sd">    TypeError: if `series_order` is a not Python `integer.`</span>
<span class="sd">    ValueError:  if `series_order` is not in `[0, 30]`.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">series_order</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;series_order must be a Python integer.&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">series_order</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;series_order must be non-negative.&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">series_order</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;series_order must be &lt;= 30.&quot;</span><span class="p">)</span>

  <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
    <span class="n">lower_segment</span> <span class="o">=</span> <span class="n">_LOGNDTR_FLOAT64_LOWER</span>
    <span class="n">upper_segment</span> <span class="o">=</span> <span class="n">_LOGNDTR_FLOAT64_UPPER</span>
  <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
    <span class="n">lower_segment</span> <span class="o">=</span> <span class="n">_LOGNDTR_FLOAT32_LOWER</span>
    <span class="n">upper_segment</span> <span class="o">=</span> <span class="n">_LOGNDTR_FLOAT32_UPPER</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;x.dtype=</span><span class="si">{}</span><span class="s2"> is not supported.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)))</span>

  <span class="c1"># The basic idea here was ported from:</span>
  <span class="c1">#   https://root.cern.ch/doc/v608/SpecFuncCephesInv_8cxx_source.html</span>
  <span class="c1"># We copy the main idea, with a few changes</span>
  <span class="c1"># * For x &gt;&gt; 1, and X ~ Normal(0, 1),</span>
  <span class="c1">#     Log[P[X &lt; x]] = Log[1 - P[X &lt; -x]] approx -P[X &lt; -x],</span>
  <span class="c1">#     which extends the range of validity of this function.</span>
  <span class="c1"># * We use one fixed series_order for all of &#39;x&#39;, rather than adaptive.</span>
  <span class="c1"># * Our docstring properly reflects that this is an asymptotic series, not a</span>
  <span class="c1">#   Taylor series. We also provided a correct bound on the remainder.</span>
  <span class="c1"># * We need to use the max/min in the _log_ndtr_lower arg to avoid nan when</span>
  <span class="c1">#   x=0. This happens even though the branch is unchosen because when x=0</span>
  <span class="c1">#   the gradient of a select involves the calculation 1*dy+0*(-inf)=nan</span>
  <span class="c1">#   regardless of whether dy is finite. Note that the minimum is a NOP if</span>
  <span class="c1">#   the branch is chosen.</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
      <span class="n">lax</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">upper_segment</span><span class="p">),</span>
      <span class="o">-</span><span class="n">_ndtr</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">),</span>  <span class="c1"># log(1-x) ~= -x, x &lt;&lt; 1</span>
      <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lower_segment</span><span class="p">),</span>
                       <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_ndtr</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lower_segment</span><span class="p">))),</span>
                       <span class="n">_log_ndtr_lower</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lower_segment</span><span class="p">),</span>
                                       <span class="n">series_order</span><span class="p">)))</span>
<span class="k">def</span> <span class="nf">_log_ndtr_jvp</span><span class="p">(</span><span class="n">series_order</span><span class="p">,</span> <span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span><span class="p">):</span>
  <span class="p">(</span><span class="n">x</span><span class="p">,),</span> <span class="p">(</span><span class="n">t</span><span class="p">,)</span> <span class="o">=</span> <span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span>
  <span class="n">ans</span> <span class="o">=</span> <span class="n">log_ndtr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">series_order</span><span class="o">=</span><span class="n">series_order</span><span class="p">)</span>
  <span class="n">t_out</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_norm_logpdf</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">ans</span><span class="p">)))</span>
  <span class="k">return</span> <span class="n">ans</span><span class="p">,</span> <span class="n">t_out</span>
<span class="n">log_ndtr</span><span class="o">.</span><span class="n">defjvp</span><span class="p">(</span><span class="n">_log_ndtr_jvp</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_log_ndtr_lower</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">series_order</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Asymptotic expansion version of `Log[cdf(x)]`, appropriate for `x&lt;&lt;-1`.&quot;&quot;&quot;</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
  <span class="n">x_2</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="c1"># Log of the term multiplying (1 + sum)</span>
  <span class="n">log_scale</span> <span class="o">=</span> <span class="o">-</span><span class="n">dtype</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">x_2</span> <span class="o">-</span> <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">log_scale</span> <span class="o">+</span> <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_log_ndtr_asymptotic_series</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">series_order</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_log_ndtr_asymptotic_series</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">series_order</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Calculates the asymptotic series used in log_ndtr.&quot;&quot;&quot;</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
  <span class="k">if</span> <span class="n">series_order</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
  <span class="n">x_2</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">even_sum</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">odd_sum</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">x_2n</span> <span class="o">=</span> <span class="n">x_2</span>  <span class="c1"># Start with x^{2*1} = x^{2*n} with n = 1.</span>
  <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">series_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_double_factorial</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_2n</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">odd_sum</span> <span class="o">+=</span> <span class="n">y</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">even_sum</span> <span class="o">+=</span> <span class="n">y</span>
    <span class="n">x_2n</span> <span class="o">*=</span> <span class="n">x_2</span>
  <span class="k">return</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">+</span> <span class="n">even_sum</span> <span class="o">-</span> <span class="n">odd_sum</span>


<span class="k">def</span> <span class="nf">_double_factorial</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;The double factorial function for small Python integer `n`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">))</span>


<span class="n">_norm_logpdf_constant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_norm_logpdf</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">neg_half</span> <span class="o">=</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
  <span class="n">log_normalizer</span> <span class="o">=</span> <span class="n">_constant_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">_norm_logpdf_constant</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">neg_half</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">log_normalizer</span><span class="p">)</span>

<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">i0e</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">i0e</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">bessel_i0e</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">i1e</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">i1e</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">bessel_i1e</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Randall Balestriero

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>